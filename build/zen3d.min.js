// github.com/shawn0326/zen-3d
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).zen3d={})}(this,function(e){"use strict";for(var i=[],t=0;t<256;t++)i[t]=(t<16?"0":"")+t.toString(16);function r(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(i[255&e]+i[e>>8&255]+i[e>>16&255]+i[e>>24&255]+"-"+i[255&t]+i[t>>8&255]+"-"+i[t>>16&15|64]+i[t>>24&255]+"-"+i[63&r|128]+i[r>>8&255]+"-"+i[r>>16&255]+i[r>>24&255]+i[255&n]+i[n>>8&255]+i[n>>16&255]+i[n>>24&255]).toUpperCase()}function o(e){return 0==(e&e-1)&&0!==e}function n(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))}function h(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function a(e){var t={};for(var r in e){var n=e[r];Array.isArray(n)?t[r]=n.slice():t[r]=n}return t}var G={MESH:"mesh",SKINNED_MESH:"skinned_mesh",LIGHT:"light",CAMERA:"camera",SCENE:"scene",GROUP:"group",CANVAS2D:"canvas2d"},m={AMBIENT:"ambient",DIRECT:"direct",POINT:"point",SPOT:"spot"},g={BASIC:"basic",LAMBERT:"lambert",PHONG:"phong",PBR:"pbr",PBR2:"pbr2",MATCAP:"matcap",POINT:"point",LINE:"line",CANVAS2D:"canvas2d",SHADER:"shader",DEPTH:"depth",DISTANCE:"distance"},M={NORMAL:"normal",EXP2:"exp2"},c={NONE:"none",NORMAL:"normal",ADD:"add",CUSTOM:"custom"},s={ADD:32774,SUBTRACT:32778,REVERSE_SUBTRACT:32779},u={ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775},l={NONE:"none",FRONT:"front",BACK:"back",FRONT_AND_BACK:"front_and_back"},E={FRONT:"front",BACK:"back",DOUBLE:"double"},S={SMOOTH_SHADING:"smooth_shading",FLAT_SHADING:"flat_shading"},d={TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879},x={DEPTH_COMPONENT:6402,DEPTH_STENCIL:34041,ALPHA:6406,RED:6403,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,R8:33321,RGBA8:32856,RGBA16F:34842,RGBA32F:34836,DEPTH_COMPONENT16:33189,DEPTH_COMPONENT24:33190,DEPTH_COMPONENT32F:36012,DEPTH24_STENCIL8:35056,DEPTH32F_STENCIL8:36013},y={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,HALF_FLOAT:36193,UNSIGNED_INT_24_8:34042,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FLOAT_32_UNSIGNED_INT_24_8_REV:36269},_={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987},v={REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648},p={LEQUAL:515,GEQUAL:518,LESS:513,GREATER:516,EQUAL:514,NOTEQUAL:517,ALWAYS:519,NEVER:512},f={KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056},w={FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_2D_SHADOW:35682,SAMPLER_CUBE:35680,SAMPLER_CUBE_SHADOW:36293,SAMPLER_3D:35679,BYTE:65535,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126},T={FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,FLOAT:5126,BYTE:65535,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},b={HARD:"hard",POISSON_SOFT:"poisson_soft",PCF3_SOFT:"pcf3_soft",PCF5_SOFT:"pcf5_soft",PCSS16_SOFT:"pcss16_soft",PCSS32_SOFT:"pcss32_soft",PCSS64_SOFT:"pcss64_soft"},A={LINEAR:"linear",SRGB:"sRGB",RGBE:"RGBE",RGBM7:"RGBM7",RGBM16:"RGBM16",RGBD:"RGBD",GAMMA:"Gamma"},P={MULTIPLY:"ENVMAP_BLENDING_MULTIPLY",MIX:"ENVMAP_BLENDING_MIX",ADD:"ENVMAP_BLENDING_ADD"},N={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},C={NONE:0,RGB:1,RGBA:2},L={COLOR_ATTACHMENT0:36064,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:577040,COLOR_ATTACHMENT11:577041,COLOR_ATTACHMENT12:577042,COLOR_ATTACHMENT13:577043,COLOR_ATTACHMENT14:577044,COLOR_ATTACHMENT15:577045,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306};function R(){this.eventMap={}}Object.assign(R.prototype,{addEventListener:function(e,t,r){(this.eventMap[e]||(this.eventMap[e]=[])).push({listener:t,thisObject:r||this})},removeEventListener:function(e,t,r){var n=this.eventMap[e];if(n)for(var i=0,a=n.length;i<a;i++){var s=n[i];if(s.listener==t&&s.thisObject==(r||this)){n.splice(i,1);break}}},dispatchEvent:function(e){(e.target=this).notifyListener(e)},notifyListener:function(e){var t=this.eventMap[e.type];if(t)for(var r=0,n=t.length;r<n;r++){var i=t[r];i.listener.call(i.thisObject,e)}}});var O=new D;function D(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}Object.assign(D.prototype,{lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},set:function(e,t,r){return this.x=e||0,this.y=t||0,this.z=r||0,this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},getLength:function(){return Math.sqrt(this.getLengthSquared())},getLengthSquared:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(e){e=e||1;var t=this.getLength();if(0!=t){var r=e/t;return this.x*=r,this.y*=r,this.z*=r,this}},subtract:function(e,t){return(t=t||new D).set(this.x-e.x,this.y-e.y,this.z-e.z),t},multiply:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},crossVectors:function(e,t){var r=e.x,n=e.y,i=e.z,a=t.x,s=t.y,o=t.z;return this.x=n*o-i*s,this.y=i*a-r*o,this.z=r*s-n*a,this},cross:function(e){var t=this.x,r=this.y,n=this.z;return this.x=r*e.z-n*e.y,this.y=n*e.x-t*e.z,this.z=t*e.y-r*e.x,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},applyQuaternion:function(e){var t=this.x,r=this.y,n=this.z,i=e._x,a=e._y,s=e._z,o=e._w,h=o*t+a*n-s*r,c=o*r+s*t-i*n,u=o*n+i*r-a*t,l=-i*t-a*r-s*n;return this.x=h*o+l*-i+c*-s-u*-a,this.y=c*o+l*-a+u*-i-h*-s,this.z=u*o+l*-s+h*-a-c*-i,this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements,a=1/(i[3]*t+i[7]*r+i[11]*n+i[15]);return this.x=(i[0]*t+i[4]*r+i[8]*n+i[12])*a,this.y=(i[1]*t+i[5]*r+i[9]*n+i[13])*a,this.z=(i[2]*t+i[6]*r+i[10]*n+i[14])*a,this},applyMatrix3:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[3]*r+i[6]*n,this.y=i[1]*t+i[4]*r+i[7]*n,this.z=i[2]*t+i[5]*r+i[8]*n,this},transformDirection:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[4]*r+i[8]*n,this.y=i[1]*t+i[5]*r+i[9]*n,this.z=i[2]*t+i[6]*r+i[10]*n,this.normalize()},setFromMatrixPosition:function(e){return this.setFromMatrixColumn(e,3)},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return t*t+r*r+n*n},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},project:function(e){return this.applyMatrix4(e.viewMatrix).applyMatrix4(e.projectionMatrix)},unproject:function(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.worldMatrix)},reflect:function(e){return this.sub(O.copy(e).multiplyScalar(2*this.dot(e)))},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},clone:function(){return new D(this.x,this.y,this.z)},applyProjection:function(e){console.error("zen3d.Vector3: .applyProjection has been removed. Use .applyMatrix4 instead.")}});var F=new D,U=new D,I=new D,B=new D,z=new D;function k(e,t){this.origin=void 0!==e?e:new D,this.direction=void 0!==t?t:new D}function H(e,t,r,n){this.ray=new k(e,t),this.near=r||0,this.far=n||1/0}function V(e,t){return e.distance-t.distance}function j(e,t,r,n){if(e.raycast(t,r),!0===n)for(var i=e.children,a=0,s=i.length;a<s;a++)j(i[a],t,r,!0)}Object.assign(k.prototype,{set:function(e,t){this.origin.copy(e),this.direction.copy(t)},at:function(e,t){return(t||new D).copy(this.direction).multiplyScalar(e).add(this.origin)},intersectsSphere:function(e,t){F.subVectors(e.center,this.origin);var r=F.dot(this.direction),n=F.dot(F)-r*r,i=e.radius*e.radius;if(i<n)return null;var a=Math.sqrt(i-n),s=r-a,o=r+a;return s<0&&o<0?null:s<0?this.at(o,t):this.at(s,t)},intersectsBox:function(e,t){var r,n,i,a,s=1/this.direction.x,o=1/this.direction.y,h=1/this.direction.z,c=this.origin,u=0<=s?(r=(e.min.x-c.x)*s,(e.max.x-c.x)*s):(r=(e.max.x-c.x)*s,(e.min.x-c.x)*s),l=0<=o?(n=(e.min.y-c.y)*o,(e.max.y-c.y)*o):(n=(e.max.y-c.y)*o,(e.min.y-c.y)*o);return l<r||u<n?null:((r<n||r!=r)&&(r=n),(l<u||u!=u)&&(u=l),(a=0<=h?(i=(e.min.z-c.z)*h,(e.max.z-c.z)*h):(i=(e.max.z-c.z)*h,(e.min.z-c.z)*h))<r||u<i?null:((r<i||r!=r)&&(r=i),(a<u||u!=u)&&(u=a),u<0?null:this.at(0<=r?r:u,t)))},intersectTriangle:function(e,t,r,n,i){I.subVectors(t,e),B.subVectors(r,e),z.crossVectors(I,B);var a,s=this.direction.dot(z);if(0<s){if(n)return null;a=1}else{if(!(s<0))return null;a=-1,s=-s}U.subVectors(this.origin,e);var o=a*this.direction.dot(B.crossVectors(U,B));if(o<0)return null;var h=a*this.direction.dot(I.cross(U));if(h<0)return null;if(s<o+h)return null;var c=-a*U.dot(z);return c<0?null:this.at(c/s,i)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this}}),Object.assign(H.prototype,{set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t,r){"orthographic"==(r=r||"perspective")?(this.ray.origin.set(e.x,e.y,t.projectionMatrix.elements[14]).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.worldMatrix)):(this.ray.origin.setFromMatrixPosition(t.worldMatrix),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize())},intersectObject:function(e,t){var r=[];return j(e,this,r,t),r.sort(V),r},intersectObjects:function(e,t){var r=[];if(!1===Array.isArray(e))return console.warn("Raycaster.intersectObjects: objects is not an Array."),r;for(var n=0,i=e.length;n<i;n++)j(e[n],this,r,t);return r.sort(V),r}});var W=new D,X=new K,Y=new D,q=new D,Z=new D;function K(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}Object.assign(K.prototype,{identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},set:function(e,t,r,n,i,a,s,o,h,c,u,l,d,p,f,_){var m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=n,m[1]=i,m[5]=a,m[9]=s,m[13]=o,m[2]=h,m[6]=c,m[10]=u,m[14]=l,m[3]=d,m[7]=p,m[11]=f,m[15]=_,this},copy:function(e){return this.elements.set(e.elements),this},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,n=t.elements,i=this.elements,a=r[0],s=r[4],o=r[8],h=r[12],c=r[1],u=r[5],l=r[9],d=r[13],p=r[2],f=r[6],_=r[10],m=r[14],v=r[3],g=r[7],M=r[11],E=r[15],S=n[0],x=n[4],y=n[8],w=n[12],T=n[1],b=n[5],A=n[9],P=n[13],N=n[2],C=n[6],L=n[10],R=n[14],O=n[3],F=n[7],U=n[11],D=n[15];return i[0]=a*S+s*T+o*N+h*O,i[4]=a*x+s*b+o*C+h*F,i[8]=a*y+s*A+o*L+h*U,i[12]=a*w+s*P+o*R+h*D,i[1]=c*S+u*T+l*N+d*O,i[5]=c*x+u*b+l*C+d*F,i[9]=c*y+u*A+l*L+d*U,i[13]=c*w+u*P+l*R+d*D,i[2]=p*S+f*T+_*N+m*O,i[6]=p*x+f*b+_*C+m*F,i[10]=p*y+f*A+_*L+m*U,i[14]=p*w+f*P+_*R+m*D,i[3]=v*S+g*T+M*N+E*O,i[7]=v*x+g*b+M*C+E*F,i[11]=v*y+g*A+M*L+E*U,i[15]=v*w+g*P+M*R+E*D,this},transpose:function(){var e=this.elements,t=e[1];return e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},inverse:function(){return this.getInverse(this)},getInverse:function(e){var t=this.elements,r=e.elements,n=r[0],i=r[1],a=r[2],s=r[3],o=r[4],h=r[5],c=r[6],u=r[7],l=r[8],d=r[9],p=r[10],f=r[11],_=r[12],m=r[13],v=r[14],g=r[15],M=d*v*u-m*p*u+m*c*f-h*v*f-d*c*g+h*p*g,E=_*p*u-l*v*u-_*c*f+o*v*f+l*c*g-o*p*g,S=l*m*u-_*d*u+_*h*f-o*m*f-l*h*g+o*d*g,x=_*d*c-l*m*c-_*h*p+o*m*p+l*h*v-o*d*v,y=n*M+i*E+a*S+s*x;if(0==y)return console.warn("can't invert matrix, determinant is 0"),this.identity();var w=1/y;return t[0]=M*w,t[1]=(m*p*s-d*v*s-m*a*f+i*v*f+d*a*g-i*p*g)*w,t[2]=(h*v*s-m*c*s+m*a*u-i*v*u-h*a*g+i*c*g)*w,t[3]=(d*c*s-h*p*s-d*a*u+i*p*u+h*a*f-i*c*f)*w,t[4]=E*w,t[5]=(l*v*s-_*p*s+_*a*f-n*v*f-l*a*g+n*p*g)*w,t[6]=(_*c*s-o*v*s-_*a*u+n*v*u+o*a*g-n*c*g)*w,t[7]=(o*p*s-l*c*s+l*a*u-n*p*u-o*a*f+n*c*f)*w,t[8]=S*w,t[9]=(_*d*s-l*m*s-_*i*f+n*m*f+l*i*g-n*d*g)*w,t[10]=(o*m*s-_*h*s+_*i*u-n*m*u-o*i*g+n*h*g)*w,t[11]=(l*h*s-o*d*s-l*i*u+n*d*u+o*i*f-n*h*f)*w,t[12]=x*w,t[13]=(l*m*a-_*d*a+_*i*p-n*m*p-l*i*v+n*d*v)*w,t[14]=(_*h*a-o*m*a-_*i*c+n*m*c+o*i*v-n*h*v)*w,t[15]=(o*d*a-l*h*a+l*i*c-n*d*c-o*i*p+n*h*p)*w,this},transform:function(e,t,r){var n=r.toMatrix4(X).elements,i=this.elements;return i[0]=n[0]*t.x,i[1]=n[1]*t.x,i[2]=n[2]*t.x,i[3]=0,i[4]=n[4]*t.y,i[5]=n[5]*t.y,i[6]=n[6]*t.y,i[7]=0,i[8]=n[8]*t.z,i[9]=n[9]*t.z,i[10]=n[10]*t.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,r=e.x,n=e.y,i=e.z,a=e.w,s=r+r,o=n+n,h=i+i,c=r*s,u=r*o,l=r*h,d=n*o,p=n*h,f=i*h,_=a*s,m=a*o,v=a*h;return t[0]=1-(d+f),t[4]=u-v,t[8]=l+m,t[1]=u+v,t[5]=1-(c+f),t[9]=p-_,t[2]=l-m,t[6]=p+_,t[10]=1-(c+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},extractRotation:function(e){var t=this.elements,r=e.elements,n=1/W.setFromMatrixColumn(e,0).getLength(),i=1/W.setFromMatrixColumn(e,1).getLength(),a=1/W.setFromMatrixColumn(e,2).getLength();return t[0]=r[0]*n,t[1]=r[1]*n,t[2]=r[2]*n,t[3]=0,t[4]=r[4]*i,t[5]=r[5]*i,t[6]=r[6]*i,t[7]=0,t[8]=r[8]*a,t[9]=r[9]*a,t[10]=r[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAtRH:function(e,t,r){var n=this.elements;return Z.subVectors(e,t),0===Z.getLengthSquared()&&(Z.z=1),Z.normalize(),Y.crossVectors(r,Z),0===Y.getLengthSquared()&&(1===Math.abs(r.z)?Z.x+=1e-4:Z.z+=1e-4,Z.normalize(),Y.crossVectors(r,Z)),Y.normalize(),q.crossVectors(Z,Y),n[0]=Y.x,n[4]=q.x,n[8]=Z.x,n[1]=Y.y,n[5]=q.y,n[9]=Z.y,n[2]=Y.z,n[6]=q.z,n[10]=Z.z,this},decompose:function(e,t,r){var n=this.elements,i=W.set(n[0],n[1],n[2]).getLength(),a=W.set(n[4],n[5],n[6]).getLength(),s=W.set(n[8],n[9],n[10]).getLength();this.determinant()<0&&(i=-i),e.x=n[12],e.y=n[13],e.z=n[14],X.copy(this);var o=1/i,h=1/a,c=1/s;return X.elements[0]*=o,X.elements[1]*=o,X.elements[2]*=o,X.elements[4]*=h,X.elements[5]*=h,X.elements[6]*=h,X.elements[8]*=c,X.elements[9]*=c,X.elements[10]*=c,t.setFromRotationMatrix(X),r.x=i,r.y=a,r.z=s,this},determinant:function(){var e=this.elements,t=e[0],r=e[4],n=e[8],i=e[12],a=e[1],s=e[5],o=e[9],h=e[13],c=e[2],u=e[6],l=e[10],d=e[14];return e[3]*(i*o*u-n*h*u-i*s*l+r*h*l+n*s*d-r*o*d)+e[7]*(t*o*d-t*h*l+i*a*l-n*a*d+n*h*c-i*o*c)+e[11]*(t*h*u-t*s*d-i*a*u+r*a*d+i*s*c-r*h*c)+e[15]*(-n*s*c-t*o*u+t*s*l+n*a*u-r*a*l+r*o*c)},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}});var Q=new K;function $(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._order=n||$.DefaultOrder}function J(e,t){this.x=e||0,this.y=t||0}function ee(e,t,r,n){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==n?n:1}function te(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}function re(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==n?n:1}function ne(e,t){this.min=void 0!==e?e:new J(1/0,1/0),this.max=void 0!==t?t:new J(-1/0,-1/0)}$.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],$.DefaultOrder="XYZ",Object.defineProperties($.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign($.prototype,{copyFrom:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},set:function(e,t,r,n){return this._x=e||0,this._y=t||0,this._z=r||0,this._order=n||this._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,r){function n(e,t,r){return Math.max(t,Math.min(r,e))}var i=e.elements,a=i[0],s=i[4],o=i[8],h=i[1],c=i[5],u=i[9],l=i[2],d=i[6],p=i[10];return"XYZ"===(t=t||this._order)?(this._y=Math.asin(n(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(-u,p),this._z=Math.atan2(-s,a)):(this._x=Math.atan2(d,c),this._z=0)):"YXZ"===t?(this._x=Math.asin(-n(u,-1,1)),Math.abs(u)<.99999?(this._y=Math.atan2(o,p),this._z=Math.atan2(h,c)):(this._y=Math.atan2(-l,a),this._z=0)):"ZXY"===t?(this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-l,p),this._z=Math.atan2(-s,c)):(this._y=0,this._z=Math.atan2(h,a))):"ZYX"===t?(this._y=Math.asin(-n(l,-1,1)),Math.abs(l)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(h,a)):(this._x=0,this._z=Math.atan2(-s,c))):"YZX"===t?(this._z=Math.asin(n(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(-u,c),this._y=Math.atan2(-l,a)):(this._x=0,this._y=Math.atan2(o,p))):"XZY"===t?(this._z=Math.asin(-n(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,a)):(this._x=Math.atan2(-u,p),this._y=0)):console.warn("given unsupported order: "+t),this._order=t,!1!==r&&this.onChangeCallback(),this},setFromQuaternion:function(e,t,r){return e.toMatrix4(Q),this.setFromRotationMatrix(Q,t,r)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(J.prototype,{set:function(e,t){return this.x=e||0,this.y=t||0,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},getLength:function(){return Math.sqrt(this.getLengthSquared())},getLengthSquared:function(){return this.x*this.x+this.y*this.y},normalize:function(e){e=e||1;var t=this.getLength();if(0!=t){var r=e/t;return this.x*=r,this.y*=r,this}},subtract:function(e,t){return(t=t||new J).set(this.x-e.x,this.y-e.y),t},sub:function(e){return this.x-=e.x,this.y-=e.y,this},copy:function(e){return this.x=e.x,this.y=e.y,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},add:function(e){return this.x+=e.x,this.y+=e.y,this},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},clone:function(){return new J(this.x,this.y)}}),Object.assign(ee.prototype,{lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},set:function(e,t,r,n){return this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==n?n:1,this},normalize:function(){return this.multiplyScalar(1/(this.getLength()||1))},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},getLengthSquared:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,i=this.w,a=e.elements;return this.x=a[0]*t+a[4]*r+a[8]*n+a[12]*i,this.y=a[1]*t+a[5]*r+a[9]*n+a[13]*i,this.z=a[2]*t+a[6]*r+a[10]*n+a[14]*i,this.w=a[3]*t+a[7]*r+a[11]*n+a[15]*i,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}}),Object.assign(te.prototype,{identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},inverse:function(){return this.getInverse(this)},getInverse:function(e){var t=e.elements,r=this.elements,n=t[0],i=t[1],a=t[2],s=t[3],o=t[4],h=t[5],c=t[6],u=t[7],l=t[8],d=l*o-h*u,p=h*c-l*s,f=u*s-o*c,_=n*d+i*p+a*f;if(0==_){return console.warn("zen3d.Matrix3: .getInverse() can't invert matrix, determinant is 0"),this.identity()}var m=1/_;return r[0]=d*m,r[1]=(a*u-l*i)*m,r[2]=(h*i-a*o)*m,r[3]=p*m,r[4]=(l*n-a*c)*m,r[5]=(a*s-h*n)*m,r[6]=f*m,r[7]=(i*c-u*n)*m,r[8]=(o*n-i*s)*m,this},transpose:function(){var e=this.elements,t=e[1];return e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},set:function(e,t,r,n,i,a,s,o,h){var c=this.elements;return c[0]=e,c[3]=t,c[6]=r,c[1]=n,c[4]=i,c[7]=a,c[2]=s,c[5]=o,c[8]=h,this},copy:function(e){return this.elements.set(e.elements),this},multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,n=t.elements,i=this.elements,a=r[0],s=r[3],o=r[6],h=r[1],c=r[4],u=r[7],l=r[2],d=r[5],p=r[8],f=n[0],_=n[3],m=n[6],v=n[1],g=n[4],M=n[7],E=n[2],S=n[5],x=n[8];return i[0]=a*f+s*v+o*E,i[3]=a*_+s*g+o*S,i[6]=a*m+s*M+o*x,i[1]=h*f+c*v+u*E,i[4]=h*_+c*g+u*S,i[7]=h*m+c*M+u*x,i[2]=l*f+d*v+p*E,i[5]=l*_+d*g+p*S,i[8]=l*m+d*M+p*x,this},transform:function(e,t,r,n,i,a,s){var o,h=this.elements,c=1,u=0;return i%360&&(o=i,c=Math.cos(o),u=Math.sin(o)),h[0]=c*r,h[3]=-u*n,h[6]=e,h[1]=u*r,h[4]=c*n,h[7]=t,h[2]=0,h[5]=0,h[8]=1,(a||s)&&(h[6]-=a*h[0]+s*h[3],h[7]-=a*h[1]+s*h[4]),this},setUvTransform:function(e,t,r,n,i,a,s){var o=Math.cos(i),h=Math.sin(i);this.set(r*o,r*h,-r*(o*a+h*s)+a+e,-n*h,n*o,-n*(-h*a+o*s)+s+t,0,0,1)},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}}),Object.defineProperties(re.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(re.prototype,{normalize:function(e){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},lerpQuaternions:function(e,t,r){var n=e._w,i=e._x,a=e._y,s=e._z,o=t._w,h=t._x,c=t._y,u=t._z;n*o+i*h+a*c+s*u<0&&(o=-o,h=-h,c=-c,u=-u),this._w=n+r*(o-n),this._x=i+r*(h-i),this._y=a+r*(c-a),this._z=s+r*(u-s);var l=1/Math.sqrt(this._w*this._w+this._x*this._x+this._y*this._y+this._z*this._z);return this._w*=l,this._x*=l,this._y*=l,this._z*=l,this.onChangeCallback(),this},slerpQuaternions:function(e,t,r){var n,i,a,s,o,h=e._w,c=e._x,u=e._y,l=e._z,d=t._w,p=t._x,f=t._y,_=t._z,m=h*d+c*p+u*f+l*_;return m<0&&(m=-m,d=-d,p=-p,f=-f,_=-_),m<.95?(n=Math.acos(m),i=1/Math.sin(n),a=Math.sin(n*(1-r))*i,s=Math.sin(n*r)*i,this._w=h*a+d*s,this._x=c*a+p*s,this._y=u*a+f*s,this._z=l*a+_*s):(this._w=h+r*(d-h),this._x=c+r*(p-c),this._y=u+r*(f-u),this._z=l+r*(_-l),o=1/Math.sqrt(this._w*this._w+this._x*this._x+this._y*this._y+this._z*this._z),this._w*=o,this._x*=o,this._y*=o,this._z*=o),this.onChangeCallback(),this},set:function(e,t,r,n){return this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==n?n:1,this.onChangeCallback(),this},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=void 0!==e.w?e.w:1,this.onChangeCallback(),this},setFromEuler:function(e,t){var r=Math.cos(e._x/2),n=Math.cos(e._y/2),i=Math.cos(e._z/2),a=Math.sin(e._x/2),s=Math.sin(e._y/2),o=Math.sin(e._z/2),h=e._order;return"XYZ"===h?(this._x=a*n*i+r*s*o,this._y=r*s*i-a*n*o,this._z=r*n*o+a*s*i,this._w=r*n*i-a*s*o):"YXZ"===h?(this._x=a*n*i+r*s*o,this._y=r*s*i-a*n*o,this._z=r*n*o-a*s*i,this._w=r*n*i+a*s*o):"ZXY"===h?(this._x=a*n*i-r*s*o,this._y=r*s*i+a*n*o,this._z=r*n*o+a*s*i,this._w=r*n*i-a*s*o):"ZYX"===h?(this._x=a*n*i-r*s*o,this._y=r*s*i+a*n*o,this._z=r*n*o-a*s*i,this._w=r*n*i+a*s*o):"YZX"===h?(this._x=a*n*i+r*s*o,this._y=r*s*i+a*n*o,this._z=r*n*o-a*s*i,this._w=r*n*i-a*s*o):"XZY"===h&&(this._x=a*n*i-r*s*o,this._y=r*s*i-a*n*o,this._z=r*n*o+a*s*i,this._w=r*n*i+a*s*o),!1!==t&&this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,r=e.elements,n=r[0],i=r[4],a=r[8],s=r[1],o=r[5],h=r[9],c=r[2],u=r[6],l=r[10],d=n+o+l;return 0<d?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(u-h)*t,this._y=(a-c)*t,this._z=(s-i)*t):o<n&&l<n?(t=2*Math.sqrt(1+n-o-l),this._w=(u-h)/t,this._x=.25*t,this._y=(i+s)/t,this._z=(a+c)/t):l<o?(t=2*Math.sqrt(1+o-n-l),this._w=(a-c)/t,this._x=(i+s)/t,this._y=.25*t,this._z=(h+u)/t):(t=2*Math.sqrt(1+l-n-o),this._w=(s-i)/t,this._x=(a+c)/t,this._y=(h+u)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(e,t){var r=e.dot(t)+1;return r<1e-6?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0):(this._x=0,this._y=-e.z,this._z=e.y)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x),this._w=r,this.normalize()},multiply:function(e){return this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var r=e._x,n=e._y,i=e._z,a=e._w,s=t._x,o=t._y,h=t._z,c=t._w;return this._x=r*c+a*s+n*h-i*o,this._y=n*c+a*o+i*s-r*h,this._z=i*c+a*h+r*o-n*s,this._w=a*c-r*s-n*o-i*h,this.onChangeCallback(),this},toMatrix4:function(e){var t=(e=e||new K).elements,r=2*this._x*this._y,n=2*this._x*this._z,i=2*this._x*this._w,a=2*this._y*this._z,s=2*this._y*this._w,o=2*this._z*this._w,h=this._x*this._x,c=this._y*this._y,u=this._z*this._z,l=this._w*this._w;return t[0]=h-c-u+l,t[4]=r-o,t[8]=n+s,t[12]=0,t[1]=r+o,t[5]=c-h-u+l,t[9]=a-i,t[13]=0,t[2]=n-s,t[6]=a+i,t[10]=-h-c+u+l,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,e},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},setFromAxisAngle:function(e,t){var r=t/2,n=Math.sin(r);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(r),this.onChangeCallback(),this},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(re,{slerpFlat:function(e,t,r,n,i,a,s){var o,h,c,u,l,d,p,f,_=r[n+0],m=r[n+1],v=r[n+2],g=r[n+3],M=i[a+0],E=i[a+1],S=i[a+2],x=i[a+3];g===x&&_===M&&m===E&&v===S||(d=1-s,h=0<=(o=_*M+m*E+v*S+g*x)?1:-1,(c=1-o*o)>Number.EPSILON&&(u=Math.sqrt(c),l=Math.atan2(u,o*h),d=Math.sin(d*l)/u,s=Math.sin(s*l)/u),_=_*d+M*(p=s*h),m=m*d+E*p,v=v*d+S*p,g=g*d+x*p,d===1-s&&(_*=f=1/Math.sqrt(_*_+m*m+v*v+g*g),m*=f,v*=f,g*=f)),e[t]=_,e[t+1]=m,e[t+2]=v,e[t+3]=g}}),Object.assign(ne.prototype,{set:function(e,t,r,n){this.min.set(e,t),this.max.set(r,n)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this}});var ie=[new D,new D,new D,new D,new D,new D,new D,new D];function ae(e,t){this.min=void 0!==e?e:new D(1/0,1/0,1/0),this.max=void 0!==t?t:new D(-1/0,-1/0,-1/0)}Object.assign(ae.prototype,{set:function(e,t){this.min.copy(e),this.max.copy(t)},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByBox3:function(e){return this.min.min(e.min),this.max.max(e.max),this},setFromArray:function(e,t){for(var r=1/0,n=1/0,i=1/0,a=-1/0,s=-1/0,o=-1/0,h=void 0!==t?t:3,c=0,u=e.length;c<u;c+=h){var l=e[c],d=e[c+1],p=e[c+2];l<r&&(r=l),d<n&&(n=d),p<i&&(i=p),a<l&&(a=l),s<d&&(s=d),o<p&&(o=p)}return this.min.set(r,n,i),this.max.set(a,s,o),this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},getCenter:function(e){var t=e||new D;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},applyMatrix4:function(e){return this.isEmpty()||(ie[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),ie[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),ie[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),ie[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),ie[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),ie[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),ie[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),ie[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(ie)),this},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this}});var se=new ae,oe=new D;function he(e,t){this.center=void 0!==e?e:new D,this.radius=void 0!==t?t:0}Object.assign(he.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromArray:function(e,t){var r=void 0!==t?t:3,n=this.center;se.setFromArray(e,r).getCenter(n);for(var i=0,a=0,s=e.length;a<s;a+=r)oe.fromArray(e,a),i=Math.max(i,n.distanceToSquared(oe));return this.radius=Math.sqrt(i),this},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},getBoundingBox:function(e){var t=e||new ae;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},clone:function(){return(new he).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this}});var ce=new D,ue=new te;function le(e,t){this.normal=void 0!==e?e:new D(1,0,0),this.constant=void 0!==t?t:0}Object.assign(le.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,n){return this.normal.set(e,t,r),this.constant=n,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},normalize:function(){var e=1/this.normal.getLength();return this.normal.multiplyScalar(e),this.constant*=e,this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},coplanarPoint:function(e){return(e||new D).copy(this.normal).multiplyScalar(-this.constant)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},applyMatrix4:function(e,t){var r=t||ue.setFromMatrix4(e).inverse().transpose(),n=this.coplanarPoint(ce).applyMatrix4(e),i=this.normal.applyMatrix3(r).normalize();return this.constant=-n.dot(i),this}});var de=new D;function pe(e,t,r,n,i,a){this.planes=[void 0!==e?e:new le,void 0!==t?t:new le,void 0!==r?r:new le,void 0!==n?n:new le,void 0!==i?i:new le,void 0!==a?a:new le]}function fe(e,t,r){return this.r=0,this.g=0,void(this.b=0)===t&&void 0===r?this.setHex(e):this.setRGB(e,t,r)}function _e(e,t,r){return r<0&&(r+=1),1<r&&--r,r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+6*(t-e)*(2/3-r):e}Object.assign(pe.prototype,{set:function(e,t,r,n,i,a){var s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(r),s[3].copy(n),s[4].copy(i),s[5].copy(a),this},setFromMatrix:function(e){var t=this.planes,r=e.elements,n=r[0],i=r[1],a=r[2],s=r[3],o=r[4],h=r[5],c=r[6],u=r[7],l=r[8],d=r[9],p=r[10],f=r[11],_=r[12],m=r[13],v=r[14],g=r[15];return t[0].setComponents(s-n,u-o,f-l,g-_).normalize(),t[1].setComponents(s+n,u+o,f+l,g+_).normalize(),t[2].setComponents(s+i,u+h,f+d,g+m).normalize(),t[3].setComponents(s-i,u-h,f-d,g-m).normalize(),t[4].setComponents(s-a,u-c,f-p,g-v).normalize(),t[5].setComponents(s+a,u+c,f+p,g+v).normalize(),this},intersectsSphere:function(e){for(var t=this.planes,r=e.center,n=-e.radius,i=0;i<6;i++){if(t[i].distanceToPoint(r)<n)return!1}return!0},intersectsBox:function(e){for(var t=this.planes,r=0;r<6;r++){var n=t[r];if(de.x=0<n.normal.x?e.max.x:e.min.x,de.y=0<n.normal.y?e.max.y:e.min.y,de.z=0<n.normal.z?e.max.z:e.min.z,n.distanceToPoint(de)<0)return!1}return!0},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,r=0;r<6;r++)t[r].copy(e.planes[r]);return this}}),Object.assign(fe.prototype,{lerpColors:function(e,t,r){this.r=r*(t.r-e.r)+e.r,this.g=r*(t.g-e.g)+e.g,this.b=r*(t.b-e.b)+e.b},lerp:function(e,t){this.lerpColors(this,e,t)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSL:function(e,t,r){var n,i,a;return e=(e%(n=1)+n)%n,t=Math.max(0,Math.min(1,t)),r=Math.max(0,Math.min(1,r)),0===t?this.r=this.g=this.b=r:(a=2*r-(i=r<=.5?r*(1+t):r+t-r*t),this.r=_e(a,i,e+1/3),this.g=_e(a,i,e),this.b=_e(a,i,e-1/3)),this},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}});var me=new D,ve=new D,ge=new D,Me=new D;function Ee(e,t,r){this.a=void 0!==e?e:new D,this.b=void 0!==t?t:new D,this.c=void 0!==r?r:new D}Object.assign(Ee.prototype,{set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this}}),Ee.normal=function(e,t,r,n){var i=n||new D;i.subVectors(r,t),me.subVectors(e,t),i.cross(me);var a=i.getLengthSquared();return 0<a?i.multiplyScalar(1/Math.sqrt(a)):i.set(0,0,0)},Ee.barycoordFromPoint=function(e,t,r,n,i){me.subVectors(n,t),ve.subVectors(r,t),ge.subVectors(e,t);var a=me.dot(me),s=me.dot(ve),o=me.dot(ge),h=ve.dot(ve),c=ve.dot(ge),u=a*h-s*s,l=i||new D;if(0==u)return l.set(-2,-1,-1);var d=1/u,p=(h*o-s*c)*d,f=(a*c-s*o)*d;return l.set(1-p-f,f,p)},Ee.containsPoint=function(e,t,r,n){return Ee.barycoordFromPoint(e,t,r,n,Me),0<=Me.x&&0<=Me.y&&Me.x+Me.y<=1};var Se=new J,xe=new J,ye=new J,we=new J;function Te(e,t){this.posPoints=void 0,this.ctrlPoints=void 0,this.segCount=0,this.set(e,t)}function be(e,t,r){this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==r?r:0}function Ae(){R.call(this),this.uuid=r(),this.textureType="",this.mipmaps=[],this.border=0,this.format=x.RGBA,this.internalformat=null,this.type=y.UNSIGNED_BYTE,this.magFilter=_.LINEAR,this.minFilter=_.LINEAR_MIPMAP_LINEAR,this.wrapS=v.CLAMP_TO_EDGE,this.wrapT=v.CLAMP_TO_EDGE,this.anisotropy=1,this.compare=void 0,this.generateMipmaps=!0,this.encoding=A.LINEAR,this.flipY=!0,this.version=0}function Pe(e,t,r){var n=this,i=!1,a=0,s=0,o=void 0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){s++,!1===i&&void 0!==n.onStart&&n.onStart(e,a,s),i=!0},this.itemEnd=function(e){a++,void 0!==n.onProgress&&n.onProgress(e,a,s),a===s&&(i=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return o?o(e):e},this.setURLModifier=function(e){return o=e,this}}Object.assign(Te.prototype,{set:function(e,t){this.posPoints=e,this.ctrlPoints=t,e.length!==t.length&&console.warn("Curve: posPoints and ctrlPoints's length not equal!"),this.segCount=e.length-1},calc:function(e){Se.copy(this.posPoints[this.posPoints.length-1]),xe.copy(this.ctrlPoints[this.ctrlPoints.length-1]),ye.copy(Se),we.copy(xe);for(var t=0;t<this.segCount;t++)if(e>=this.posPoints[t].x&&e<=this.posPoints[t+1].x){Se.copy(this.posPoints[t]),ye.copy(this.posPoints[t+1]),xe.copy(this.ctrlPoints[t]),we.copy(this.ctrlPoints[t+1]);break}return e=(e-Se.x)/(ye.x-Se.x),this._cubic_bezier(Se.y,xe.y,we.y,ye.y,e)},averageXSampler:function(e){e<2&&console.warn("Curve: sampler num less than 2!");for(var t=[],r=this.posPoints[0].x,n=this.posPoints[this.posPoints.length-1].x,i=(n-r)/(e-1),a=0,s=0;s<e;s++)a=s===e-1?n:r+s*i,t.push(a,this.calc(a));return t},_cubic_bezier:function(e,t,r,n,i){return e=this._mix(e,t,i),t=this._mix(t,r,i),r=this._mix(r,n,i),e=this._mix(e,t,i),t=this._mix(t,r,i),e=this._mix(e,t,i)},_mix:function(e,t,r){return e*(1-r)+t*r}}),Object.assign(be.prototype,{set:function(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},clone:function(){return(new this.constructor).copy(this)},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.getLength(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(Math.min(1,Math.max(-1,e.y/this.radius)))),this}}),Ae.prototype=Object.assign(Object.create(R.prototype),{constructor:Ae,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.textureType=e.textureType,this.border=e.border,this.format=e.format,this.type=e.type,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.anisotropy=e.anisotropy,this.generateMipmaps=e.generateMipmaps,this.encoding=e.encoding,this.flipY=e.flipY,this.version=e.version,this},dispose:function(){this.dispatchEvent({type:"dispose"}),this.version=0}});var Ne=new Pe;function Ce(e){this.crossOrigin=void 0,this.path=void 0,this.manager=void 0!==e?e:Ne}function Le(e){this.path=void 0,this.responseType=void 0,this.withCredentials=void 0,this.mimeType=void 0,this.requestHeader=void 0,this.manager=void 0!==e?e:Ne}function Re(e){this.manager=void 0!==e?e:Ne}function Oe(e){this.manager=void 0!==e?e:Ne,this.type=y.UNSIGNED_BYTE}function Fe(){Ae.call(this),this.textureType=d.TEXTURE_2D,this.image=null,this.offset=new J,this.repeat=new J(1,1),this.center=new J,this.rotation=0,this.matrix=new te,this.matrixAutoUpdate=!0,this.useUVTransform=!0}function Ue(){Ae.call(this),this.textureType=d.TEXTURE_CUBE_MAP,this.images=[],this.flipY=!1}function De(){Ae.call(this),this.textureType=d.TEXTURE_3D,this.image={data:new Uint8Array([255,255,255,255,255,255,255,255]),width:2,height:2,depth:2},this.format=x.RED,this.internalformat=x.R8,this.type=y.UNSIGNED_BYTE,this.flipY=!1}Object.assign(Ce.prototype,{load:function(t,e,r,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var i=this,a=document.createElementNS("http://www.w3.org/1999/xhtml","img");function s(){a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),e&&e(this),i.manager.itemEnd(t)}function o(e){a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),n&&n(e),i.manager.itemError(t),i.manager.itemEnd(t)}return a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),i.manager.itemStart(t),a.src=t,a},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Le.prototype,{load:function(r,n,t,i){void 0===r&&(r=""),null!=this.path&&(r=this.path+r),r=this.manager.resolveURL(r);var e,a=this,s=r.match(/^data:(.*?)(;base64)?,(.*)$/);if(s){var o=s[1],h=!!s[2],c=s[3],c=decodeURIComponent(c);h&&(c=atob(c));try{var u=(this.responseType||"").toLowerCase();switch(u){case"arraybuffer":case"blob":p=new ArrayBuffer(c.length);for(var l=new Uint8Array(p),d=0;d<c.length;d++)l[d]=c.charCodeAt(d);"blob"===u&&(p=new Blob([p],{type:o}));break;case"document":var p=(new DOMParser).parseFromString(c,o);break;case"json":p=JSON.parse(c);break;default:p=c}setTimeout(function(){n&&n(p),a.manager.itemEnd(r)},0)}catch(e){setTimeout(function(){i&&i(e),a.manager.itemError(r),a.manager.itemEnd(r)},0)}}else{for(var f in(e=new XMLHttpRequest).open("GET",r,!0),e.addEventListener("load",function(e){var t=this.response;200===this.status?n&&n(t):0===this.status?(console.warn("zen3d.FileLoader: HTTP Status 0 received."),n&&n(t)):(i&&i(e),a.manager.itemError(r)),a.manager.itemEnd(r)},!1),void 0!==t&&e.addEventListener("progress",function(e){t(e)},!1),void 0!==i&&e.addEventListener("error",function(e){i(e),a.manager.itemError(r),a.manager.itemEnd(r)},!1),void 0!==this.responseType&&(e.responseType=this.responseType),void 0!==this.withCredentials&&(e.withCredentials=this.withCredentials),e.overrideMimeType&&e.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)e.setRequestHeader(f,this.requestHeader[f]);e.send(null)}return a.manager.itemStart(r),e},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(Re.prototype,{load:function(e,t,r,n){var i=this,a=new Le(this.manager);a.setResponseType("arraybuffer"),a.load(e,function(e){void 0!==t&&t(i.parse(e))},r,n)},parse:function(e){e.length<19&&console.error("TGALoader.parse: Not enough data to contain header.");var t=new Uint8Array(e),r=0,_={id_length:t[r++],colormap_type:t[r++],image_type:t[r++],colormap_index:t[r++]|t[r++]<<8,colormap_length:t[r++]|t[r++]<<8,colormap_size:t[r++],origin:[t[r++]|t[r++]<<8,t[r++]|t[r++]<<8],width:t[r++]|t[r++]<<8,height:t[r++]|t[r++]<<8,pixel_size:t[r++],flags:t[r++]};!function(e){switch(e.image_type){case 1:case 9:(256<e.colormap_length||24!==e.colormap_size||1!==e.colormap_type)&&console.error("TGALoader.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case 2:case 3:case 10:case 11:e.colormap_type&&console.error("TGALoader.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case 0:console.error("TGALoader.parse.tgaCheckHeader: No data");default:console.error('TGALoader.parse.tgaCheckHeader: Invalid type " '+e.image_type+'"')}(e.width<=0||e.height<=0)&&console.error("TGALoader.parse.tgaCheckHeader: Invalid image size"),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('TGALoader.parse.tgaCheckHeader: Invalid pixel size "'+e.pixel_size+'"')}(_),_.id_length+18>e.length&&console.error("TGALoader.parse: No data"),r+=_.id_length;var n=!1,i=!1,l=!1;switch(_.image_type){case 9:i=n=!0;break;case 1:i=!0;break;case 10:n=!0;break;case 2:break;case 11:l=n=!0;break;case 3:l=!0}var a=document.createElement("canvas");a.width=_.width,a.height=_.height;var s=a.getContext("2d"),o=s.createImageData(_.width,_.height),h=function(e,t,r,n,i){var a,s=r.pixel_size>>3,o=r.width*r.height*s;if(t&&(a=i.subarray(n,n+=r.colormap_length*(r.colormap_size>>3))),e)for(var h,c,u,l=new Uint8Array(o),d=0,p=new Uint8Array(s);d<o;)if(c=1+(127&(h=i[n++])),128&h){for(u=0;u<s;++u)p[u]=i[n++];for(u=0;u<c;++u)l.set(p,d+u*s);d+=s*c}else{for(c*=s,u=0;u<c;++u)l[d+u]=i[n++];d+=c}else l=i.subarray(n,n+=t?r.width*r.height:o);return{pixel_data:l,palettes:a}}(n,i,_,r,t);return function(e,t,r,n,i){var a,s,o,h,c,u;switch((48&_.flags)>>4){default:case 2:c=t,s=a=0,h=o=1,u=r;break;case 0:a=0,c=t,s=r-(o=1),u=h=-1;break;case 3:a=t-1,c=o=-1,s=0,h=1,u=r;break;case 1:a=t-1,s=r-1,u=h=c=o=-1}if(l)switch(_.pixel_size){case 8:!function(e,t,r,n,i,a,s,o){for(var h,c,u=0,l=_.width,d=t;d!==n;d+=r)for(c=i;c!==s;c+=a,u++)h=o[u],e[4*(c+l*d)+0]=h,e[4*(c+l*d)+1]=h,e[4*(c+l*d)+2]=h,e[4*(c+l*d)+3]=255}(e,s,h,u,a,o,c,n);break;case 16:!function(e,t,r,n,i,a,s,o){for(var h,c=0,u=_.width,l=t;l!==n;l+=r)for(h=i;h!==s;h+=a,c+=2)e[4*(h+u*l)+0]=o[c+0],e[4*(h+u*l)+1]=o[c+0],e[4*(h+u*l)+2]=o[c+0],e[4*(h+u*l)+3]=o[c+1]}(e,s,h,u,a,o,c,n);break;default:console.error("TGALoader.parse.getTgaRGBA: not support this format")}else switch(_.pixel_size){case 8:!function(e,t,r,n,i,a,s,o,h){for(var c,u,l=h,d=0,p=_.width,f=t;f!==n;f+=r)for(u=i;u!==s;u+=a,d++)c=o[d],e[4*(u+p*f)+3]=255,e[4*(u+p*f)+2]=l[3*c+0],e[4*(u+p*f)+1]=l[3*c+1],e[4*(u+p*f)+0]=l[3*c+2]}(e,s,h,u,a,o,c,n,i);break;case 16:!function(e,t,r,n,i,a,s,o){for(var h,c,u=0,l=_.width,d=t;d!==n;d+=r)for(c=i;c!==s;c+=a,u+=2)h=o[u+0]+(o[u+1]<<8),e[4*(c+l*d)+0]=(31744&h)>>7,e[4*(c+l*d)+1]=(992&h)>>2,e[4*(c+l*d)+2]=(31&h)>>3,e[4*(c+l*d)+3]=32768&h?0:255}(e,s,h,u,a,o,c,n);break;case 24:!function(e,t,r,n,i,a,s,o){for(var h,c=0,u=_.width,l=t;l!==n;l+=r)for(h=i;h!==s;h+=a,c+=3)e[4*(h+u*l)+3]=255,e[4*(h+u*l)+2]=o[c+0],e[4*(h+u*l)+1]=o[c+1],e[4*(h+u*l)+0]=o[c+2]}(e,s,h,u,a,o,c,n);break;case 32:!function(e,t,r,n,i,a,s,o){for(var h,c=0,u=_.width,l=t;l!==n;l+=r)for(h=i;h!==s;h+=a,c+=4)e[4*(h+u*l)+2]=o[c+0],e[4*(h+u*l)+1]=o[c+1],e[4*(h+u*l)+0]=o[c+2],e[4*(h+u*l)+3]=o[c+3]}(e,s,h,u,a,o,c,n);break;default:console.error("TGALoader.parse.getTgaRGBA: not support this format")}}(o.data,_.width,_.height,h.pixel_data,h.palettes),s.putImageData(o,0,0),a}}),Object.assign(Oe.prototype,{load:function(e,t,r,n){var i=this,a=new Le(this.manager);a.setResponseType("arraybuffer"),a.load(e,function(e){void 0!==t&&t(i.parse(e))},r,n)},parse:function(e){function g(e,t){switch(e){case 1:console.error("zen3d.RGBELoader Read Error: "+(t||""));break;case 2:console.error("zen3d.RGBELoader Write Error: "+(t||""));break;case 3:console.error("zen3d.RGBELoader Bad File Format: "+(t||""));break;default:console.error("zen3d.RGBELoader: Error: "+(t||""))}return-1}function h(e,t,r){t=t||1024;for(var n=e.pos,i=-1,a=0,s="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));(i=o.indexOf("\n"))<0&&a<t&&n<e.byteLength;)s+=o,a+=o.length,n+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));return-1<i&&(!1!==r&&(e.pos+=a+i+1),s+o.slice(0,i))}var t=new Uint8Array(e);t.pos=0;var r,n,i,a,s,o,c=function(e){var t,r,n=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*FORMAT=(\S+)\s*$/,s=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(e.pos>=e.byteLength||!(t=h(e)))return g(1,"no header found");if(!(r=t.match(/^#\?(\S+)$/)))return g(3,"bad initial token");for(o.valid|=1,o.programtype=r[1],o.string+=t+"\n";!1!==(t=h(e));)if(o.string+=t+"\n","#"!==t.charAt(0)){if((r=t.match(n))&&(o.gamma=parseFloat(r[1])),(r=t.match(i))&&(o.exposure=parseFloat(r[1])),(r=t.match(a))&&(o.valid|=2,o.format=r[1]),(r=t.match(s))&&(o.valid|=4,o.height=parseInt(r[1],10),o.width=parseInt(r[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=t+"\n";return 2&o.valid?4&o.valid?o:g(3,"missing image size specifier"):g(3,"missing format specifier")}(t);if(-1!==c){var u=c.width,l=c.height,d=function(e,t,r){var n,i,a,s,o,h,c,u,l,d,p,f,_,m=t,v=r;if(m<8||32767<m||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(m!==(e[2]<<8|e[3]))return g(3,"wrong scanline width");if(!(n=new Uint8Array(4*t*r)).length)return g(4,"unable to allocate buffer space");for(a=i=0,u=4*m,_=new Uint8Array(4),h=new Uint8Array(u);0<v&&a<e.byteLength;){if(a+4>e.byteLength)return g(1);if(_[0]=e[a++],_[1]=e[a++],_[2]=e[a++],_[3]=e[a++],2!=_[0]||2!=_[1]||(_[2]<<8|_[3])!=m)return g(3,"bad rgbe scanline format");for(c=0;c<u&&a<e.byteLength;){if((f=128<(s=e[a++]))&&(s-=128),0===s||u<c+s)return g(3,"bad scanline data");if(f)for(o=e[a++],l=0;l<s;l++)h[c++]=o;else h.set(e.subarray(a,a+s),c),c+=s,a+=s}for(d=m,l=0;l<d;l++)p=0,n[i]=h[l+0],p+=m,n[i+1]=h[l+p],p+=m,n[i+2]=h[l+p],p+=m,n[i+3]=h[l+p],i+=4;v--}return n}(t.subarray(t.pos),u,l);if(-1!==d){if(this.type===y.UNSIGNED_BYTE)var p=d,f=x.RGBA,_=y.UNSIGNED_BYTE;else if(this.type===y.FLOAT){for(var m=d.length/4*3,v=new Float32Array(m),M=0;M<m;M++)i=v,a=3*M,o=s=void 0,s=(r=d)[(n=4*M)+3],o=Math.pow(2,s-128)/255,i[a+0]=r[n+0]*o,i[a+1]=r[n+1]*o,i[a+2]=r[n+2]*o;p=v,f=x.RGB,_=y.FLOAT}else console.error("zen3d.RGBELoader: unsupported type: ",this.type);return{width:u,height:l,data:p,header:c.string,gamma:c.gamma,exposure:c.exposure,format:f,type:_}}}return null}}),Fe.prototype=Object.assign(Object.create(Ae.prototype),{constructor:Fe,copy:function(e){return Ae.prototype.copy.call(this,e),this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this},updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}}),Fe.fromImage=function(e){var t=new Fe;return t.image=e,t.version++,t},Fe.fromSrc=function(e){var t=new Fe,r=0<e.search(/\.(jpg|jpeg)$/)||0===e.search(/^data\:image\/jpeg/),n=0<e.search(/\.(tga)$/)||0===e.search(/^data\:image\/tga/);return 0<e.search(/\.(hdr)$/)?(new Oe).load(e,function(e){t.image={data:e.data,width:e.width,height:e.height},t.encoding=zen3d.TEXEL_ENCODING_TYPE.RGBE,t.type=e.type,t.format=e.format,t.version++,t.dispatchEvent({type:"onload"})}):(new(n?Re:Ce)).load(e,function(e){t.format=r?x.RGB:x.RGBA,t.image=e,t.version++,t.dispatchEvent({type:"onload"})}),t},Ue.prototype=Object.assign(Object.create(Ae.prototype),{constructor:Ue,copy:function(e){return Ae.prototype.copy.call(this,e),this.images=e.images.slice(0),this}}),Ue.fromImage=function(e){for(var t=new Ue,r=t.images,n=0;n<6;n++)r[n]=e[n];return t.version++,t},Ue.fromSrc=function(r){var n=new Ue,i=n.images,e=r[0],a=0<e.search(/\.(jpg|jpeg)$/)||0===e.search(/^data\:image\/jpeg/),t=0<e.search(/\.(tga)$/)||0===e.search(/^data\:image\/tga/),s=0<e.search(/\.(hdr)$/),o=new(s?Oe:t?Re:Ce),h=0;return function e(t){t&&(s?i.push({data:t.data,width:t.width,height:t.height}):i.push(t),h++),6<=h?function(e){e?(n.encoding=A.RGBE,n.type=e.type,n.format=e.format):n.format=a?x.RGB:x.RGBA,n.version++,n.dispatchEvent({type:"onload"})}(s?t:void 0):o.load(r[h],e)}(),n},De.prototype=Object.assign(Object.create(Ae.prototype),{constructor:De});var Ie=0,Be=new K;function ze(){Object.defineProperty(this,"id",{value:Ie++}),this.uuid=r(),this.name="",this.type="",this.position=new D,this.scale=new D(1,1,1),this.euler=new $,this.quaternion=new re;var e=this.euler,t=this.quaternion;e.onChange(function(){t.setFromEuler(e,!1)}),t.onChange(function(){e.setFromQuaternion(t,void 0,!1)}),this.matrix=new K,this.worldMatrix=new K,this.children=new Array,this.parent=null,this.castShadow=!1,this.receiveShadow=!1,this.shadowType=b.PCF3_SOFT,this.frustumCulled=!0,this.visible=!0,this.renderOrder=0,this.userData={},this.matrixAutoUpdate=!0,this.matrixNeedsUpdate=!0,this.worldMatrixNeedsUpdate=!0}function Ge(){ze.call(this),this.type="bone",this.offsetMatrix=new K}Object.assign(ze.prototype,{onBeforeRender:function(){},onAfterRender:function(){},add:function(e){e!==this?(null!==e.parent&&e.parent.remove(e),(e.parent=this).children.push(e),e.worldMatrixNeedsUpdate=!0):console.error("Object3D.add: object can't be added as a child of itself.",e)},remove:function(e){var t=this.children.indexOf(e);-1!==t&&(e.parent=null,this.children.splice(t,1),e.worldMatrixNeedsUpdate=!0)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var r=0,n=this.children.length;r<n;r++){var i=this.children[r].getObjectByProperty(e,t);if(void 0!==i)return i}},updateMatrix:function(e){var t;(this.matrixAutoUpdate||this.matrixNeedsUpdate)&&(this.matrix.transform(this.position,this.scale,this.quaternion),this.matrixNeedsUpdate=!1,this.worldMatrixNeedsUpdate=!0),(this.worldMatrixNeedsUpdate||e)&&(this.worldMatrix.copy(this.matrix),this.parent&&(t=this.parent.worldMatrix,this.worldMatrix.premultiply(t)),e=!(this.worldMatrixNeedsUpdate=!1));for(var r=this.children,n=0,i=r.length;n<i;n++)r[n].updateMatrix(e)},getWorldDirection:function(e){e=e||new D;var t=this.worldMatrix.elements;return e.set(t[8],t[9],t[10]).normalize()},lookAt:function(e,t){Be.lookAtRH(e,this.position,t),this.quaternion.setFromRotationMatrix(Be)},raycast:function(e,t){},traverse:function(e){e(this);for(var t=this.children,r=0,n=t.length;r<n;r++)t[r].traverse(e)},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.type=e.type,this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.worldMatrix.copy(e.worldMatrix),this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var r=0;r<e.children.length;r++){var n=e.children[r];this.add(n.clone())}return this}}),(Ge.prototype=Object.create(ze.prototype)).constructor=Ge;var ke=new K;function He(e){e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),this.boneTexture=void 0}function Ve(e,t,r,n,i){if(.5<=n)for(var a=0;a!==i;++a)e[t+a]=e[r+a]}function je(e,t,r,n){re.slerpFlat(e,t,e,t,e,r,n)}function We(e,t,r,n,i){for(var a=1-n,s=0;s!==i;++s){var o=t+s;e[o]=e[o]*a+e[r+s]*n}}function Xe(e,t,r,n){this.target=null,this.property="",this.parseBinding(e,t),this.valueSize=n;var i,a=Float64Array;switch(r){case"quaternion":i=je;break;case"string":case"bool":a=Array,i=Ve;break;default:i=We}this.buffer=new a(3*n),this._mixBufferFunction=i,this.cumulativeWeight=0,this.referenceCount=0,this.useCount=0}function Ye(){this._clips={},this._bindings={},this._activeClips={}}function qe(e,t,r,n,i){this.target=e,this.propertyPath=t,this.name=this.target.uuid+"."+t,this.times=r,this.values=n,this.valueSize=n.length/r.length,this.interpolant=void 0===i||i}function Ze(e,t,r,n,i){qe.call(this,e,t,r,n,i)}function Ke(e,t,r,n,i){qe.call(this,e,t,r,n,i)}function Qe(e){this.name=e||"",this.tracks=[],this.loop=!0,this.startFrame=0,this.endFrame=0,this.frame=0}function $e(e,t,r,n,i){qe.call(this,e,t,r,n,i)}function Je(e,t,r,n,i){qe.call(this,e,t,r,n,i)}function et(e,t,r,n,i){qe.call(this,e,t,r,n,i)}function tt(e,t,r,n,i){qe.call(this,e,t,r,n,i)}function rt(e,t,r){this.array=e,this.size=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===r,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}Object.assign(He.prototype,{pose:function(){for(var e=0;e<this.bones.length;e++){(t=this.bones[e]).worldMatrix.getInverse(t.offsetMatrix)}for(var t,e=0;e<this.bones.length;e++){(t=this.bones[e]).parent&&"bone"==t.parent.type?(t.matrix.getInverse(t.parent.worldMatrix),t.matrix.multiply(t.worldMatrix)):t.matrix.copy(t.worldMatrix),t.matrix.decompose(t.position,t.quaternion,t.scale)}},updateBones:function(){for(var e=0;e<this.bones.length;e++){var t=this.bones[e];ke.multiplyMatrices(t.worldMatrix,t.offsetMatrix),ke.toArray(this.boneMatrices,16*e)}void 0!==this.boneTexture&&this.boneTexture.version++},getBoneByName:function(e){for(var t=0,r=this.bones.length;t<r;t++){var n=this.bones[t];if(n.name===e)return n}}}),Object.assign(Xe.prototype,{parseBinding:function(e,t){if(1<(t=t.split(".")).length){for(var r=e[t[0]],n=1;n<t.length-1;n++)r=r[t[n]];this.property=t[t.length-1],this.target=r}else this.property=t[0],this.target=e},saveOriginalState:function(){var e=this.buffer,t=this.valueSize,r=2*t;1<this.valueSize?this.target[this.property].toArray?this.target[this.property].toArray(e,r):function(e,t,r,n){for(var i=0;i<n;i++)e[r+i]=t[i]}(e,this.target[this.property],r,this.valueSize):this.target[this.property]=e[r];for(var n=t,i=r;n!==i;++n)e[n]=e[r+n%t];this.cumulativeWeight=0},restoreOriginalState:function(){for(var e=this.buffer,t=this.valueSize,r=2*t,n=t,i=r;n!==i;++n)e[n]=e[r+n%t];this.apply()},accumulate:function(e){var t=this.buffer,r=this.valueSize,n=r,i=this.cumulativeWeight;if(0===i){for(var a=0;a!==r;++a)t[n+a]=t[a];i=e}else{var s=e/(i+=e);this._mixBufferFunction(t,n,0,s,r)}this.cumulativeWeight=i},apply:function(){var e,t=this.buffer,r=this.valueSize,n=this.cumulativeWeight;this.cumulativeWeight=0,n<1&&(e=2*r,this._mixBufferFunction(t,r,e,1-n,r)),1<this.valueSize?this.target[this.property].fromArray?this.target[this.property].fromArray(t,r):function(e,t,r,n){for(var i=0;i<n;i++)e[i]=t[r+i]}(this.target[this.property],t,r,this.valueSize):this.target[this.property]=t[r]}}),Object.assign(Ye.prototype,{add:function(e){if(void 0===this._clips[e.name]){for(var t=e.tracks,r=0;r<t.length;r++){var n,i=t[r],a=i.name;this._bindings[a]?n=this._bindings[a]:(n=new Xe(i.target,i.propertyPath,i.valueTypeName,i.valueSize),this._bindings[a]=n),n.referenceCount++}this._clips[e.name]=e}else console.warn("AnimationMixer.add: already has clip: "+e.name)},remove:function(e){if(this._clips[e.name]){for(var t=e.tracks,r=0;r<t.length;r++){var n=t[r].name,i=this._bindings[n];i&&i.referenceCount--,i.referenceCount<=0&&delete this._bindings[n]}delete this._clips[e.name]}else console.warn("AnimationMixer.remove: has no clip: "+e.name)},play:function(e,t){if(void 0===this._activeClips[e]){this._activeClips[e]=void 0===t?1:t;var r=this._clips[e];if(r){r.frame=0;for(var n=r.tracks,i=0;i<n.length;i++){var a=n[i].name,s=this._bindings[a];s&&0==s.useCount++&&s.saveOriginalState()}}else console.warn("AnimationMixer.stop: clip "+e+" is not found.")}else console.warn("AnimationMixer.play: clip "+e+" is playing.")},stop:function(e){if(void 0!==this._activeClips[e]){delete this._activeClips[e];var t=this._clips[e];if(t)for(var r=t.tracks,n=0;n<r.length;n++){var i=r[n].name,a=this._bindings[i];a&&0<a.useCount&&0==--a.useCount&&a.restoreOriginalState()}else console.warn("AnimationMixer.stop: clip "+e+" is not found.")}else console.warn("AnimationMixer.stop: clip "+e+" is not playing.")},update:function(e){for(var t in this._activeClips){var r=this._clips[t],n=this._activeClips[t];r.update(e,this._bindings,n)}for(var i in this._bindings)0<this._bindings[i].useCount&&this._bindings[i].apply()},setClipWeight:function(e,t){void 0!==this._activeClips[e]?this._activeClips[e]=t:console.warn("AnimationMixer.stop: clip "+e+" is not playing.")},getAllClipNames:function(){var e=[];for(var t in this._clips)e.push(t);return e}}),Object.assign(qe.prototype,{_getLastTimeIndex:function(e){for(var t=0,r=this.times.length,n=0;n<r;n++)e>=this.times[n]&&(t=n);return t},getValue:function(e,t){for(var r=this._getLastTimeIndex(e),n=this.times,i=this.values,a=this.valueSize,s=n[r],o=n[r+1],h=0;h<a;h++){var c,u=i[r*a+h],l=i[(r+1)*a+h];this.interpolant&&void 0!==u&&void 0!==l?(c=(e-s)/(o-s),t[h]=u*(1-c)+l*c):t[h]=u}}}),Ze.prototype=Object.assign(Object.create(qe.prototype),{constructor:Ze,valueTypeName:"bool",getValue:function(e,t){var r=this._getLastTimeIndex(e),n=this.times[r];t[0]=this.values[n]}}),Ke.prototype=Object.assign(Object.create(qe.prototype),{constructor:Ke,valueTypeName:"color"}),Object.assign(Qe.prototype,{update:function(e,t,r){this.frame+=e,this.frame>this.endFrame&&(this.loop?this.frame=this.startFrame:this.frame=this.endFrame);for(var n=0,i=this.tracks.length;n<i;n++){var a=this.tracks[n],s=t[a.name];a.getValue(this.frame,s.buffer),s.accumulate(r)}}}),$e.prototype=Object.assign(Object.create(qe.prototype),{constructor:$e,valueTypeName:"number"}),Je.prototype=Object.assign(Object.create(qe.prototype),{constructor:Je,valueTypeName:"quaternion",getValue:function(e,t){var r=this._getLastTimeIndex(e),n=this.times,i=this.values,a=n[r],s=n[r+1],o=0;if(this.interpolant)if(void 0!==s)re.slerpFlat(t,0,i,4*r,i,4*(r+1),(e-a)/(s-a));else for(o=0;o<4;o++)t[o]=i[4*r+o];else for(o=0;o<4;o++)t[o]=i[4*r+o]}}),et.prototype=Object.assign(Object.create(qe.prototype),{constructor:et,valueTypeName:"string",getValue:function(e,t){var r=this._getLastTimeIndex(e),n=this.times[r];t[0]=this.values[n]}}),tt.prototype=Object.assign(Object.create(qe.prototype),{constructor:tt,valueTypeName:"vector"}),Object.assign(rt.prototype,{setArray:function(e){return this.count=void 0!==e?e.length/this.size:0,this.array=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.size=e.size,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},clone:function(){return new this.constructor(this.array,this.size).copy(this)}});var nt=1;function it(){R.call(this),Object.defineProperty(this,"id",{value:nt++}),this.uuid=r(),this.attributes={},this.morphAttributes={},this.index=null,this.boundingBox=new ae,this.boundingSphere=new he,this.groups=[],this.version=0}it.prototype=Object.assign(Object.create(R.prototype),{constructor:it,addAttribute:function(e,t){this.attributes[e]=t},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){delete this.attributes[e]},setIndex:function(e){Array.isArray(e)?this.index=new rt(new Uint16Array(e),1):this.index=e},addGroup:function(e,t,r){this.groups.push({start:e,count:t,materialIndex:void 0!==r?r:0})},clearGroups:function(){this.groups=[]},computeBoundingBox:function(){var e,t=this.attributes.a_Position||this.attributes.position;t.isInterleavedBufferAttribute?(e=t.data,this.boundingBox.setFromArray(e.array,e.stride)):this.boundingBox.setFromArray(t.array,t.size)},computeBoundingSphere:function(){var e,t=this.attributes.a_Position||this.attributes.position;t.isInterleavedBufferAttribute?(e=t.data,this.boundingSphere.setFromArray(e.array,e.stride)):this.boundingSphere.setFromArray(t.array,t.size)},dispose:function(){this.dispatchEvent({type:"dispose"})},copy:function(e){var t;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;var r=e.index;null!==r&&this.setIndex(r.clone());var n=e.attributes;for(t in n){var i=n[t];this.addAttribute(t,i.clone())}var a=e.morphAttributes;for(t in a){for(var s=[],o=a[t],h=0,c=o.length;h<c;h++)s.push(o[h].clone());this.morphAttributes[t]=s}var u=e.groups;for(h=0,c=u.length;h<c;h++){var l=u[h];this.addGroup(l.start,l.count,l.materialIndex)}var d=e.boundingBox;null!==d&&(this.boundingBox=(new ae).copy(d));var p=e.boundingSphere;return null!==p&&(this.boundingSphere=(new he).copy(p)),this},clone:function(){return(new it).copy(this)}});var at=function(s){function e(e,t,r,n,i,a){s.call(this),this.buildGeometry(e,t,r,n,i,a)}return s&&(e.__proto__=s),((e.prototype=Object.create(s&&s.prototype)).constructor=e).prototype.buildGeometry=function(e,t,r,n,i,a){var N=this;e=e||1,t=t||1,r=r||1,n=Math.floor(n)||1,i=Math.floor(i)||1,a=Math.floor(a)||1;var C=[],L=[],R=[],O=[],F=0,U=0;function s(e,t,r,n,i,a,s,o,h,c,u){for(var l=a/h,d=s/c,p=a/2,f=s/2,_=o/2,m=h+1,v=c+1,g=0,M=0,E=new D,S=0;S<v;S++)for(var x=S*d-f,y=0;y<m;y++){var w=y*l-p;E[e]=w*n,E[t]=x*i,E[r]=_,L.push(E.x,E.y,E.z),E[e]=0,E[t]=0,E[r]=0<o?1:-1,R.push(E.x,E.y,E.z),O.push(y/h),O.push(1-S/c),g+=1}for(S=0;S<c;S++)for(y=0;y<h;y++){var T=F+y+m*S,b=F+y+m*(S+1),A=F+(y+1)+m*(S+1),P=F+(y+1)+m*S;C.push(T,b,P),C.push(b,A,P),M+=6}N.addGroup(U,M,u),U+=M,F+=g}s("z","y","x",-1,-1,r,t,e,a,i,0),s("z","y","x",1,-1,r,t,-e,a,i,1),s("x","z","y",1,1,e,r,t,n,a,2),s("x","z","y",1,-1,e,r,-t,n,a,3),s("x","y","z",1,-1,e,t,r,n,i,4),s("x","y","z",-1,-1,e,t,-r,n,i,5),this.setIndex(C),this.addAttribute("a_Position",new rt(new Float32Array(L),3)),this.addAttribute("a_Normal",new rt(new Float32Array(R),3)),this.addAttribute("a_Uv",new rt(new Float32Array(O),2)),this.computeBoundingBox(),this.computeBoundingSphere()},e}(it);function st(e,t,r,n,i,a,s,o){it.call(this),this.buildGeometry(e,t,r,n,i,a,s,o)}function ot(e,t,r,n){rt.call(this,e,t,r),this.meshPerAttribute=n||1}function ht(){it.call(this),this.maxInstancedCount=void 0}function ct(e,t){this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function ut(e,t,r){ct.call(this,e,t),this.meshPerAttribute=r||1}function lt(e,t,r,n){this.data=e,this.size=t,this.offset=r,this.normalized=!0===n}function dt(e,t,r,n){it.call(this),this.buildGeometry(e,t,r,n)}function pt(e,t,r,n,i,a,s){it.call(this),this.buildGeometry(e,t,r,n,i,a,s)}function ft(e,t,r,n,i,a){it.call(this),this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:n,p:i,q:a},e=e||1,t=t||.4,r=Math.floor(r)||64,n=Math.floor(n)||8,i=i||2,a=a||3;for(var s,o=[],h=[],c=[],u=[],l=new D,d=new D,p=new D,f=new D,_=new D,m=new D,v=new D,g=0;g<=r;++g){var M=g/r*i*Math.PI*2;for(A(M,i,a,e,p),A(.01+M,i,a,e,f),m.subVectors(f,p),v.addVectors(f,p),_.crossVectors(m,v),v.crossVectors(_,m),_.normalize(),v.normalize(),s=0;s<=n;++s){var E=s/n*Math.PI*2,S=-t*Math.cos(E),x=t*Math.sin(E);l.x=p.x+(S*v.x+x*_.x),l.y=p.y+(S*v.y+x*_.y),l.z=p.z+(S*v.z+x*_.z),h.push(l.x,l.y,l.z),d.subVectors(l,p).normalize(),c.push(d.x,d.y,d.z),u.push(g/r),u.push(s/n)}}for(s=1;s<=r;s++)for(g=1;g<=n;g++){var y=(n+1)*(s-1)+(g-1),w=(n+1)*s+(g-1),T=(n+1)*s+g,b=(n+1)*(s-1)+g;o.push(y,w,b),o.push(w,T,b)}function A(e,t,r,n,i){var a=Math.cos(e),s=Math.sin(e),o=r/t*e,h=Math.cos(o);i.x=n*(2+h)*.5*a,i.y=n*(2+h)*s*.5,i.z=n*Math.sin(o)*.5}this.setIndex(o),this.addAttribute("a_Position",new rt(new Float32Array(h),3)),this.addAttribute("a_Normal",new rt(new Float32Array(c),3)),this.addAttribute("a_Uv",new rt(new Float32Array(u),2)),this.computeBoundingBox(),this.computeBoundingSphere()}st.prototype=Object.assign(Object.create(it.prototype),{constructor:st,buildGeometry:function(v,g,M,E,S,e,x,y){var w=this;v=void 0!==v?v:1,g=void 0!==g?g:1,M=M||1,E=Math.floor(E)||8,S=Math.floor(S)||1,e=void 0!==e&&e,x=void 0!==x?x:0,y=void 0!==y?y:2*Math.PI;var T=[],b=[],A=[],P=[],N=0,C=[],L=M/2,R=0;function t(e){for(var t,r=new J,n=new D,i=0,a=!0===e?v:g,s=!0===e?1:-1,o=N,h=1;h<=E;h++)b.push(0,L*s,0),A.push(0,s,0),P.push(.5,.5),N++;for(t=N,h=0;h<=E;h++){var c=h/E*y+x,u=Math.cos(c),l=Math.sin(c);n.x=a*l,n.y=L*s,n.z=a*u,b.push(n.x,n.y,n.z),A.push(0,s,0),r.x=.5*u+.5,r.y=.5*l*s+.5,P.push(r.x,r.y),N++}for(h=0;h<E;h++){var d=o+h,p=t+h;!0===e?T.push(p,p+1,d):T.push(p+1,p,d),i+=3}w.addGroup(R,i,!0===e?1:2),R+=i}!function(){var e,t,r=new D,n=new D,i=0,a=(g-v)/M;for(t=0;t<=S;t++){var s=[],o=t/S,h=o*(g-v)+v;for(e=0;e<=E;e++){var c=e/E,u=c*y+x,l=Math.sin(u),d=Math.cos(u);n.x=h*l,n.y=-o*M+L,n.z=h*d,b.push(n.x,n.y,n.z),r.set(l,a,d).normalize(),A.push(r.x,r.y,r.z),P.push(c,1-o),s.push(N++)}C.push(s)}for(e=0;e<E;e++)for(t=0;t<S;t++){var p=C[t][e],f=C[t+1][e],_=C[t+1][e+1],m=C[t][e+1];T.push(p,f,m),T.push(f,_,m),i+=6}w.addGroup(R,i,0),R+=i}(),!1===e&&(0<v&&t(!0),0<g&&t(!1)),this.setIndex(T),this.addAttribute("a_Position",new rt(new Float32Array(b),3)),this.addAttribute("a_Normal",new rt(new Float32Array(A),3)),this.addAttribute("a_Uv",new rt(new Float32Array(P),2)),this.computeBoundingBox(),this.computeBoundingSphere()}}),ot.prototype=Object.assign(Object.create(rt.prototype),{constructor:ot,isInstancedBufferAttribute:!0,copy:function(e){return rt.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),ht.prototype=Object.assign(Object.create(it.prototype),{constructor:ht,isInstancedGeometry:!0}),Object.assign(ct.prototype,{setArray:function(e){this.count=void 0!==e?e.length/this.stride:0,this.array=e}}),ut.prototype=Object.assign(Object.create(ct.prototype),{constructor:ut,isInstancedInterleavedBuffer:!0}),lt.prototype.isInterleavedBufferAttribute=!0,Object.defineProperties(lt.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),dt.prototype=Object.assign(Object.create(it.prototype),{constructor:dt,buildGeometry:function(e,t,r,n){for(var i=(e=e||1)/2,a=(t=t||1)/2,s=Math.floor(r)||1,o=Math.floor(n)||1,h=s+1,c=o+1,u=e/s,l=t/o,d=[],p=[],f=[],_=[],m=0;m<c;m++)for(var v=m*l-a,g=0;g<h;g++){var M=g*u-i;p.push(M,0,v),f.push(0,1,0),_.push(g/s),_.push(1-m/o)}for(m=0;m<o;m++)for(g=0;g<s;g++){var E=g+h*m,S=g+h*(m+1),x=g+1+h*(m+1),y=g+1+h*m;d.push(E,S,y),d.push(S,x,y)}this.setIndex(d),this.addAttribute("a_Position",new rt(new Float32Array(p),3)),this.addAttribute("a_Normal",new rt(new Float32Array(f),3)),this.addAttribute("a_Uv",new rt(new Float32Array(_),2)),this.computeBoundingBox(),this.computeBoundingSphere()}}),pt.prototype=Object.assign(Object.create(it.prototype),{constructor:pt,buildGeometry:function(e,t,r,n,i,a,s){e=e||1,t=Math.max(3,Math.floor(t)||8),r=Math.max(2,Math.floor(r)||6),n=void 0!==n?n:0,i=void 0!==i?i:2*Math.PI;for(var o=(a=void 0!==a?a:0)+(s=void 0!==s?s:Math.PI),h=0,c=[],u=new D,l=new D,d=[],p=[],f=[],_=[],m=0;m<=r;m++){for(var v=[],g=m/r,M=0;M<=t;M++){var E=M/t;u.x=-e*Math.cos(n+E*i)*Math.sin(a+g*s),u.y=e*Math.cos(a+g*s),u.z=e*Math.sin(n+E*i)*Math.sin(a+g*s),p.push(u.x,u.y,u.z),l.set(u.x,u.y,u.z).normalize(),f.push(l.x,l.y,l.z),_.push(E,1-g),v.push(h++)}c.push(v)}for(m=0;m<r;m++)for(M=0;M<t;M++){var S=c[m][M+1],x=c[m][M],y=c[m+1][M],w=c[m+1][M+1];(0!==m||0<a)&&d.push(S,x,w),(m!==r-1||o<Math.PI)&&d.push(x,y,w)}this.setIndex(d),this.addAttribute("a_Position",new rt(new Float32Array(p),3)),this.addAttribute("a_Normal",new rt(new Float32Array(f),3)),this.addAttribute("a_Uv",new rt(new Float32Array(_),2)),this.computeBoundingBox(),this.computeBoundingSphere()}}),(ft.prototype=Object.create(it.prototype)).constructor=ft;var _t=0;function mt(){R.call(this),Object.defineProperty(this,"id",{value:_t++}),this.type="",this.uuid=r(),this.precision=null,this.opacity=1,this.transparent=!1,this.blending=c.NORMAL,this.blendSrc=u.SRC_ALPHA,this.blendDst=u.ONE_MINUS_SRC_ALPHA,this.blendEquation=s.ADD,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.premultipliedAlpha=!1,this.vertexColors=C.NONE,this.vertexTangents=!1,this.diffuse=new fe(16777215),this.diffuseMap=null,this.diffuseMapCoord=0,this.normalMap=null,this.alphaMap=null,this.alphaMapCoord=0,this.aoMap=null,this.aoMapIntensity=1,this.aoMapCoord=0,this.bumpMap=null,this.bumpScale=1,this.envMap=null,this.envMapIntensity=1,this.envMapCombine=P.MULTIPLY,this.emissive=new fe(0),this.emissiveMap=null,this.emissiveMapCoord=0,this.emissiveIntensity=1,this.depthFunc=p.LEQUAL,this.depthTest=!0,this.depthWrite=!0,this.colorWrite=!0,this.stencilTest=!1,this.stencilWriteMask=255,this.stencilFunc=p.ALWAYS,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=f.KEEP,this.stencilZFail=f.KEEP,this.stencilZPass=f.KEEP,this.stencilFuncBack=null,this.stencilRefBack=null,this.stencilFuncMaskBack=null,this.stencilFailBack=null,this.stencilZFailBack=null,this.stencilZPassBack=null,this.alphaTest=0,this.side=E.FRONT,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.shading=S.SMOOTH_SHADING,this.dithering=!1,this.acceptLight=!1,this.drawMode=N.TRIANGLES,this.needsUpdate=!0}function vt(){mt.call(this),this.type=g.BASIC}function gt(){mt.call(this),this.type=g.LAMBERT,this.acceptLight=!0}function Mt(){mt.call(this),this.type=g.PHONG,this.shininess=30,this.specular=new fe(1118481),this.specularMap=null,this.acceptLight=!0}function Et(){mt.call(this),this.type=g.PBR,this.roughness=.5,this.metalness=.5,this.roughnessMap=null,this.metalnessMap=null,this.acceptLight=!0}function St(){mt.call(this),this.type=g.PBR2,this.specular=new fe(1118481),this.glossiness=.5,this.specularMap=null,this.glossinessMap=null,this.acceptLight=!0}function xt(){mt.call(this),this.type=g.MATCAP,this.matcap=null}function yt(){mt.call(this),this.type=g.POINT,this.size=1,this.sizeAttenuation=!0,this.drawMode=N.POINTS}function wt(){mt.call(this),this.type=g.LINE,this.lineWidth=1,this.drawMode=N.LINES}function Tt(e){mt.call(this),this.type=g.SHADER,this.vertexShader=e.vertexShader||"",this.fragmentShader=e.fragmentShader||"",this.defines={},Object.assign(this.defines,e.defines),this.uniforms=a(e.uniforms)}function bt(){mt.call(this),this.type=g.DEPTH,this.packToRGBA=!1}function At(){mt.call(this),this.type=g.DISTANCE}function Pt(n){var i=["","WEBKIT_","MOZ_"],a={};function e(e){if(a[e]||null===a[e])return a[e];var t=null;for(var r in i)if(t=n.getExtension(i[r]+e))break;return a[e]=t}var t=parseFloat(/^WebGL\ ([0-9])/.exec(n.getParameter(n.VERSION))[1]),r=e("EXT_texture_filter_anisotropic");return{version:t,maxPrecision:function(e,t){if("highp"===t){if(0<e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision&&0<e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision)return"highp";t="mediump"}return"mediump"===t&&0<e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision&&0<e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision?"mediump":"lowp"}(n,"highp"),maxTextures:n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS),maxVertexTextures:n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:n.getParameter(n.MAX_TEXTURE_SIZE),maxCubemapSize:n.getParameter(n.MAX_CUBE_MAP_TEXTURE_SIZE),maxVertexUniformVectors:n.getParameter(n.MAX_VERTEX_UNIFORM_VECTORS),lineWidthRange:n.getParameter(n.ALIASED_LINE_WIDTH_RANGE),anisotropyExt:r,maxAnisotropy:null!==r?n.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,maxSamples:1<t?n.getParameter(n.MAX_SAMPLES):1,getExtension:e}}function Nt(e,t,r,n){var i=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var s=0;s<n;s++)e.texImage2D(r+s,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,i);return a}function Ct(a){var t=!1,s=new ee,r=null,o=new ee(0,0,0,0);return{setMask:function(e){r===e||t||(a.colorMask(e,e,e,e),r=e)},setLocked:function(e){t=e},setClear:function(e,t,r,n,i){!0===i&&(e*=n,t*=n,r*=n),s.set(e,t,r,n),!1===o.equals(s)&&(a.clearColor(e,t,r,n),o.copy(s))},getClear:function(){return o},reset:function(){t=!1,r=null,o.set(-1,0,0,0)}}}function Lt(t,r){var n=!1,i=null,a=null,s=null;return{setTest:function(e){e?r.enable(t.DEPTH_TEST):r.disable(t.DEPTH_TEST)},setMask:function(e){i===e||n||(t.depthMask(e),i=e)},setFunc:function(e){a!==e&&(t.depthFunc(e),a=e)},setLocked:function(e){n=e},setClear:function(e){s!==e&&(t.clearDepth(e),s=e)},reset:function(){n=!1,s=a=i=null}}}function Rt(s,t){var r=!1,n=null,o=null,h=null,c=null,u=null,l=null,d=null,p=null,f=null,_=null,m=null,v=null,g=null,i=null;return{setTest:function(e){e?t.enable(s.STENCIL_TEST):t.disable(s.STENCIL_TEST)},setMask:function(e){n===e||r||(s.stencilMask(e),n=e)},setFunc:function(e,t,r,n,i,a){o===e&&h===t&&c===r&&p===n&&f===i&&_===a||(null===n||null===i||null===a?s.stencilFunc(e,t,r):(s.stencilFuncSeparate(s.FRONT,e,t,r),s.stencilFuncSeparate(s.BACK,n,i,a)),o=e,h=t,c=r,p=n,f=i,_=a)},setOp:function(e,t,r,n,i,a){u===e&&l===t&&d===r&&m===n&&v===i&&g===a||(null===n||null===i||null===a?s.stencilOp(e,t,r):(s.stencilOpSeparate(s.FRONT,e,t,r),s.stencilOpSeparate(s.BACK,n,i,a)),u=e,l=t,d=r,m=n,v=i,g=a)},setLocked:function(e){r=e},setClear:function(e){i!==e&&(s.clearStencil(e),i=e)},reset:function(){r=!1,i=d=l=u=c=h=o=n=null}}}function Ot(e,t){this.gl=e,this.capabilities=t,this.colorBuffer=new Ct(e),this.depthBuffer=new Lt(e,this),this.stencilBuffer=new Rt(e,this),this.states={},this.currentBlending=null,this.currentBlendEquation=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendEquationAlpha=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipliedAlpha=null,this.currentCullFace=null,this.currentViewport=new ee,this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBuffers={},this.emptyTextures={},this.emptyTextures[e.TEXTURE_2D]=Nt(e,e.TEXTURE_2D,e.TEXTURE_2D,1),this.emptyTextures[e.TEXTURE_CUBE_MAP]=Nt(e,e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),this.currentFlipSided=!1,this.currentLineWidth=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentProgram=null,this.currentRenderTarget=null,this.colorBuffer.setClear(0,0,0,1),this.depthBuffer.setClear(1),this.stencilBuffer.setClear(0),this.depthBuffer.setTest(!0),this.depthBuffer.setFunc(p.LEQUAL),this.setCullFace(l.BACK),this.setFlipSided(!1)}function Ft(){this.properties=new WeakMap}function Ut(e){return e.wrapS!==v.CLAMP_TO_EDGE||e.wrapT!==v.CLAMP_TO_EDGE||e.minFilter!==_.NEAREST&&e.minFilter!==_.LINEAR}function Dt(e){return e===_.NEAREST||e===_.NEAREST_MIPMAP_LINEAR||e===_.NEAREST_MIPMAP_NEAREST?_.NEAREST:_.LINEAR}function It(e){return o(e.width)&&o(e.height)}function Bt(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.width=n(e.width),t.height=n(e.height),t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}function zt(e,t){if(e.width>t||e.height>t){var r=t/Math.max(e.width,e.height),n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return n.width=Math.floor(e.width*r),n.height=Math.floor(e.height*r),n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),console.warn("image is too big ("+e.width+"x"+e.height+"). Resized to "+n.width+"x"+n.height,e),n}return e}function Gt(e,t,r,n){this.gl=e,this.state=t,this.properties=r,this.capabilities=n}function kt(e,t,r,n,i){n.isInterleavedBufferAttribute&&(n=n.data);var a,s,o,h,c,u,l,d=t.get(n);void 0===d.buffer?function(e,t,r,n){var i=r.array,a=r.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,s=e.createBuffer();e.bindBuffer(n,s),e.bufferData(n,i,a);var o=e.FLOAT;i instanceof Float32Array?o=e.FLOAT:i instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array."):i instanceof Uint16Array?o=e.UNSIGNED_SHORT:i instanceof Int16Array?o=e.SHORT:i instanceof Uint32Array?o=e.UNSIGNED_INT:i instanceof Int32Array?o=e.INT:i instanceof Int8Array?o=e.BYTE:i instanceof Uint8Array&&(o=e.UNSIGNED_BYTE),t.buffer=s,t.type=o,t.bytesPerElement=i.BYTES_PER_ELEMENT,t.version=r.version}(e,d,n,i):d.version<n.version&&(a=e,s=r,o=d.buffer,c=i,u=(h=n).array,l=h.updateRange,a.bindBuffer(c,o),!1===h.dynamic?a.bufferData(c,u,a.STATIC_DRAW):-1===l.count?a.bufferSubData(c,0,u):0===l.count?console.error("updateBuffer: dynamic BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(2<=s.version?a.bufferSubData(c,l.offset*u.BYTES_PER_ELEMENT,u,l.offset,l.count):a.bufferSubData(c,l.offset*u.BYTES_PER_ELEMENT,u.subarray(l.offset,l.offset+l.count)),l.count=-1),d.version=n.version)}function Ht(e,t,r){r.isInterleavedBufferAttribute&&(r=r.data);var n=t.get(r);n.buffer&&e.deleteBuffer(n.buffer),t.delete(r)}function Vt(e,t,r,n,i){this.gl=e,this.state=t,this.vertexArrayBindings=r,this.properties=n,this.capabilities=i}mt.prototype=Object.assign(Object.create(R.prototype),{constructor:mt,copy:function(e){return this.type=e.type,this.precision=e.precision,e.defines&&(this.defines=Object.assign({},e.defines)),this.opacity=e.opacity,this.transparent=e.transparent,this.premultipliedAlpha=e.premultipliedAlpha,this.vertexColors=e.vertexColors,this.diffuse.copy(e.diffuse),this.diffuseMap=e.diffuseMap,this.diffuseMapCoord=e.diffuseMapCoord,this.alphaMap=e.alphaMap,this.alphaMapCoord=e.alphaMapCoord,this.normalMap=e.normalMap,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.aoMapCoord=e.aoMapCoord,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.envMapCombine=e.envMapCombine,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveMapCoord=e.emissiveMapCoord,this.emissiveIntensity=e.emissiveIntensity,this.blending=e.blending,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.alphaTest=e.alphaTest,this.side=e.side,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.shading=e.shading,this.acceptLight=e.acceptLight,this.drawMode=e.drawMode,this},clone:function(){return(new this.constructor).copy(this)},dispose:function(){this.dispatchEvent({type:"dispose"})}}),(vt.prototype=Object.create(mt.prototype)).constructor=vt,(gt.prototype=Object.create(mt.prototype)).constructor=gt,Mt.prototype=Object.assign(Object.create(mt.prototype),{constructor:Mt,copy:function(e){return mt.prototype.copy.call(this,e),this.shininess=e.shininess,this.specular.copy(e.specular),this.specularMap=e.specularMap,this}}),Et.prototype=Object.assign(Object.create(mt.prototype),{constructor:Et,copy:function(e){return mt.prototype.copy.call(this,e),this.roughness=e.roughness,this.metalness=e.metalness,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this}}),St.prototype=Object.assign(Object.create(mt.prototype),{constructor:St,copy:function(e){return mt.prototype.copy.call(this,e),this.specular=e.specular,this.glossiness=e.glossiness,this.specularMap=e.specularMap,this.glossinessMap=e.glossinessMap,this}}),xt.prototype=Object.assign(Object.create(mt.prototype),{constructor:xt,copy:function(e){return mt.prototype.copy.call(this,e),this.matcap=e.matcap,this}}),yt.prototype=Object.assign(Object.create(mt.prototype),{constructor:yt,copy:function(e){return mt.prototype.copy.call(this,e),this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this}}),wt.prototype=Object.assign(Object.create(mt.prototype),{constructor:wt,copy:function(e){return mt.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this}}),Tt.prototype=Object.assign(Object.create(mt.prototype),{constructor:Tt,copy:function(e){return mt.prototype.copy.call(this,e),this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.uniforms=a(e.uniforms),this}}),(bt.prototype=Object.create(mt.prototype)).constructor=bt,(At.prototype=Object.create(mt.prototype)).constructor=At,Object.assign(Ot.prototype,{setBlend:function(e,t,r,n,i,a,s,o){var h=this.gl;e!==c.NONE?this.enable(h.BLEND):this.disable(h.BLEND),e!==c.CUSTOM?(e===this.currentBlending&&o===this.currentPremultipliedAlpha||(e===c.NORMAL&&(o?(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.ONE,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA)):(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA))),e===c.ADD&&(o?(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.ONE,h.ONE,h.ONE,h.ONE)):(h.blendEquation(h.FUNC_ADD),h.blendFunc(h.SRC_ALPHA,h.ONE)))),this.currentBlendEquation=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendEquationAlpha=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null):(i=i||t,a=a||r,s=s||n,t===this.currentBlendEquation&&i===this.currentBlendEquationAlpha||(h.blendEquationSeparate(t,i),this.currentBlendEquation=t,this.currentBlendEquationAlpha=i),r===this.currentBlendSrc&&n===this.currentBlendDst&&a===this.currentBlendSrcAlpha&&s===this.currentBlendDstAlpha||(h.blendFuncSeparate(r,n,a,s),this.currentBlendSrc=r,this.currentBlendDst=n,this.currentBlendSrcAlpha=a,this.currentBlendDstAlpha=s)),this.currentBlending=e,this.currentPremultipliedAlpha=o},setFlipSided:function(e){var t=this.gl;this.currentFlipSided!==e&&(e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e)},setCullFace:function(e){var t=this.gl;e!==l.NONE?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(e===l.BACK?t.cullFace(t.BACK):e===l.FRONT?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e},viewport:function(e,t,r,n){var i=this.currentViewport;i.x===e&&i.y===t&&i.z===r&&i.w===n||(this.gl.viewport(e,t,r,n),i.set(e,t,r,n))},activeTexture:function(e){var t=this.gl;void 0===e&&(e=t.TEXTURE0+this.capabilities.maxTextures-1),this.currentTextureSlot!==e&&(t.activeTexture(e),this.currentTextureSlot=e)},bindTexture:function(e,t){var r=this.gl;null===this.currentTextureSlot&&this.activeTexture();var n=this.currentBoundTextures[this.currentTextureSlot];void 0===n&&(n={type:void 0,texture:void 0},this.currentBoundTextures[this.currentTextureSlot]=n),n.type===e&&n.texture===t||(r.bindTexture(e,t||this.emptyTextures[e]),n.type=e,n.texture=t)},bindBuffer:function(e,t){var r=this.gl;this.currentBoundBuffers[e]!==t&&(r.bindBuffer(e,t),this.currentBoundBuffers[e]=t)},enable:function(e){!0!==this.states[e]&&(this.gl.enable(e),this.states[e]=!0)},disable:function(e){!1!==this.states[e]&&(this.gl.disable(e),this.states[e]=!1)},setLineWidth:function(e){var t;e!==this.currentLineWidth&&((t=this.capabilities.lineWidthRange)[0]<=e&&e<=t[1]?this.gl.lineWidth(e):console.warn("GL_ALIASED_LINE_WIDTH_RANGE is ["+t[0]+","+t[1]+"], but set to "+e+"."),this.currentLineWidth=e)},setPolygonOffset:function(e,t,r){var n=this.gl;e?(this.enable(n.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===t&&this.currentPolygonOffsetUnits===r||(n.polygonOffset(t,r),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=r)):this.disable(n.POLYGON_OFFSET_FILL)},setProgram:function(e){this.currentProgram!==e&&(this.gl.useProgram(e.program),this.currentProgram=e)}}),Object.assign(Ft.prototype,{get:function(e){var t=this.properties.get(e);return void 0===t&&(t={},this.properties.set(e,t)),t},delete:function(e){this.properties.delete(e)},clear:function(){this.properties=new WeakMap}}),Object.assign(Gt.prototype,{setTexture2D:function(e,t){var r=this.gl,n=this.state,i=this.capabilities;void 0!==t&&(t=r.TEXTURE0+t);var a=this.properties.get(e);if(!e.image||e.image.rtt&&void 0!==t||a.__version===e.version)return n.activeTexture(t),n.bindTexture(r.TEXTURE_2D,a.__webglTexture),a;void 0===a.__webglTexture&&(e.addEventListener("dispose",this.onTextureDispose,this),a.__webglTexture=r.createTexture()),n.activeTexture(t),n.bindTexture(r.TEXTURE_2D,a.__webglTexture);var s=e.image,o=s instanceof HTMLImageElement||s instanceof HTMLCanvasElement;o&&(s=zt(s,i.maxTextureSize),Ut(e)&&!1===It(s)&&i.version<2&&(s=Bt(s)));var h=!It(s)&&i.version<2;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,e.flipY),this.setTextureParameters(e,h);var c,u=e.mipmaps,l=e.format,d=e.internalformat||e.format,p=e.type;if(i.version<2?(l!==d&&console.warn("texture format "+l+" not same as internalformat "+d+" in webgl 1.0."),p===y.HALF_FLOAT&&(i.getExtension("OES_texture_half_float")||console.warn("extension OES_texture_half_float is not support in webgl 1.0.")),p===y.FLOAT&&(i.getExtension("OES_texture_float")||console.warn("extension OES_texture_float is not support in webgl 1.0.")),l!==x.DEPTH_COMPONENT&&l!==x.DEPTH_STENCIL||i.getExtension("WEBGL_depth_texture")||console.warn("extension WEBGL_depth_texture is not support in webgl 1.0.")):p===y.HALF_FLOAT&&(p=5131),o)if(0<u.length&&!h){for(var f=0,_=u.length;f<_;f++)c=u[f],r.texImage2D(r.TEXTURE_2D,f,d,l,p,c);e.generateMipmaps=!1,a.__maxMipLevel=u.length-1}else r.texImage2D(r.TEXTURE_2D,0,d,l,p,s),a.__maxMipLevel=0;else if(0<u.length&&!h){for(f=0,_=u.length;f<_;f++)c=u[f],r.texImage2D(r.TEXTURE_2D,f,d,c.width,c.height,e.border,l,p,c.data);e.generateMipmaps=!1,a.__maxMipLevel=u.length-1}else r.texImage2D(r.TEXTURE_2D,0,d,s.width,s.height,e.border,l,p,s.data),a.__maxMipLevel=0;return e.generateMipmaps&&!h&&this.generateMipmap(r.TEXTURE_2D,e,s.width,s.height),a.__version=e.version,a},setTextureCube:function(e,t){var r=this.gl,n=this.state,i=this.capabilities;void 0!==t&&(t=r.TEXTURE0+t);var a=this.properties.get(e);if(6!==e.images.length||e.images[0].rtt&&void 0!==t||a.__version===e.version)return n.activeTexture(t),n.bindTexture(r.TEXTURE_CUBE_MAP,a.__webglTexture),a;void 0===a.__webglTexture&&(e.addEventListener("dispose",this.onTextureDispose,this),a.__webglTexture=r.createTexture()),n.activeTexture(t),n.bindTexture(r.TEXTURE_CUBE_MAP,a.__webglTexture);var s,o=[],h=e.mipmaps,c=e.format,u=e.internalformat||e.format,l=e.type;i.version<2?(c!==u&&console.warn("texture format "+c+" not same as internalformat "+u+" in webgl 1.0."),l===y.HALF_FLOAT&&(i.getExtension("OES_texture_half_float")||console.warn("extension OES_texture_half_float is not support in webgl 1.0.")),l===y.FLOAT&&(i.getExtension("OES_texture_float")||console.warn("extension OES_texture_float is not support in webgl 1.0.")),c!==x.DEPTH_COMPONENT&&c!==x.DEPTH_STENCIL||i.getExtension("WEBGL_depth_texture")||console.warn("extension WEBGL_depth_texture is not support in webgl 1.0.")):l===y.HALF_FLOAT&&(l=5131);for(var d=!1,p=0;p<6;p++){(_=(f=e.images[p])instanceof HTMLImageElement||f instanceof HTMLCanvasElement)&&(f=zt(f,i.maxTextureSize),Ut(e)&&!1===It(f)&&i.version<2&&(f=Bt(f))),!It(f)&&i.version<2&&(d=!0),(o[p]=f).__isElement=_}r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,e.flipY),this.setTextureParameters(e,d);for(var f,_,p=0;p<6;p++){if(_=(f=o[p]).__isElement)if(0<h.length&&!d){for(var m=0,v=h.length;m<v;m++)s=h[m][p],r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,u,c,l,s);a.__maxMipLevel=h.length-1,e.generateMipmaps=!1}else r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,u,c,l,f),a.__maxMipLevel=0;else if(0<h.length&&!d){for(m=0,v=h.length;m<v;m++)s=h[m][p],r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+p,m,u,s.width,s.height,e.border,c,l,s.data);a.__maxMipLevel=h.length-1,e.generateMipmaps=!1}else r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,u,f.width,f.height,e.border,c,l,f.data),a.__maxMipLevel=0}return e.generateMipmaps&&!d&&this.generateMipmap(r.TEXTURE_CUBE_MAP,e,f.width,f.height),a.__version=e.version,a},setTexture3D:function(e,t){var r=this.gl,n=this.state;if(!(this.capabilities.version<2)){void 0!==t&&(t=r.TEXTURE0+t);var i=this.properties.get(e);if(e.image&&i.__version!==e.version){void 0===i.__webglTexture&&(e.addEventListener("dispose",this.onTextureDispose,this),i.__webglTexture=r.createTexture()),n.activeTexture(t),n.bindTexture(r.TEXTURE_3D,i.__webglTexture);var a=e.image;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,e.flipY),this.setTextureParameters(e,!1);var s=e.format,o=e.internalformat||e.format,h=e.type;return r.texImage3D(r.TEXTURE_3D,0,o,a.width,a.height,a.depth,e.border,s,h,a.data),e.generateMipmaps&&this.generateMipmap(r.TEXTURE_3D,e,a.width,a.height),i.__version=e.version,i}return n.activeTexture(t),n.bindTexture(r.TEXTURE_3D,i.__webglTexture),i}console.warn("Try to use Texture3D but browser not support WebGL2.0")},setTextureParameters:function(e,t){var r,n,i,a,s,o,h,c,u=this.gl,l=this.capabilities,d=e.textureType,p=(n=t,i=(r=e).wrapS,a=r.wrapT,s=r.magFilter,o=r.minFilter,h=r.anisotropy,c=r.compare,n&&(i=v.CLAMP_TO_EDGE,a=v.CLAMP_TO_EDGE,r.wrapS===v.CLAMP_TO_EDGE&&r.wrapT===v.CLAMP_TO_EDGE||console.warn("Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to zen3d.TEXTURE_WRAP.CLAMP_TO_EDGE.",r),s=Dt(r.magFilter),o=Dt(r.minFilter),(r.minFilter!==_.NEAREST&&r.minFilter!==_.LINEAR||r.magFilter!==_.NEAREST&&r.magFilter!==_.LINEAR)&&console.warn("Texture is not power of two. Texture.minFilter and Texture.magFilter should be set to zen3d.TEXTURE_FILTER.NEAREST or zen3d.TEXTURE_FILTER.LINEAR.",r)),[i,a,s,o,h,c]);u.texParameteri(d,u.TEXTURE_WRAP_S,p[0]),u.texParameteri(d,u.TEXTURE_WRAP_T,p[1]),u.texParameteri(d,u.TEXTURE_MAG_FILTER,p[2]),u.texParameteri(d,u.TEXTURE_MIN_FILTER,p[3]);var f=l.anisotropyExt;f&&u.texParameterf(d,f.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(p[4],l.maxAnisotropy)),2<=l.version&&(void 0!==p[5]?(u.texParameteri(d,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE),u.texParameteri(d,u.TEXTURE_COMPARE_FUNC,p[5])):u.texParameteri(d,u.TEXTURE_COMPARE_MODE,u.NONE))},generateMipmap:function(e,t,r,n){this.gl.generateMipmap(e),this.properties.get(t).__maxMipLevel=Math.log(Math.max(r,n))*Math.LOG2E},onTextureDispose:function(e){var t=this.gl,r=e.target,n=this.properties.get(r);r.removeEventListener("dispose",this.onTextureDispose,this),n.__webglTexture&&t.deleteTexture(n.__webglTexture),this.properties.delete(r)}}),Object.assign(Vt.prototype,{setGeometry:function(e){var t=this.gl,r=this.properties,n=this.capabilities,i=this.properties.get(e);for(var a in i.created||(e.addEventListener("dispose",this.onGeometryDispose,this),i.created=!0,i._vaos={}),null!==e.index&&kt(t,r,n,e.index,t.ELEMENT_ARRAY_BUFFER),e.attributes)kt(t,r,n,e.attributes[a],t.ARRAY_BUFFER);for(var a in e.morphAttributes)for(var s=e.morphAttributes[a],o=0,h=s.length;o<h;o++)kt(t,r,n,s[o],t.ARRAY_BUFFER);return i},onGeometryDispose:function(e){var t=this.gl,r=e.target,n=this.properties.get(r);for(var i in r.removeEventListener("dispose",this.onGeometryDispose,this),null!==r.index&&Ht(t,this.properties,r.index),r.attributes)Ht(t,this.properties,r.attributes[i]);for(var i in r.morphAttributes)for(var a=r.morphAttributes[i],s=0,o=a.length;s<o;s++)Ht(t,this.properties,a[s]);for(var h in n._vaos){var c=n[h];c&&this.vertexArrayBindings.disposeVAO(c.object)}n._vaos={},n.created=!1,this.properties.delete(r)}});var jt=new Fe;jt.image={data:new Uint8Array([1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1]),width:2,height:2},jt.magFilter=_.NEAREST,jt.minFilter=_.NEAREST,jt.generateMipmaps=!1,jt.version++;var Wt=new Fe;Wt.image={data:null,width:2,height:2},Wt.version++,Wt.type=y.FLOAT_32_UNSIGNED_INT_24_8_REV,Wt.format=x.DEPTH_STENCIL,Wt.internalformat=x.DEPTH32F_STENCIL8,Wt.magFilter=_.NEAREST,Wt.minFilter=_.NEAREST,Wt.compare=p.LESS,Wt.generateMipmaps=!1,Wt.version++;var Xt=new De,Yt=new Ue;function qt(){this.seq=[],this.map={}}function Zt(e,t){if(e.length===t.length){for(var r=0,n=e.length;r<n;r++)if(e[r]!==t[r])return;return 1}}function Kt(e,t){for(var r=0,n=t.length;r<n;r++)e[r]=t[r]}var Qt=[];function $t(e,t){var r=Qt[t];void 0===r&&(r=new Int32Array(t),Qt[t]=r);for(var n=0;n!==t;++n)r[n]=e.allocTexUnit();return r}function Jt(e,t){var a=e.gl,s=e.type,o=e.location,h=e.cache;switch(s){case w.FLOAT:e.setValue=function(e){h[0]!==e&&(a.uniform1f(o,e),h[0]=e)},e.set=t?function(e){Zt(h,e)||(a.uniform1fv(o,e),Kt(h,e))}:e.setValue;break;case w.SAMPLER_2D:case w.SAMPLER_2D_SHADOW:e.setValue=function(e,t){var r=t.allocTexUnit();t.texture.setTexture2D(e||(s===w.SAMPLER_2D_SHADOW?Wt:jt),r),h[0]!==r&&(a.uniform1i(o,r),h[0]=r)},e.set=t?function(e,t){for(var r=e.length,n=$t(t,r),i=0;i!==r;++i)t.texture.setTexture2D(e[i]||(s===w.SAMPLER_2D_SHADOW?Wt:jt),n[i]);Zt(h,n)||(a.uniform1iv(o,n),Kt(h,n))}:e.setValue;break;case w.SAMPLER_CUBE:case w.SAMPLER_CUBE_SHADOW:e.setValue=function(e,t){var r=t.allocTexUnit();t.texture.setTextureCube(e||Yt,r),h[0]!==r&&(a.uniform1i(o,r),h[0]=r)},e.set=t?function(e,t){for(var r=e.length,n=$t(t,r),i=0;i!==r;++i)t.texture.setTextureCube(e[i]||Yt,n[i]);Zt(h,n)||(a.uniform1iv(o,n),Kt(h,n))}:e.setValue;break;case w.SAMPLER_3D:e.setValue=function(e,t){var r=t.allocTexUnit();t.texture.setTexture3D(e||Xt,r),h[0]!==r&&(a.uniform1i(o,r),h[0]=r)},e.set=t?function(e,t){for(var r=e.length,n=$t(t,r),i=0;i!==r;++i)t.texture.setTexture3D(e[i]||Xt,n[i]);Zt(h,n)||(a.uniform1iv(o,n),Kt(h,n))}:e.setValue;break;case w.BOOL:case w.INT:e.setValue=function(e){h[0]!==e&&(a.uniform1i(o,e),h[0]=e)},e.set=t?function(e){Zt(h,e)||(a.uniform1iv(o,e),Kt(h,e))}:e.setValue;break;case w.FLOAT_VEC2:e.setValue=function(e,t){h[0]===e&&h[1]===t||(a.uniform2f(o,e,t),h[0]=e,h[1]=t)},e.set=function(e){Zt(h,e)||(a.uniform2fv(o,e),Kt(h,e))};break;case w.BOOL_VEC2:case w.INT_VEC2:e.setValue=function(e,t){h[0]===e&&h[1]===t||(a.uniform2i(o,e,t),h[0]=e,h[1]=t)},e.set=function(e){Zt(h,e)||(a.uniform2iv(o,e),Kt(h,e))};break;case w.FLOAT_VEC3:e.setValue=function(e,t,r){h[0]===e&&h[1]===t&&h[2]===r||(a.uniform3f(o,e,t,r),h[0]=e,h[1]=t,h[2]=r)},e.set=function(e){Zt(h,e)||(a.uniform3fv(o,e),Kt(h,e))};break;case w.BOOL_VEC3:case w.INT_VEC3:e.setValue=function(e,t,r){h[0]===e&&h[1]===t&&h[2]===r||(a.uniform3i(o,e,t,r),h[0]=e,h[1]=t,h[2]=r)},e.set=function(e){Zt(h,e)||(a.uniform3iv(o,e),Kt(h,e))};break;case w.FLOAT_VEC4:e.setValue=function(e,t,r,n){h[0]===e&&h[1]===t&&h[2]===r&&h[3]===n||(a.uniform4f(o,e,t,r,n),h[0]=e,h[1]=t,h[2]=r,h[3]=n)},e.set=function(e){Zt(h,e)||(a.uniform4fv(o,e),Kt(h,e))};break;case w.BOOL_VEC4:case w.INT_VEC4:e.setValue=function(e,t,r,n){h[0]===e&&h[1]===t&&h[2]===r&&h[3]===n||(a.uniform4i(o,e,t,r,n),h[0]=e,h[1]=t,h[2]=r,h[3]=n)},e.set=function(e){Zt(h,e)||(a.uniform4iv(o,e),Kt(h,e))};break;case w.FLOAT_MAT2:e.setValue=e.set=function(e){Zt(h,e)||(a.uniformMatrix2fv(o,!1,e),Kt(h,e))};break;case w.FLOAT_MAT3:e.setValue=e.set=function(e){Zt(h,e)||(a.uniformMatrix3fv(o,!1,e),Kt(h,e))};break;case w.FLOAT_MAT4:e.setValue=e.set=function(e){Zt(h,e)||(a.uniformMatrix4fv(o,!1,e),Kt(h,e))}}}function er(e,t,r,n){this.gl=e,this.id=t,this.type=r.type,this.location=n,this.setValue=void 0,this.set=void 0,this.cache=[],Jt(this)}function tr(e,t,r,n){this.gl=e,this.id=t,this.type=r.type,this.size=r.size,this.location=n,this.setValue=void 0,this.set=void 0,this.cache=[],Jt(this,!0)}function rr(e){this.id=e,qt.call(this)}rr.prototype.set=function(e,t){for(var r=this.seq,n=0,i=r.length;n!==i;++n){var a=r[n];a.set(e[a.id],t)}};var nr=/([\w\d_]+)(\])?(\[|\.)?/g;function ir(e,t){e.seq.push(t),e.map[t.id]=t}function ar(e,t){qt.call(this);for(var r=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=0;n<r;++n){var i=e.getActiveUniform(t,n),a=e.getUniformLocation(t,i.name);!function(e,t,r,n){var i=t.name,a=i.length;for(nr.lastIndex=0;;){var s=nr.exec(i),o=nr.lastIndex,h=s[1],c="]"===s[2],u=s[3];if(c&&(h|=0),void 0===u||"["===u&&o+2===a){ir(n,new(void 0===u?er:tr)(e,h,t,r));break}var l=n.map[h];void 0===l&&ir(n,l=new rr(h)),n=l}}(e,i,a,this)}}function sr(e,t,r){this.gl=e,this.name=r.name,this.type=r.type,this.size=r.size,this.location=e.getAttribLocation(t,this.name),this.count=0,this.initCount(e),this.format=e.FLOAT,this.initFormat(e)}function or(e,t,r){var n=e.createShader(t);return e.shaderSource(n,r),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)||console.warn("shader not compiled!",e.getShaderInfoLog(n),function(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+": "+t[r];return t.join("\n")}(r)),n}ar.prototype.set=function(e,t,r){var n=this.map[e];void 0!==n&&n.set(t,r)},ar.prototype.has=function(e){return!!this.map[e]},Object.assign(sr.prototype,{initCount:function(e){switch(this.type){case T.FLOAT:case T.BYTE:case T.UNSIGNED_BYTE:case T.UNSIGNED_SHORT:this.count=1;break;case T.FLOAT_VEC2:this.count=2;break;case T.FLOAT_VEC3:this.count=3;break;case T.FLOAT_VEC4:this.count=4}},initFormat:function(e){switch(this.type){case T.FLOAT:case T.FLOAT_VEC2:case T.FLOAT_VEC3:case T.FLOAT_VEC4:this.format=e.FLOAT;break;case T.UNSIGNED_BYTE:this.format=e.UNSIGNED_BYTE;break;case T.UNSIGNED_SHORT:this.format=e.UNSIGNED_SHORT;break;case T.BYTE:this.format=e.BYTE}}});var hr=0;function cr(e,t,r){this.id=hr++,this.usedTimes=1,this.code="",this.gl=e,this.vshaderSource=t,this.fshaderSource=r;var n,i,a,s,o=or(e,e.VERTEX_SHADER,this.vshaderSource),h=or(e,e.FRAGMENT_SHADER,this.fshaderSource);this.program=(i=o,a=h,s=(n=e).createProgram(),n.attachShader(s,i),n.attachShader(s,a),n.linkProgram(s),n.getProgramParameter(s,n.LINK_STATUS)||console.warn("program not linked!",n.getProgramInfoLog(s)),s),this.uniforms=new ar(e,this.program),this.attributes=function(e,t){for(var r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;i++){var a=e.getActiveAttrib(t,i),s=a.name,o=new sr(e,t,a);r[s]=o}return r}(e,this.program),e.deleteShader(o),e.deleteShader(h)}cr.prototype.dispose=function(){this.gl.deleteProgram(this.program),this.program=void 0};var ur={alphaTest_frag:"#ifdef ALPHATEST\r\n\r\n\tif ( outColor.a < ALPHATEST ) {\r\n\t\tdiscard;\r\n\t} else {\r\n\t\t// Prevent alpha test edge gradient\r\n\t\toutColor.a = u_Opacity;\r\n\t}\r\n\r\n#endif",ambientlight_pars_frag:"uniform vec3 u_AmbientLightColor;",aoMap_pars_frag:"#ifdef USE_AOMAP\r\n\r\n\tuniform sampler2D aoMap;\r\n\tuniform float aoMapIntensity;\r\n\r\n#endif",begin_frag:"vec4 outColor = vec4(u_Color, u_Opacity);",begin_vert:"vec3 transformed = vec3(a_Position);\r\n#if defined(USE_NORMAL) || defined(USE_ENV_MAP)\r\n    vec3 objectNormal = vec3(a_Normal);\r\n#endif\r\n#ifdef USE_TANGENT\r\n    vec3 objectTangent = vec3(a_Tangent.xyz);\r\n#endif",bsdfs:'// diffuse just use lambert\r\n\r\nvec4 BRDF_Diffuse_Lambert(vec4 diffuseColor) {\r\n    return RECIPROCAL_PI * diffuseColor;\r\n}\r\n\r\n// specular use Cook-Torrance microfacet model, http://ruh.li/GraphicsCookTorrance.html\r\n// About RECIPROCAL_PI: referenced by http://www.joshbarczak.com/blog/?p=272\r\n\r\nvec4 F_Schlick( const in vec4 specularColor, const in float dotLH ) {\r\n\t// Original approximation by Christophe Schlick \'94\r\n\tfloat fresnel = pow( 1.0 - dotLH, 5.0 );\r\n\r\n\t// Optimized variant (presented by Epic at SIGGRAPH \'13)\r\n\t// float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\r\n\r\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\r\n}\r\n\r\n// use blinn phong instead of phong\r\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\r\n    // ( shininess * 0.5 + 1.0 ), three.js do this, but why ???\r\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\r\n}\r\n\r\nfloat G_BlinnPhong_Implicit( ) {\r\n\t// geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\r\n\treturn 0.25;\r\n}\r\n\r\nvec4 BRDF_Specular_BlinnPhong(vec4 specularColor, vec3 N, vec3 L, vec3 V, float shininess) {\r\n    vec3 H = normalize(L + V);\r\n\r\n    float dotNH = saturate(dot(N, H));\r\n    float dotLH = saturate(dot(L, H));\r\n\r\n    vec4 F = F_Schlick(specularColor, dotLH);\r\n\r\n    float G = G_BlinnPhong_Implicit( );\r\n\r\n    float D = D_BlinnPhong(shininess, dotNH);\r\n\r\n    return F * G * D;\r\n}\r\n\r\n// Microfacet Models for Refraction through Rough Surfaces - equation (33)\r\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\r\n// alpha is "roughness squared" in Disneys reparameterization\r\nfloat D_GGX( const in float alpha, const in float dotNH ) {\r\n\r\n\tfloat a2 = pow2( alpha );\r\n\r\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1\r\n\r\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\r\n\r\n}\r\n\r\n// Microfacet Models for Refraction through Rough Surfaces - equation (34)\r\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\r\n// alpha is "roughness squared" in Disneys reparameterization\r\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\r\n\r\n\t// geometry term = G(l)G(v) / 4(nl)(nv)\r\n\r\n\tfloat a2 = pow2( alpha );\r\n\r\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\r\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\r\n\r\n\treturn 1.0 / ( gl * gv );\r\n\r\n}\r\n\r\n// Moving Frostbite to Physically Based Rendering 2.0 - page 12, listing 2\r\n// http://www.frostbite.com/wp-content/uploads/2014/11/course_notes_moving_frostbite_to_pbr_v2.pdf\r\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\r\n\r\n\tfloat a2 = pow2( alpha );\r\n\r\n\t// dotNL and dotNV are explicitly swapped. This is not a mistake.\r\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\r\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\r\n\r\n\treturn 0.5 / max( gv + gl, EPSILON );\r\n}\r\n\r\n// GGX Distribution, Schlick Fresnel, GGX-Smith Visibility\r\nvec4 BRDF_Specular_GGX(vec4 specularColor, vec3 N, vec3 L, vec3 V, float roughness) {\r\n\r\n\tfloat alpha = pow2( roughness ); // UE4\'s roughness\r\n\r\n\tvec3 H = normalize(L + V);\r\n\r\n\tfloat dotNL = saturate( dot(N, L) );\r\n\tfloat dotNV = saturate( dot(N, V) );\r\n\tfloat dotNH = saturate( dot(N, H) );\r\n\tfloat dotLH = saturate( dot(L, H) );\r\n\r\n\tvec4 F = F_Schlick( specularColor, dotLH );\r\n\r\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\r\n\r\n\tfloat D = D_GGX( alpha, dotNH );\r\n\r\n\treturn F * G * D;\r\n\r\n}\r\n\r\n// ref: https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile\r\nvec4 BRDF_Specular_GGX_Environment( const in vec3 N, const in vec3 V, const in vec4 specularColor, const in float roughness ) {\r\n\r\n\tfloat dotNV = saturate( dot( N, V ) );\r\n\r\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\r\n\r\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\r\n\r\n\tvec4 r = roughness * c0 + c1;\r\n\r\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\r\n\r\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\r\n\r\n\treturn specularColor * AB.x + AB.y;\r\n\r\n}\r\n\r\n// source: http://simonstechblog.blogspot.ca/2011/12/microfacet-brdf.html\r\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\r\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\r\n}\r\n\r\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\r\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\r\n}',bumpMap_pars_frag:"#ifdef USE_BUMPMAP\r\n\r\n\tuniform sampler2D bumpMap;\r\n\tuniform float bumpScale;\r\n\r\n\t// Derivative maps - bump mapping unparametrized surfaces by Morten Mikkelsen\r\n\t// http://mmikkelsen3d.blogspot.sk/2011/07/derivative-maps.html\r\n\r\n\t// Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)\r\n\r\n\tvec2 dHdxy_fwd(vec2 uv) {\r\n\r\n\t\tvec2 dSTdx = dFdx( uv );\r\n\t\tvec2 dSTdy = dFdy( uv );\r\n\r\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, uv ).x;\r\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, uv + dSTdx ).x - Hll;\r\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, uv + dSTdy ).x - Hll;\r\n\r\n\t\treturn vec2( dBx, dBy );\r\n\r\n\t}\r\n\r\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy) {\r\n\r\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\r\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\r\n\t\tvec3 vN = surf_norm;\t\t// normalized\r\n\r\n\t\tvec3 R1 = cross( vSigmaY, vN );\r\n\t\tvec3 R2 = cross( vN, vSigmaX );\r\n\r\n\t\tfloat fDet = dot( vSigmaX, R1 );\r\n\r\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n\r\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\r\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\r\n\r\n\t}\r\n\r\n#endif\r\n",clippingPlanes_frag:"#if NUM_CLIPPING_PLANES > 0\r\n\r\n    vec4 plane;\r\n\r\n    #pragma unroll_loop\r\n    for ( int i = 0; i < NUM_CLIPPING_PLANES; i ++ ) {\r\n\r\n        plane = clippingPlanes[ i ];\r\n        if ( dot( -v_modelPos, plane.xyz ) > plane.w ) discard;\r\n\r\n    }\r\n\r\n#endif",clippingPlanes_pars_frag:"#if NUM_CLIPPING_PLANES > 0\r\n    uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\r\n#endif",color_frag:"#ifdef USE_VCOLOR_RGB\r\n    outColor.rgb *= v_Color;\r\n#endif\r\n#ifdef USE_VCOLOR_RGBA\r\n    outColor *= v_Color;\r\n#endif",color_pars_frag:"#ifdef USE_VCOLOR_RGB\r\n    varying vec3 v_Color;\r\n#endif\r\n#ifdef USE_VCOLOR_RGBA\r\n    varying vec4 v_Color;\r\n#endif",color_pars_vert:"#ifdef USE_VCOLOR_RGB\r\n    attribute vec3 a_Color;\r\n    varying vec3 v_Color;\r\n#endif\r\n#ifdef USE_VCOLOR_RGBA\r\n    attribute vec4 a_Color;\r\n    varying vec4 v_Color;\r\n#endif",color_vert:"#if defined(USE_VCOLOR_RGB) || defined(USE_VCOLOR_RGBA)\r\n    v_Color = a_Color;\r\n#endif",common_frag:"uniform mat4 u_View;\r\n\r\nuniform float u_Opacity;\r\nuniform vec3 u_Color;\r\n\r\nuniform vec3 u_CameraPosition;",common_vert:"attribute vec3 a_Position;\r\nattribute vec3 a_Normal;\r\n#ifdef USE_TANGENT\r\n\tattribute vec4 a_Tangent;\r\n#endif\r\n\r\n#include <transpose>\r\n#include <inverse>\r\n\r\nuniform mat4 u_Projection;\r\nuniform mat4 u_View;\r\nuniform mat4 u_Model;\r\n\r\nuniform vec3 u_CameraPosition;\r\n\r\n#ifdef USE_MORPHTARGETS\r\n\r\n    attribute vec3 morphTarget0;\r\n    attribute vec3 morphTarget1;\r\n    attribute vec3 morphTarget2;\r\n    attribute vec3 morphTarget3;\r\n\r\n    #ifdef USE_MORPHNORMALS\r\n\r\n    \tattribute vec3 morphNormal0;\r\n    \tattribute vec3 morphNormal1;\r\n    \tattribute vec3 morphNormal2;\r\n    \tattribute vec3 morphNormal3;\r\n\r\n    #else\r\n\r\n    \tattribute vec3 morphTarget4;\r\n    \tattribute vec3 morphTarget5;\r\n    \tattribute vec3 morphTarget6;\r\n    \tattribute vec3 morphTarget7;\r\n\r\n    #endif\r\n\r\n#endif",diffuseMap_frag:"#ifdef USE_DIFFUSE_MAP\r\n    #if (USE_DIFFUSE_MAP == 1)\r\n        vec4 texelColor = texture2D( diffuseMap, v_Uv );\r\n    #elif (USE_DIFFUSE_MAP == 2)\r\n        vec4 texelColor = texture2D( diffuseMap, v_Uv2 );\r\n    #else \r\n        vec4 texelColor = texture2D( diffuseMap, v_Uv );\r\n    #endif\r\n    \r\n    texelColor = mapTexelToLinear( texelColor );\r\n\r\n    outColor *= texelColor;\r\n#endif",diffuseMap_pars_frag:"#ifdef USE_DIFFUSE_MAP\r\n    uniform sampler2D diffuseMap;\r\n#endif",directlight_pars_frag:"struct DirectLight\r\n{\r\n    vec3 direction;\r\n    vec4 color;\r\n\r\n    int shadow;\r\n    float shadowBias;\r\n    float shadowRadius;\r\n    vec2 shadowMapSize;\r\n};\r\nuniform DirectLight u_Directional[NUM_DIR_LIGHTS];",emissiveMap_frag:"#ifdef USE_EMISSIVEMAP\r\n\r\n\t#if (USE_EMISSIVEMAP == 1)\r\n\t\tvec4 emissiveColor = texture2D(emissiveMap, v_Uv);\r\n\t#elif (USE_EMISSIVEMAP == 2)\r\n        vec4 emissiveColor = texture2D(emissiveMap, v_Uv2);\r\n    #else \r\n        vec4 emissiveColor = texture2D(emissiveMap, v_Uv);\r\n    #endif\r\n\r\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\r\n\r\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\r\n\r\n#endif",emissiveMap_pars_frag:"#ifdef USE_EMISSIVEMAP\r\n\r\n\tuniform sampler2D emissiveMap;\r\n\r\n#endif",encodings_frag:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_frag:"// For a discussion of what this is, please read this: http://lousodrome.net/blog/light/2013/05/26/gamma-correct-and-hdr-rendering-in-a-32-bits-buffer/\r\n\r\nvec4 LinearToLinear( in vec4 value ) {\r\n\treturn value;\r\n}\r\n\r\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\r\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\r\n}\r\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\r\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\r\n}\r\n\r\nvec4 sRGBToLinear( in vec4 value ) {\r\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\r\n}\r\nvec4 LinearTosRGB( in vec4 value ) {\r\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\r\n}\r\n\r\nvec4 RGBEToLinear( in vec4 value ) {\r\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\r\n}\r\nvec4 LinearToRGBE( in vec4 value ) {\r\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\r\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\r\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\r\n//  return vec4( value.brg, ( 3.0 + 128.0 ) / 256.0 );\r\n}\r\n\r\n// reference: http://iwasbeingirony.blogspot.ca/2010/06/difference-between-rgbm-and-rgbd.html\r\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\r\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\r\n}\r\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\r\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\r\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\r\n\tM            = ceil( M * 255.0 ) / 255.0;\r\n\treturn vec4( value.rgb / ( M * maxRange ), M );\r\n}\r\n\r\n// reference: http://iwasbeingirony.blogspot.ca/2010/06/difference-between-rgbm-and-rgbd.html\r\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\r\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\r\n}\r\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\r\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\r\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\r\n\tD            = min( floor( D ) / 255.0, 1.0 );\r\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\r\n}\r\n\r\n// LogLuv reference: http://graphicrants.blogspot.ca/2009/04/rgbm-color-encoding.html\r\n\r\n// M matrix, for encoding\r\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\r\nvec4 LinearToLogLuv( in vec4 value )  {\r\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\r\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\r\n\tvec4 vResult;\r\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\r\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\r\n\tvResult.w = fract(Le);\r\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\r\n\treturn vResult;\r\n}\r\n\r\n// Inverse M matrix, for decoding\r\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\r\nvec4 LogLuvToLinear( in vec4 value ) {\r\n\tfloat Le = value.z * 255.0 + value.w;\r\n\tvec3 Xp_Y_XYZp;\r\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\r\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\r\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\r\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\r\n\treturn vec4( max(vRGB, 0.0), 1.0 );\r\n}\r\n",end_frag:"gl_FragColor = outColor;",envMap_frag:"#ifdef USE_ENV_MAP\r\n\r\n    vec3 envDir;\r\n    #if defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP)\r\n        envDir = reflect(normalize(v_worldPos - u_CameraPosition), N);\r\n    #else\r\n        envDir = v_EnvPos;\r\n    #endif\r\n\r\n    vec4 envColor = textureCube(envMap, envDir);\r\n\r\n    envColor = envMapTexelToLinear( envColor );\r\n\r\n    #ifdef ENVMAP_BLENDING_MULTIPLY\r\n\t\toutColor = mix(outColor, envColor * outColor, u_EnvMap_Intensity);\r\n\t#elif defined( ENVMAP_BLENDING_MIX )\r\n\t\toutColor = mix(outColor, envColor, u_EnvMap_Intensity);\r\n\t#elif defined( ENVMAP_BLENDING_ADD )\r\n\t\toutColor += envColor * u_EnvMap_Intensity;\r\n\t#endif\r\n#endif",envMap_pars_frag:"#ifdef USE_ENV_MAP\r\n    #if defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP)\r\n        varying vec3 v_worldPos;\r\n    #else\r\n        varying vec3 v_EnvPos;\r\n    #endif\r\n    uniform samplerCube envMap;\r\n    uniform float u_EnvMap_Intensity;\r\n    uniform int maxMipLevel;\r\n#endif",envMap_pars_vert:"#ifdef USE_ENV_MAP\r\n    #if defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP)\r\n        varying vec3 v_worldPos;\r\n    #else\r\n        varying vec3 v_EnvPos;\r\n    #endif\r\n#endif",envMap_vert:"#ifdef USE_ENV_MAP\r\n    #if defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP)\r\n        v_worldPos = (u_Model * vec4(transformed, 1.0)).xyz;\r\n    #else\r\n        v_EnvPos = reflect(normalize((u_Model * vec4(transformed, 1.0)).xyz - u_CameraPosition), (transposeMat4(inverseMat4(u_Model)) * vec4(objectNormal, 1.0)).xyz);\r\n    #endif\r\n#endif",fog_frag:"#ifdef USE_FOG\r\n\r\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\r\n\r\n    #ifdef USE_EXP2_FOG\r\n\r\n        float fogFactor = whiteCompliment( exp2( - u_FogDensity * u_FogDensity * depth * depth * LOG2 ) );\r\n\r\n    #else\r\n\r\n        float fogFactor = smoothstep( u_FogNear, u_FogFar, depth );\r\n\r\n    #endif\r\n\r\n    gl_FragColor.rgb = mix( gl_FragColor.rgb, u_FogColor, fogFactor );\r\n\r\n#endif",fog_pars_frag:"#ifdef USE_FOG\r\n\r\n    uniform vec3 u_FogColor;\r\n\r\n    #ifdef USE_EXP2_FOG\r\n\r\n        uniform float u_FogDensity;\r\n\r\n    #else\r\n\r\n        uniform float u_FogNear;\r\n        uniform float u_FogFar;\r\n    #endif\r\n\r\n#endif",inverse:"mat4 inverseMat4(mat4 m) {\r\n    float\r\n    a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\r\n    a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\r\n    a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\r\n    a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\r\n    b00 = a00 * a11 - a01 * a10,\r\n    b01 = a00 * a12 - a02 * a10,\r\n    b02 = a00 * a13 - a03 * a10,\r\n    b03 = a01 * a12 - a02 * a11,\r\n    b04 = a01 * a13 - a03 * a11,\r\n    b05 = a02 * a13 - a03 * a12,\r\n    b06 = a20 * a31 - a21 * a30,\r\n    b07 = a20 * a32 - a22 * a30,\r\n    b08 = a20 * a33 - a23 * a30,\r\n    b09 = a21 * a32 - a22 * a31,\r\n    b10 = a21 * a33 - a23 * a31,\r\n    b11 = a22 * a33 - a23 * a32,\r\n    det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\r\n    return mat4(\r\n        a11 * b11 - a12 * b10 + a13 * b09,\r\n        a02 * b10 - a01 * b11 - a03 * b09,\r\n        a31 * b05 - a32 * b04 + a33 * b03,\r\n        a22 * b04 - a21 * b05 - a23 * b03,\r\n        a12 * b08 - a10 * b11 - a13 * b07,\r\n        a00 * b11 - a02 * b08 + a03 * b07,\r\n        a32 * b02 - a30 * b05 - a33 * b01,\r\n        a20 * b05 - a22 * b02 + a23 * b01,\r\n        a10 * b10 - a11 * b08 + a13 * b06,\r\n        a01 * b08 - a00 * b10 - a03 * b06,\r\n        a30 * b04 - a31 * b02 + a33 * b00,\r\n        a21 * b02 - a20 * b04 - a23 * b00,\r\n        a11 * b07 - a10 * b09 - a12 * b06,\r\n        a00 * b09 - a01 * b07 + a02 * b06,\r\n        a31 * b01 - a30 * b03 - a32 * b00,\r\n        a20 * b03 - a21 * b01 + a22 * b00) / det;\r\n}",light_frag:"#ifdef USE_LIGHT\r\n    vec4 light;\r\n    vec3 L;\r\n\r\n    vec4 totalReflect = vec4(0., 0., 0., 0.); // direct light\r\n\r\n    // https://computergraphics.stackexchange.com/questions/7503/what-is-the-difference-between-radiance-and-irradiance-in-brdf\r\n    vec3 indirectIrradiance = vec3(0., 0., 0.); // for indirect diffuse\r\n    vec3 indirectRadiance = vec3(0., 0., 0.); // for indirect specular\r\n\r\n    #ifdef USE_PBR\r\n        #ifdef USE_PBR2\r\n            vec4 diffuseColor = outColor.xyzw;\r\n            vec4 specularColor = vec4(specularFactor.rgb, 1.);\r\n\t\t\tfloat roughness = clamp(1.0 - glossinessFactor, 0.04, 1.0);\r\n         #else\r\n            vec4 diffuseColor = outColor.xyzw * (1.0 - metalnessFactor);\r\n            vec4 specularColor = mix(vec4(0.04), outColor.xyzw, metalnessFactor);\r\n            float roughness = clamp(roughnessFactor, 0.04, 1.0);\r\n         #endif\r\n    #else\r\n        vec4 diffuseColor = outColor.xyzw;\r\n        #ifdef USE_PHONG\r\n            vec4 specularColor = vec4(u_SpecularColor, 1.);\r\n            float shininess = u_Specular;\r\n        #endif\r\n    #endif\r\n\r\n    #ifdef USE_AMBIENT_LIGHT\r\n        indirectIrradiance += u_AmbientLightColor;\r\n    #endif\r\n\r\n    // TODO light map\r\n\r\n    #ifdef USE_PBR\r\n        #ifdef USE_ENV_MAP\r\n    \t\tvec3 envDir;\r\n    \t    #if defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP)\r\n    \t        envDir = reflect(normalize(v_worldPos - u_CameraPosition), N);\r\n    \t    #else\r\n    \t        envDir = v_EnvPos;\r\n    \t    #endif\r\n            indirectIrradiance += getLightProbeIndirectIrradiance(maxMipLevel, envDir);\r\n            indirectRadiance += getLightProbeIndirectRadiance(GGXRoughnessToBlinnExponent(roughness), maxMipLevel, envDir);\r\n    \t#endif\r\n    #endif\r\n\r\n    #if (defined(USE_PHONG) || defined(USE_PBR))\r\n        vec3 V = normalize( u_CameraPosition - v_modelPos );\r\n    #endif\r\n\r\n    float dotNL;\r\n    vec4 irradiance;\r\n    vec4 reflectLight;\r\n    float dist;\r\n\r\n    #if NUM_DIR_LIGHTS > 0\r\n\r\n        #pragma unroll_loop\r\n        for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n            L = -u_Directional[ i ].direction;\r\n            light = u_Directional[ i ].color;\r\n            L = normalize(L);\r\n\r\n            dotNL = saturate( dot(N, L) );\r\n            irradiance = light * dotNL;\r\n\r\n            #if NUM_DIR_SHADOWS > 0\r\n                #ifdef USE_PCSS_SOFT_SHADOW\r\n                    irradiance *= bool( u_Directional[ i ].shadow ) ? getShadowWithPCSS( directionalDepthMap[ i ], directionalShadowMap[ i ], vDirectionalShadowCoord[ i ], u_Directional[ i ].shadowBias, u_Directional[ i ].shadowRadius, u_Directional[ i ].shadowMapSize ) : 1.0;\r\n                #else\r\n                    irradiance *= bool( u_Directional[ i ].shadow ) ? getShadow( directionalShadowMap[ i ], vDirectionalShadowCoord[ i ], u_Directional[ i ].shadowBias, u_Directional[ i ].shadowRadius, u_Directional[ i ].shadowMapSize ) : 1.0;\r\n                #endif\r\n            #endif\r\n\r\n            // #ifndef USE_PBR\r\n            //     irradiance *= PI;\r\n            // #endif\r\n\r\n            reflectLight = irradiance * BRDF_Diffuse_Lambert(diffuseColor);\r\n\r\n            #ifdef USE_PHONG\r\n                reflectLight += irradiance * BRDF_Specular_BlinnPhong(specularColor, N, L, V, shininess) * specularStrength;\r\n            #endif\r\n\r\n            #ifdef USE_PBR\r\n                reflectLight += irradiance * BRDF_Specular_GGX(specularColor, N, L, V, roughness);\r\n            #endif\r\n\r\n            totalReflect += reflectLight;\r\n        }\r\n\r\n    #endif\r\n\r\n    #if NUM_POINT_LIGHTS > 0\r\n        vec3 worldV;\r\n\r\n        #pragma unroll_loop\r\n        for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\r\n            L = u_Point[ i ].position - v_modelPos;\r\n            dist = pow(clamp(1. - length(L) / u_Point[ i ].distance, 0.0, 1.0), u_Point[ i ].decay);\r\n            light = u_Point[ i ].color * dist;\r\n            L = normalize(L);\r\n\r\n            dotNL = saturate( dot(N, L) );\r\n            irradiance = light * dotNL;\r\n\r\n            // #ifndef USE_PBR\r\n            //     irradiance *= PI;\r\n            // #endif\r\n\r\n            #if NUM_POINT_SHADOWS > 0\r\n                worldV = v_modelPos - u_Point[ i ].position;\r\n                irradiance *= bool( u_Point[ i ].shadow ) ? getPointShadow( pointShadowMap[ i ], worldV, u_Point[ i ].shadowBias, u_Point[ i ].shadowRadius, u_Point[ i ].shadowMapSize, u_Point[ i ].shadowCameraNear, u_Point[ i ].shadowCameraFar ) : 1.0;\r\n            #endif\r\n\r\n            reflectLight = irradiance * BRDF_Diffuse_Lambert(diffuseColor);\r\n\r\n            #ifdef USE_PHONG\r\n                reflectLight += irradiance * BRDF_Specular_BlinnPhong(specularColor, N, L, V, shininess) * specularStrength;\r\n            #endif\r\n\r\n            #ifdef USE_PBR\r\n                reflectLight += irradiance * BRDF_Specular_GGX(specularColor, N, L, V, roughness);\r\n            #endif\r\n\r\n            totalReflect += reflectLight;\r\n        }\r\n\r\n    #endif\r\n\r\n    #if NUM_SPOT_LIGHTS > 0\r\n        float lightDistance;\r\n        float angleCos;\r\n        float spotEffect;\r\n\r\n        #pragma unroll_loop\r\n        for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\r\n            L = u_Spot[ i ].position - v_modelPos;\r\n            lightDistance = length(L);\r\n            L = normalize(L);\r\n            angleCos = dot( L, -normalize(u_Spot[ i ].direction) );\r\n\r\n            if( all( bvec2(angleCos > u_Spot[ i ].coneCos, lightDistance < u_Spot[ i ].distance) ) ) {\r\n\r\n                spotEffect = smoothstep( u_Spot[ i ].coneCos, u_Spot[ i ].penumbraCos, angleCos );\r\n                dist = pow(clamp(1. - lightDistance / u_Spot[ i ].distance, 0.0, 1.0), u_Spot[ i ].decay);\r\n                light = u_Spot[ i ].color * dist * spotEffect;\r\n\r\n                dotNL = saturate( dot(N, L) );\r\n                irradiance = light * dotNL;\r\n\r\n                // #ifndef USE_PBR\r\n                //     irradiance *= PI;\r\n                // #endif\r\n\r\n                #if NUM_SPOT_SHADOWS > 0\r\n                    #ifdef USE_PCSS_SOFT_SHADOW\r\n                        irradiance *= bool( u_Spot[ i ].shadow ) ? getShadowWithPCSS( spotDepthMap[ i ], spotShadowMap[ i ], vSpotShadowCoord[ i ], u_Spot[ i ].shadowBias, u_Spot[ i ].shadowRadius, u_Spot[ i ].shadowMapSize ) : 1.0;\r\n                    #else\r\n                        irradiance *= bool( u_Spot[ i ].shadow ) ? getShadow( spotShadowMap[ i ], vSpotShadowCoord[ i ], u_Spot[ i ].shadowBias, u_Spot[ i ].shadowRadius, u_Spot[ i ].shadowMapSize ) : 1.0;\r\n                    #endif\r\n                #endif\r\n\r\n                reflectLight = irradiance * BRDF_Diffuse_Lambert(diffuseColor);\r\n\r\n                #ifdef USE_PHONG\r\n                    reflectLight += irradiance * BRDF_Specular_BlinnPhong(specularColor, N, L, V, shininess) * specularStrength;\r\n                #endif\r\n\r\n                #ifdef USE_PBR\r\n                    reflectLight += irradiance * BRDF_Specular_GGX(specularColor, N, L, V, roughness);\r\n                #endif\r\n\r\n                totalReflect += reflectLight;\r\n            }\r\n\r\n        }\r\n\r\n    #endif\r\n\r\n    vec3 indirectDiffuse = indirectIrradiance * BRDF_Diffuse_Lambert(diffuseColor).rgb;\r\n    vec3 indirectSpecular = vec3(0., 0., 0.);\r\n\r\n    #if defined( USE_ENV_MAP ) && defined( USE_PBR )\r\n        indirectSpecular += indirectRadiance * BRDF_Specular_GGX_Environment(N, V, specularColor, roughness).rgb;\r\n    #endif\r\n\r\n    #ifdef USE_AOMAP\r\n\r\n        // reads channel R, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\r\n        #if (USE_AOMAP == 1)\r\n    \t    float ambientOcclusion = ( texture2D( aoMap, v_Uv ).r - 1.0 ) * aoMapIntensity + 1.0;\r\n        #elif (USE_AOMAP == 2)\r\n            float ambientOcclusion = ( texture2D( aoMap, v_Uv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\r\n        #else\r\n            float ambientOcclusion = ( texture2D( aoMap, v_Uv ).r - 1.0 ) * aoMapIntensity + 1.0;\r\n        #endif\r\n    \t\r\n    \tindirectDiffuse *= ambientOcclusion;\r\n\r\n    \t#if defined( USE_ENV_MAP ) && defined( USE_PBR )\r\n\r\n    \t\tfloat dotNV = saturate( dot( N, V ) );\r\n\r\n    \t\tindirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, GGXRoughnessToBlinnExponent(roughness) );\r\n\r\n    \t#endif\r\n\r\n    #endif\r\n\r\n    outColor.xyz = totalReflect.xyz + indirectDiffuse + indirectSpecular;\r\n#endif",light_pars_frag:"#ifdef USE_AMBIENT_LIGHT\r\n    #include <ambientlight_pars_frag>\r\n#endif\r\n#if NUM_DIR_LIGHTS > 0\r\n    #include <directlight_pars_frag>\r\n#endif\r\n#if NUM_POINT_LIGHTS > 0\r\n    #include <pointlight_pars_frag>\r\n#endif\r\n#if NUM_SPOT_LIGHTS > 0\r\n    #include <spotlight_pars_frag>\r\n#endif\r\n\r\n#if defined(USE_PBR) && defined(USE_ENV_MAP)\r\n\r\n    vec3 getLightProbeIndirectIrradiance(const in int maxMIPLevel, const in vec3 envDir) {\r\n        // TODO: replace with properly filtered cubemaps and access the irradiance LOD level, be it the last LOD level\r\n    \t// of a specular cubemap, or just the default level of a specially created irradiance cubemap.\r\n\r\n    \t#ifdef TEXTURE_LOD_EXT\r\n\r\n    \t\tvec4 envMapColor = textureCubeLodEXT( envMap, envDir, float( maxMIPLevel ) );\r\n\r\n    \t#else\r\n\r\n    \t\t// force the bias high to get the last LOD level as it is the most blurred.\r\n    \t\tvec4 envMapColor = textureCube( envMap, envDir, float( maxMIPLevel ) );\r\n\r\n    \t#endif\r\n\r\n        envMapColor = envMapTexelToLinear( envMapColor );\r\n\r\n        return PI * envMapColor.rgb * u_EnvMap_Intensity;\r\n    }\r\n\r\n    // taken from here: http://casual-effects.blogspot.ca/2011/08/plausible-environment-lighting-in-two.html\r\n    float getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\r\n\r\n    \t//float envMapWidth = pow( 2.0, maxMIPLevelScalar );\r\n    \t//float desiredMIPLevel = log2( envMapWidth * sqrt( 3.0 ) ) - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\r\n\r\n    \tfloat maxMIPLevelScalar = float( maxMIPLevel );\r\n    \tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\r\n\r\n    \t// clamp to allowable LOD ranges.\r\n    \treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\r\n\r\n    }\r\n\r\n    vec3 getLightProbeIndirectRadiance(const in float blinnShininessExponent, const in int maxMIPLevel, const in vec3 envDir) {\r\n        float specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\r\n\r\n        #ifdef TEXTURE_LOD_EXT\r\n\r\n    \t\tvec4 envMapColor = textureCubeLodEXT( envMap, envDir, specularMIPLevel );\r\n\r\n    \t#else\r\n\r\n    \t\tvec4 envMapColor = textureCube( envMap, envDir, specularMIPLevel );\r\n\r\n    \t#endif\r\n\r\n        envMapColor = envMapTexelToLinear( envMapColor );\r\n\r\n        return envMapColor.rgb * u_EnvMap_Intensity;\r\n    }\r\n\r\n    // ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\r\n    float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\r\n\r\n    \treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\r\n\r\n    }\r\n\r\n#endif",alphamap_pars_frag:"#ifdef USE_ALPHA_MAP\r\n\r\n\tuniform sampler2D alphaMap;\r\n\r\n#endif",alphamap_frag:"#ifdef USE_ALPHA_MAP\r\n\r\n\t#ifdef USE_ALPHA_MAP_UV_TRANSFORM\r\n\t\toutColor.a *= texture2D(alphaMap, vAlphaMapUV).g;\r\n\t#else\r\n\t\t#if (USE_ALPHA_MAP == 1)\r\n\t\t\toutColor.a *= texture2D(alphaMap, v_Uv).g;\r\n\t\t#elif (USE_ALPHA_MAP == 2)\r\n            outColor.a *= texture2D(alphaMap, v_Uv2).g;\r\n\t\t#else\r\n            outColor.a *= texture2D(alphaMap, v_Uv).g;\r\n        #endif\r\n\t#endif\r\n\r\n#endif",normalMap_pars_frag:"#if !defined(USE_TANGENT) || defined(FLAT_SHADED)\r\n    #include <tsn>\r\n#endif\r\nuniform sampler2D normalMap;",normal_frag:"#ifdef USE_NORMAL\r\n    #ifdef FLAT_SHADED\r\n        // Workaround for Adreno/Nexus5 not able able to do dFdx( Vec3 ) ...\r\n    \tvec3 fdx = vec3( dFdx( v_modelPos.x ), dFdx( v_modelPos.y ), dFdx( v_modelPos.z ) );\r\n    \tvec3 fdy = vec3( dFdy( v_modelPos.x ), dFdy( v_modelPos.y ), dFdy( v_modelPos.z ) );\r\n    \tvec3 N = normalize( cross( fdx, fdy ) );\r\n    #else\r\n        vec3 N = normalize(v_Normal);\r\n        #ifdef DOUBLE_SIDED\r\n            N = N * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n        #endif  \r\n    #endif\r\n    #ifdef USE_NORMAL_MAP\r\n        vec3 mapN = texture2D(normalMap, v_Uv).rgb * 2.0 - 1.0;\r\n        #if defined(USE_TANGENT) && !defined(FLAT_SHADED)\r\n            vec3 tangent = normalize(v_Tangent);\r\n            vec3 bitangent = normalize(v_Bitangent);\r\n            #ifdef DOUBLE_SIDED\r\n                tangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n                bitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n            #endif  \r\n            mat3 tspace = mat3(tangent, bitangent, N);\r\n        #else\r\n            // for now, uv coord is flip Y\r\n            mat3 tspace = tsn(N, v_modelPos, vec2(v_Uv.x, 1.0 - v_Uv.y));\r\n            mapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n        #endif\r\n        N = normalize(tspace * mapN);\r\n    #elif defined(USE_BUMPMAP)\r\n        N = perturbNormalArb(v_modelPos, N, dHdxy_fwd(v_Uv));\r\n    #endif\r\n#endif",normal_pars_frag:"#if defined(USE_NORMAL) && !defined(FLAT_SHADED)\r\n    varying vec3 v_Normal;\r\n    #ifdef USE_TANGENT\r\n        varying vec3 v_Tangent;\r\n\t\tvarying vec3 v_Bitangent;\r\n    #endif\r\n#endif",normal_pars_vert:"#if defined(USE_NORMAL) && !defined(FLAT_SHADED)\r\n    varying vec3 v_Normal;\r\n    #ifdef USE_TANGENT\r\n        varying vec3 v_Tangent;\r\n\t\tvarying vec3 v_Bitangent;\r\n    #endif\r\n#endif",normal_vert:"#if defined(USE_NORMAL) && !defined(FLAT_SHADED)\r\n    v_Normal = (transposeMat4(inverseMat4(u_Model)) * vec4(objectNormal, 0.0)).xyz;\r\n\r\n    #ifdef FLIP_SIDED\r\n    \tv_Normal = - v_Normal;\r\n    #endif\r\n\r\n    #ifdef USE_TANGENT\r\n        v_Tangent = (transposeMat4(inverseMat4(u_Model)) * vec4(objectTangent, 0.0)).xyz;\r\n\r\n        #ifdef FLIP_SIDED\r\n            v_Tangent = - v_Tangent;\r\n        #endif\r\n\r\n        v_Bitangent = normalize(cross(v_Normal, v_Tangent) * a_Tangent.w);\r\n    #endif\r\n#endif\r\n",packing:"const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\r\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\r\n\r\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\r\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\r\n\r\nconst float ShiftRight8 = 1. / 256.;\r\n\r\nvec4 packDepthToRGBA( const in float v ) {\r\n\r\n    vec4 r = vec4( fract( v * PackFactors ), v );\r\n    r.yzw -= r.xyz * ShiftRight8; // tidy overflow\r\n    return r * PackUpscale;\r\n\r\n}\r\n\r\nfloat unpackRGBAToDepth( const in vec4 v ) {\r\n\r\n    return dot( v, UnpackFactors );\r\n\r\n}",pointlight_pars_frag:"struct PointLight\r\n{\r\n    vec3 position;\r\n    vec4 color;\r\n    float distance;\r\n    float decay;\r\n\r\n    int shadow;\r\n    float shadowBias;\r\n    float shadowRadius;\r\n    vec2 shadowMapSize;\r\n\r\n    float shadowCameraNear;\r\n    float shadowCameraFar;\r\n};\r\nuniform PointLight u_Point[NUM_POINT_LIGHTS];",premultipliedAlpha_frag:"#ifdef USE_PREMULTIPLIED_ALPHA\r\n    gl_FragColor.rgb = gl_FragColor.rgb * gl_FragColor.a;\r\n#endif",pvm_vert:"gl_Position = u_Projection * u_View * u_Model * vec4(transformed, 1.0);",dithering_frag:"#if defined( DITHERING )\r\n\r\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\r\n\r\n#endif",dithering_pars_frag:"#if defined( DITHERING )\r\n\r\n\t// based on http://loopit.dk/banding_in_games.pdf\r\n\tvec3 dithering( vec3 color ) {\r\n\t\t//Calculate grid position\r\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\r\n\r\n\t\t//Shift the individual colors differently, thus making it even harder to see the dithering pattern\r\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\r\n\r\n\t\t//modify shift acording to grid position.\r\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\r\n\r\n\t\t//shift the color by dither_shift\r\n\t\treturn color + dither_shift_RGB;\r\n\t}\r\n\r\n#endif",shadow:"\r\n#ifdef WEBGL2\r\n    float computeShadow(sampler2DShadow shadowMap, vec3 shadowCoord) {\r\n        return texture2D( shadowMap, shadowCoord );\r\n    }\r\n#else\r\n    float computeShadow(sampler2D shadowMap, vec3 shadowCoord) {\r\n        return step( shadowCoord.z, unpackRGBAToDepth( texture2D( shadowMap, shadowCoord.xy ) ) );\r\n    }\r\n#endif\r\n\r\nfloat computeShadowWithPoissonSampling( sampler2DShadow shadowMap, vec3 shadowCoord, float texelSize ) {\r\n    vec3 poissonDisk[4];\r\n    poissonDisk[0] = vec3(-0.94201624, -0.39906216, 0);\r\n    poissonDisk[1] = vec3(0.94558609, -0.76890725, 0);\r\n    poissonDisk[2] = vec3(-0.094184101, -0.92938870, 0);\r\n    poissonDisk[3] = vec3(0.34495938, 0.29387760, 0);\r\n\r\n    return computeShadow( shadowMap, shadowCoord + poissonDisk[0] * texelSize ) * 0.25 +\r\n        computeShadow( shadowMap, shadowCoord + poissonDisk[1] * texelSize ) * 0.25 +\r\n        computeShadow( shadowMap, shadowCoord + poissonDisk[2] * texelSize ) * 0.25 +\r\n        computeShadow( shadowMap, shadowCoord + poissonDisk[3] * texelSize ) * 0.25;\r\n}\r\n\r\n// Shadow PCF kernel size 1 with a single tap (lowest quality)\r\nfloat computeShadowWithPCF1(sampler2DShadow shadowSampler, vec3 shadowCoord) {\r\n    return computeShadow(shadowSampler, shadowCoord);\r\n}\r\n\r\n// Shadow PCF kernel 3*3 in only 4 taps (medium quality)\r\n// This uses a well distributed taps to allow a gaussian distribution covering a 3*3 kernel\r\n// https://mynameismjp.wordpress.com/2013/09/10/shadow-maps/\r\nfloat computeShadowWithPCF3(sampler2DShadow shadowSampler, vec3 shadowCoord, vec2 shadowMapSizeAndInverse) {\r\n    vec2 uv = shadowCoord.xy * shadowMapSizeAndInverse.x;\t// uv in texel units\r\n    uv += 0.5;\t\t\t\t\t\t\t\t\t\t\t// offset of half to be in the center of the texel\r\n    vec2 st = fract(uv);\t\t\t\t\t\t\t\t// how far from the center\r\n    vec2 base_uv = floor(uv) - 0.5;\t\t\t\t\t\t// texel coord\r\n    base_uv *= shadowMapSizeAndInverse.y;\t\t\t\t// move back to uv coords\r\n\r\n    // Equation resolved to fit in a 3*3 distribution like \r\n    // 1 2 1\r\n    // 2 4 2 \r\n    // 1 2 1\r\n    vec2 uvw0 = 3. - 2. * st;\r\n    vec2 uvw1 = 1. + 2. * st;\r\n    vec2 u = vec2((2. - st.x) / uvw0.x - 1., st.x / uvw1.x + 1.) * shadowMapSizeAndInverse.y;\r\n    vec2 v = vec2((2. - st.y) / uvw0.y - 1., st.y / uvw1.y + 1.) * shadowMapSizeAndInverse.y;\r\n\r\n    float shadow = 0.;\r\n    shadow += uvw0.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[0]), shadowCoord.z));\r\n    shadow += uvw1.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[0]), shadowCoord.z));\r\n    shadow += uvw0.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[1]), shadowCoord.z));\r\n    shadow += uvw1.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[1]), shadowCoord.z));\r\n    shadow = shadow / 16.;\r\n\r\n    return shadow;\r\n}\r\n\r\n// Shadow PCF kernel 5*5 in only 9 taps (high quality)\r\n// This uses a well distributed taps to allow a gaussian distribution covering a 5*5 kernel\r\n// https://mynameismjp.wordpress.com/2013/09/10/shadow-maps/\r\nfloat computeShadowWithPCF5(sampler2DShadow shadowSampler, vec3 shadowCoord, vec2 shadowMapSizeAndInverse) {\r\n\r\n    vec2 uv = shadowCoord.xy * shadowMapSizeAndInverse.x;\t// uv in texel units\r\n    uv += 0.5;\t\t\t\t\t\t\t\t\t\t\t// offset of half to be in the center of the texel\r\n    vec2 st = fract(uv);\t\t\t\t\t\t\t\t// how far from the center\r\n    vec2 base_uv = floor(uv) - 0.5;\t\t\t\t\t\t// texel coord\r\n    base_uv *= shadowMapSizeAndInverse.y;\t\t\t\t// move back to uv coords\r\n\r\n    // Equation resolved to fit in a 5*5 distribution like \r\n    // 1 2 4 2 1\r\n    vec2 uvw0 = 4. - 3. * st;\r\n    vec2 uvw1 = vec2(7.);\r\n    vec2 uvw2 = 1. + 3. * st;\r\n\r\n    vec3 u = vec3((3. - 2. * st.x) / uvw0.x - 2., (3. + st.x) / uvw1.x, st.x / uvw2.x + 2.) * shadowMapSizeAndInverse.y;\r\n    vec3 v = vec3((3. - 2. * st.y) / uvw0.y - 2., (3. + st.y) / uvw1.y, st.y / uvw2.y + 2.) * shadowMapSizeAndInverse.y;\r\n\r\n    float shadow = 0.;\r\n    shadow += uvw0.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[0]), shadowCoord.z));\r\n    shadow += uvw1.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[0]), shadowCoord.z));\r\n    shadow += uvw2.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[2], v[0]), shadowCoord.z));\r\n    shadow += uvw0.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[1]), shadowCoord.z));\r\n    shadow += uvw1.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[1]), shadowCoord.z));\r\n    shadow += uvw2.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[2], v[1]), shadowCoord.z));\r\n    shadow += uvw0.x * uvw2.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[2]), shadowCoord.z));\r\n    shadow += uvw1.x * uvw2.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[2]), shadowCoord.z));\r\n    shadow += uvw2.x * uvw2.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[2], v[2]), shadowCoord.z));\r\n    shadow = shadow / 144.;\r\n\r\n    return shadow;\r\n}\r\n\r\nfloat getShadow( sampler2DShadow shadowMap, vec4 shadowCoord, float shadowBias, float shadowRadius, vec2 shadowMapSize ) {\r\n    shadowCoord.xyz /= shadowCoord.w;\r\n\r\n    shadowCoord.z += shadowBias;\r\n\r\n    bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\r\n    bool inFrustum = all( inFrustumVec );\r\n\r\n    bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\r\n\r\n    bool frustumTest = all( frustumTestVec );\r\n\r\n    if ( frustumTest ) {\r\n        #ifdef USE_HARD_SHADOW\r\n            return computeShadow(shadowMap, shadowCoord.xyz);\r\n        #else\r\n            #ifdef USE_PCF3_SOFT_SHADOW\r\n                vec2 shadowMapSizeAndInverse = vec2(shadowMapSize.x, 1. / shadowMapSize.x);\r\n                return computeShadowWithPCF3(shadowMap, shadowCoord.xyz, shadowMapSizeAndInverse);\r\n            #else\r\n                #ifdef USE_PCF5_SOFT_SHADOW\r\n                    vec2 shadowMapSizeAndInverse = vec2(shadowMapSize.x, 1. / shadowMapSize.x);\r\n                    return computeShadowWithPCF5(shadowMap, shadowCoord.xyz, shadowMapSizeAndInverse);\r\n                #else\r\n                    float texelSize = shadowRadius / shadowMapSize.x;\r\n                    return computeShadowWithPoissonSampling(shadowMap, shadowCoord.xyz, texelSize);\r\n                #endif\r\n            #endif\r\n        #endif\r\n    }\r\n\r\n    return 1.0;\r\n\r\n}\r\n\r\nfloat textureCubeCompare( samplerCube depths, vec3 uv, float compare ) {\r\n\r\n    return step( compare, unpackRGBAToDepth( textureCube( depths, uv ) ) );\r\n\r\n}\r\n\r\nfloat getPointShadow( samplerCube shadowMap, vec3 V, float shadowBias, float shadowRadius, vec2 shadowMapSize, float shadowCameraNear, float shadowCameraFar ) {\r\n\r\n    // depth = normalized distance from light to fragment position\r\n    float depth = ( length( V ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?\r\n    depth += shadowBias;\r\n\r\n    #ifdef USE_HARD_SHADOW\r\n        return textureCubeCompare( shadowMap, normalize(V), depth);\r\n    #else\r\n        float texelSize = shadowRadius / shadowMapSize.x;\r\n\r\n        vec3 poissonDisk[4];\r\n        poissonDisk[0] = vec3(-1.0, 1.0, -1.0);\r\n        poissonDisk[1] = vec3(1.0, -1.0, -1.0);\r\n        poissonDisk[2] = vec3(-1.0, -1.0, -1.0);\r\n        poissonDisk[3] = vec3(1.0, -1.0, 1.0);\r\n\r\n        return textureCubeCompare( shadowMap, normalize(V) + poissonDisk[0] * texelSize, depth ) * 0.25 +\r\n            textureCubeCompare( shadowMap, normalize(V) + poissonDisk[1] * texelSize, depth ) * 0.25 +\r\n            textureCubeCompare( shadowMap, normalize(V) + poissonDisk[2] * texelSize, depth ) * 0.25 +\r\n            textureCubeCompare( shadowMap, normalize(V) + poissonDisk[3] * texelSize, depth ) * 0.25;\r\n    #endif\r\n}\r\n\r\n#ifdef USE_PCSS_SOFT_SHADOW\r\n\r\n    const vec3 PoissonSamplers32[64] = vec3[64](\r\n        vec3(0.06407013, 0.05409927, 0.),\r\n        vec3(0.7366577, 0.5789394, 0.),\r\n        vec3(-0.6270542, -0.5320278, 0.),\r\n        vec3(-0.4096107, 0.8411095, 0.),\r\n        vec3(0.6849564, -0.4990818, 0.),\r\n        vec3(-0.874181, -0.04579735, 0.),\r\n        vec3(0.9989998, 0.0009880066, 0.),\r\n        vec3(-0.004920578, -0.9151649, 0.),\r\n        vec3(0.1805763, 0.9747483, 0.),\r\n        vec3(-0.2138451, 0.2635818, 0.),\r\n        vec3(0.109845, 0.3884785, 0.),\r\n        vec3(0.06876755, -0.3581074, 0.),\r\n        vec3(0.374073, -0.7661266, 0.),\r\n        vec3(0.3079132, -0.1216763, 0.),\r\n        vec3(-0.3794335, -0.8271583, 0.),\r\n        vec3(-0.203878, -0.07715034, 0.),\r\n        vec3(0.5912697, 0.1469799, 0.),\r\n        vec3(-0.88069, 0.3031784, 0.),\r\n        vec3(0.5040108, 0.8283722, 0.),\r\n        vec3(-0.5844124, 0.5494877, 0.),\r\n        vec3(0.6017799, -0.1726654, 0.),\r\n        vec3(-0.5554981, 0.1559997, 0.),\r\n        vec3(-0.3016369, -0.3900928, 0.),\r\n        vec3(-0.5550632, -0.1723762, 0.),\r\n        vec3(0.925029, 0.2995041, 0.),\r\n        vec3(-0.2473137, 0.5538505, 0.),\r\n        vec3(0.9183037, -0.2862392, 0.),\r\n        vec3(0.2469421, 0.6718712, 0.),\r\n        vec3(0.3916397, -0.4328209, 0.),\r\n        vec3(-0.03576927, -0.6220032, 0.),\r\n        vec3(-0.04661255, 0.7995201, 0.),\r\n        vec3(0.4402924, 0.3640312, 0.),\r\n\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.),\r\n        vec3(0., 0., 0.)\r\n    );\r\n\r\n    const vec3 PoissonSamplers64[64] = vec3[64](\r\n        vec3(-0.613392, 0.617481, 0.),\r\n        vec3(0.170019, -0.040254, 0.),\r\n        vec3(-0.299417, 0.791925, 0.),\r\n        vec3(0.645680, 0.493210, 0.),\r\n        vec3(-0.651784, 0.717887, 0.),\r\n        vec3(0.421003, 0.027070, 0.),\r\n        vec3(-0.817194, -0.271096, 0.),\r\n        vec3(-0.705374, -0.668203, 0.),\r\n        vec3(0.977050, -0.108615, 0.),\r\n        vec3(0.063326, 0.142369, 0.),\r\n        vec3(0.203528, 0.214331, 0.),\r\n        vec3(-0.667531, 0.326090, 0.),\r\n        vec3(-0.098422, -0.295755, 0.),\r\n        vec3(-0.885922, 0.215369, 0.),\r\n        vec3(0.566637, 0.605213, 0.),\r\n        vec3(0.039766, -0.396100, 0.),\r\n        vec3(0.751946, 0.453352, 0.),\r\n        vec3(0.078707, -0.715323, 0.),\r\n        vec3(-0.075838, -0.529344, 0.),\r\n        vec3(0.724479, -0.580798, 0.),\r\n        vec3(0.222999, -0.215125, 0.),\r\n        vec3(-0.467574, -0.405438, 0.),\r\n        vec3(-0.248268, -0.814753, 0.),\r\n        vec3(0.354411, -0.887570, 0.),\r\n        vec3(0.175817, 0.382366, 0.),\r\n        vec3(0.487472, -0.063082, 0.),\r\n        vec3(-0.084078, 0.898312, 0.),\r\n        vec3(0.488876, -0.783441, 0.),\r\n        vec3(0.470016, 0.217933, 0.),\r\n        vec3(-0.696890, -0.549791, 0.),\r\n        vec3(-0.149693, 0.605762, 0.),\r\n        vec3(0.034211, 0.979980, 0.),\r\n        vec3(0.503098, -0.308878, 0.),\r\n        vec3(-0.016205, -0.872921, 0.),\r\n        vec3(0.385784, -0.393902, 0.),\r\n        vec3(-0.146886, -0.859249, 0.),\r\n        vec3(0.643361, 0.164098, 0.),\r\n        vec3(0.634388, -0.049471, 0.),\r\n        vec3(-0.688894, 0.007843, 0.),\r\n        vec3(0.464034, -0.188818, 0.),\r\n        vec3(-0.440840, 0.137486, 0.),\r\n        vec3(0.364483, 0.511704, 0.),\r\n        vec3(0.034028, 0.325968, 0.),\r\n        vec3(0.099094, -0.308023, 0.),\r\n        vec3(0.693960, -0.366253, 0.),\r\n        vec3(0.678884, -0.204688, 0.),\r\n        vec3(0.001801, 0.780328, 0.),\r\n        vec3(0.145177, -0.898984, 0.),\r\n        vec3(0.062655, -0.611866, 0.),\r\n        vec3(0.315226, -0.604297, 0.),\r\n        vec3(-0.780145, 0.486251, 0.),\r\n        vec3(-0.371868, 0.882138, 0.),\r\n        vec3(0.200476, 0.494430, 0.),\r\n        vec3(-0.494552, -0.711051, 0.),\r\n        vec3(0.612476, 0.705252, 0.),\r\n        vec3(-0.578845, -0.768792, 0.),\r\n        vec3(-0.772454, -0.090976, 0.),\r\n        vec3(0.504440, 0.372295, 0.),\r\n        vec3(0.155736, 0.065157, 0.),\r\n        vec3(0.391522, 0.849605, 0.),\r\n        vec3(-0.620106, -0.328104, 0.),\r\n        vec3(0.789239, -0.419965, 0.),\r\n        vec3(-0.545396, 0.538133, 0.),\r\n        vec3(-0.178564, -0.596057, 0.)\r\n    );\r\n\r\n    // https://stackoverflow.com/questions/4200224/random-noise-functions-for-glsl\r\n    float getRand(vec2 seed) {\r\n        return fract(sin(dot(seed.xy ,vec2(12.9898,78.233))) * 43758.5453);\r\n    }\r\n\r\n    // PCSS\r\n    // This helps to achieve a contact hardening effect on the shadow\r\n    // It uses 16 Taps for search and a 32 PCF taps in a randomly rotating poisson sampling disc.\r\n    // This is heavily inspired from http://developer.download.nvidia.com/shaderlibrary/docs/shadow_PCSS.pdf\r\n    // and http://developer.download.nvidia.com/whitepapers/2008/PCSS_Integration.pdf\r\n    float computeShadowWithPCSS(sampler2D depthSampler, sampler2DShadow shadowSampler, vec3 shadowCoord, float shadowMapSizeInverse, float lightSizeUV, int searchTapCount, int pcfTapCount, vec3[64] poissonSamplers) {\r\n        float depthMetric = shadowCoord.z;\r\n\r\n        float blockerDepth = 0.0;\r\n        float sumBlockerDepth = 0.0;\r\n        float numBlocker = 0.0;\r\n        for (int i = 0; i < searchTapCount; i ++) {\r\n            blockerDepth = unpackRGBAToDepth( texture( depthSampler, shadowCoord.xy + (lightSizeUV * shadowMapSizeInverse * PoissonSamplers32[i].xy) ) );\r\n            if (blockerDepth < depthMetric) {\r\n                sumBlockerDepth += blockerDepth;\r\n                numBlocker++;\r\n            }\r\n        }\r\n\r\n        if (numBlocker < 1.0) {\r\n            return 1.0;\r\n        }\r\n        float avgBlockerDepth = sumBlockerDepth / numBlocker;\r\n\r\n        // Offset preventing aliasing on contact.\r\n        float AAOffset = shadowMapSizeInverse * 10.;\r\n        // Do not dividing by z despite being physically incorrect looks better due to the limited kernel size.\r\n        // float penumbraRatio = (depthMetric - avgBlockerDepth) / avgBlockerDepth;\r\n        float penumbraRatio = ((depthMetric - avgBlockerDepth) + AAOffset);\r\n        float filterRadius = penumbraRatio * lightSizeUV * shadowMapSizeInverse;\r\n\r\n        float random = getRand(shadowCoord.xy);//getRand(vPositionFromLight.xy);\r\n        float rotationAngle = random * 3.1415926;\r\n        vec2 rotationVector = vec2(cos(rotationAngle), sin(rotationAngle));\r\n\r\n        float shadow = 0.;\r\n        for (int i = 0; i < pcfTapCount; i++) {\r\n            vec3 offset = poissonSamplers[i];\r\n            // Rotated offset.\r\n            offset = vec3(offset.x * rotationVector.x - offset.y * rotationVector.y, offset.y * rotationVector.x + offset.x * rotationVector.y, 0.);\r\n            shadow += texture(shadowSampler, shadowCoord + offset * filterRadius);\r\n        }\r\n        shadow /= float(pcfTapCount);\r\n\r\n        // Blocker distance falloff\r\n        shadow = mix(shadow, 1., depthMetric - avgBlockerDepth);\r\n\r\n        return shadow;\r\n    }\r\n\r\n    float getShadowWithPCSS( sampler2D depthSampler, sampler2DShadow shadowMap, vec4 shadowCoord, float shadowBias, float shadowRadius, vec2 shadowMapSize ) {\r\n\r\n        shadowCoord.xyz /= shadowCoord.w;\r\n\r\n        shadowCoord.z += shadowBias;\r\n\r\n        bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\r\n        bool inFrustum = all( inFrustumVec );\r\n\r\n        bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\r\n\r\n        bool frustumTest = all( frustumTestVec );\r\n\r\n        if ( frustumTest ) {\r\n            #ifdef USE_PCSS16_SOFT_SHADOW\r\n                return computeShadowWithPCSS(depthSampler, shadowMap, shadowCoord.xyz, 1. / shadowMapSize.x, 0.1 * shadowMapSize.x, 16, 16, PoissonSamplers32);\r\n            #else\r\n                #ifdef USE_PCSS32_SOFT_SHADOW\r\n                    return computeShadowWithPCSS(depthSampler, shadowMap, shadowCoord.xyz, 1. / shadowMapSize.x, 0.1 * shadowMapSize.x, 16, 32, PoissonSamplers32);\r\n                #else\r\n                    return computeShadowWithPCSS(depthSampler, shadowMap, shadowCoord.xyz, 1. / shadowMapSize.x, 0.1 * shadowMapSize.x, 32, 64, PoissonSamplers64);\r\n                #endif\r\n            #endif\r\n        }\r\n\r\n        return 1.0;\r\n\r\n    }\r\n\r\n#endif",shadowMap_frag:"#ifdef USE_SHADOW\r\n    // outColor *= getShadowMask();\r\n#endif",shadowMap_pars_frag:"#ifdef USE_SHADOW\r\n\r\n    #if NUM_DIR_SHADOWS > 0\r\n\r\n        uniform sampler2DShadow directionalShadowMap[ NUM_DIR_LIGHTS ];\r\n        varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r\n\r\n        #ifdef USE_PCSS_SOFT_SHADOW\r\n\r\n            uniform sampler2D directionalDepthMap[ NUM_DIR_LIGHTS ];\r\n\r\n        #endif\r\n\r\n    #endif\r\n\r\n    #if NUM_POINT_SHADOWS > 0\r\n\r\n        uniform samplerCube pointShadowMap[ NUM_POINT_LIGHTS ];\r\n\r\n    #endif\r\n\r\n    #if NUM_SPOT_SHADOWS > 0\r\n\r\n        uniform sampler2DShadow spotShadowMap[ NUM_SPOT_LIGHTS ];\r\n        varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\r\n\r\n        #ifdef USE_PCSS_SOFT_SHADOW\r\n\r\n            uniform sampler2D spotDepthMap[ NUM_SPOT_LIGHTS ];\r\n\r\n        #endif\r\n\r\n    #endif\r\n\r\n    #include <packing>\r\n    #include <shadow>\r\n\r\n#endif",shadowMap_pars_vert:"#ifdef USE_SHADOW\r\n\r\n    #if NUM_DIR_SHADOWS > 0\r\n\r\n        uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\r\n        varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r\n\r\n    #endif\r\n\r\n    #if NUM_POINT_SHADOWS > 0\r\n\r\n        // nothing\r\n\r\n    #endif\r\n\r\n    #if NUM_SPOT_SHADOWS > 0\r\n\r\n        uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\r\n        varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\r\n\r\n    #endif\r\n\r\n#endif",shadowMap_vert:"#ifdef USE_SHADOW\r\n\r\n    vec4 worldPosition = u_Model * vec4(transformed, 1.0);\r\n\r\n    #if NUM_DIR_SHADOWS > 0\r\n\r\n        #pragma unroll_loop\r\n        for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n\r\n            vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\r\n\r\n        }\r\n\r\n    #endif\r\n\r\n    #if NUM_POINT_SHADOWS > 0\r\n\r\n        // nothing\r\n\r\n    #endif\r\n\r\n    #if NUM_SPOT_SHADOWS > 0\r\n\r\n        #pragma unroll_loop\r\n        for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\r\n\r\n            vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\r\n\r\n        }\r\n\r\n    #endif\r\n\r\n#endif",morphnormal_vert:"#ifdef USE_MORPHNORMALS\r\n\r\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\r\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\r\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\r\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\r\n\r\n#endif",morphtarget_pars_vert:"#ifdef USE_MORPHTARGETS\r\n\r\n\t#ifndef USE_MORPHNORMALS\r\n\r\n\tuniform float morphTargetInfluences[ 8 ];\r\n\r\n\t#else\r\n\r\n\tuniform float morphTargetInfluences[ 4 ];\r\n\r\n\t#endif\r\n\r\n#endif",morphtarget_vert:"#ifdef USE_MORPHTARGETS\r\n\r\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\r\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\r\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\r\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\r\n\r\n\t#ifndef USE_MORPHNORMALS\r\n\r\n        transformed += morphTarget4 * morphTargetInfluences[ 4 ];\r\n        transformed += morphTarget5 * morphTargetInfluences[ 5 ];\r\n        transformed += morphTarget6 * morphTargetInfluences[ 6 ];\r\n        transformed += morphTarget7 * morphTargetInfluences[ 7 ];\r\n\r\n\t#endif\r\n\r\n#endif",skinning_pars_vert:"#ifdef USE_SKINNING\r\n\r\n    attribute vec4 skinIndex;\r\n\tattribute vec4 skinWeight;\r\n\r\n    uniform mat4 bindMatrix;\r\n\tuniform mat4 bindMatrixInverse;\r\n\r\n    #ifdef BONE_TEXTURE\r\n        uniform sampler2D boneTexture;\r\n        uniform int boneTextureSize;\r\n\r\n        mat4 getBoneMatrix( const in float i ) {\r\n            float j = i * 4.0;\r\n            float x = mod( j, float( boneTextureSize ) );\r\n            float y = floor( j / float( boneTextureSize ) );\r\n\r\n            float dx = 1.0 / float( boneTextureSize );\r\n            float dy = 1.0 / float( boneTextureSize );\r\n\r\n            y = dy * ( y + 0.5 );\r\n\r\n            vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\r\n            vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\r\n            vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\r\n            vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\r\n\r\n            mat4 bone = mat4( v1, v2, v3, v4 );\r\n\r\n            return bone;\r\n        }\r\n    #else\r\n        uniform mat4 boneMatrices[MAX_BONES];\r\n\r\n        mat4 getBoneMatrix(const in float i) {\r\n            mat4 bone = boneMatrices[int(i)];\r\n            return bone;\r\n        }\r\n    #endif\r\n\r\n#endif",skinning_vert:"#ifdef USE_SKINNING\r\n\r\n    mat4 boneMatX = getBoneMatrix( skinIndex.x );\r\n    mat4 boneMatY = getBoneMatrix( skinIndex.y );\r\n    mat4 boneMatZ = getBoneMatrix( skinIndex.z );\r\n    mat4 boneMatW = getBoneMatrix( skinIndex.w );\r\n\r\n    vec4 skinVertex = bindMatrix * vec4(transformed, 1.0);\r\n\r\n    vec4 skinned = vec4( 0.0 );\r\n\tskinned += boneMatX * skinVertex * skinWeight.x;\r\n\tskinned += boneMatY * skinVertex * skinWeight.y;\r\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\r\n\tskinned += boneMatW * skinVertex * skinWeight.w;\r\n\tskinned = bindMatrixInverse * skinned;\r\n\r\n    // override\r\n    transformed = skinned.xyz / skinned.w;\r\n\r\n    #if defined(USE_NORMAL) || defined(USE_ENV_MAP)\r\n        mat4 skinMatrix = mat4( 0.0 );\r\n        skinMatrix += skinWeight.x * boneMatX;\r\n        skinMatrix += skinWeight.y * boneMatY;\r\n        skinMatrix += skinWeight.z * boneMatZ;\r\n        skinMatrix += skinWeight.w * boneMatW;\r\n        skinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\r\n\r\n        // override\r\n        objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\r\n    #endif\r\n\r\n#endif",specularMap_frag:"float specularStrength;\r\n\r\n#ifdef USE_SPECULARMAP\r\n\r\n\tvec4 texelSpecular = texture2D( specularMap, v_Uv );\r\n\tspecularStrength = texelSpecular.r;\r\n\r\n#else\r\n\r\n\tspecularStrength = 1.0;\r\n\r\n#endif",specularMap_pars_frag:"#ifdef USE_SPECULARMAP\r\n\r\n\tuniform sampler2D specularMap;\r\n\r\n#endif",spotlight_pars_frag:"struct SpotLight\r\n{\r\n    vec3 position;\r\n    vec4 color;\r\n    float distance;\r\n    float decay;\r\n    float coneCos;\r\n    float penumbraCos;\r\n    vec3 direction;\r\n\r\n    int shadow;\r\n    float shadowBias;\r\n    float shadowRadius;\r\n    vec2 shadowMapSize;\r\n};\r\nuniform SpotLight u_Spot[NUM_SPOT_LIGHTS];",transpose:"mat4 transposeMat4(mat4 inMatrix) {\r\n    vec4 i0 = inMatrix[0];\r\n    vec4 i1 = inMatrix[1];\r\n    vec4 i2 = inMatrix[2];\r\n    vec4 i3 = inMatrix[3];\r\n    mat4 outMatrix = mat4(\r\n        vec4(i0.x, i1.x, i2.x, i3.x),\r\n        vec4(i0.y, i1.y, i2.y, i3.y),\r\n        vec4(i0.z, i1.z, i2.z, i3.z),\r\n        vec4(i0.w, i1.w, i2.w, i3.w)\r\n    );\r\n    return outMatrix;\r\n}",tsn:"// Per-Pixel Tangent Space Normal Mapping\r\n// http://hacksoflife.blogspot.ch/2009/11/per-pixel-tangent-space-normal-mapping.html\r\nmat3 tsn(vec3 N, vec3 V, vec2 uv) {\r\n    // Workaround for Adreno/Nexus5 not able able to do dFdx( Vec3 ) ...\r\n    vec3 q0 = vec3(dFdx(V.x), dFdx(V.y), dFdx(V.z));\r\n    vec3 q1 = vec3(dFdy(V.x), dFdy(V.y), dFdy(V.z));\r\n    vec2 st0 = dFdx( uv.st );\r\n    vec2 st1 = dFdy( uv.st );\r\n\r\n    float scale = sign( st1.t * st0.s - st0.t * st1.s );\r\n\r\n    vec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\r\n    vec3 T = normalize( ( -q0 * st1.s + q1 * st0.s ) * scale );\r\n    // vec3 N = normalize( N );\r\n\r\n    mat3 tsn = mat3( S, T, N );\r\n    return tsn;\r\n}",uv_pars_frag:"#if defined(USE_DIFFUSE_MAP) || defined(USE_ALPHA_MAP) || defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP) || defined(USE_SPECULARMAP) || defined(USE_EMISSIVEMAP) || defined(USE_ROUGHNESSMAP) || defined(USE_METALNESSMAP) || defined(USE_GLOSSINESSMAP) || defined(USE_AOMAP)\r\n    varying vec2 v_Uv;\r\n#endif\r\n\r\n#ifdef USE_UV2\r\n    varying vec2 v_Uv2;\r\n#endif\r\n\r\n#ifdef USE_ALPHA_MAP_UV_TRANSFORM\r\n    varying vec2 vAlphaMapUV;\r\n#endif ",uv_pars_vert:"#if defined(USE_DIFFUSE_MAP) || defined(USE_ALPHA_MAP) || defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP) || defined(USE_SPECULARMAP) || defined(USE_EMISSIVEMAP) || defined(USE_ROUGHNESSMAP) || defined(USE_METALNESSMAP) || defined(USE_GLOSSINESSMAP) || defined(USE_AOMAP)\r\n    attribute vec2 a_Uv;\r\n    varying vec2 v_Uv;\r\n    uniform mat3 uvTransform;\r\n#endif\r\n\r\n#ifdef USE_UV2\r\n    attribute vec2 a_Uv2;\r\n    varying vec2 v_Uv2;\r\n#endif\r\n\r\n#ifdef USE_ALPHA_MAP_UV_TRANSFORM\r\n    varying vec2 vAlphaMapUV;\r\n    uniform mat3 alphaMapUVTransform;\r\n#endif \r\n",uv_vert:"#if defined(USE_DIFFUSE_MAP) || defined(USE_ALPHA_MAP) || defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP) || defined(USE_SPECULARMAP) || defined(USE_EMISSIVEMAP) || defined(USE_ROUGHNESSMAP) || defined(USE_METALNESSMAP) || defined(USE_GLOSSINESSMAP) || defined(USE_AOMAP)\r\n    v_Uv = (uvTransform * vec3(a_Uv, 1.)).xy;\r\n#endif\r\n\r\n#ifdef USE_UV2\r\n    v_Uv2 = a_Uv2;\r\n#endif\r\n\r\n#ifdef USE_ALPHA_MAP_UV_TRANSFORM\r\n    #if (USE_ALPHA_MAP == 1)\r\n        vAlphaMapUV = (alphaMapUVTransform * vec3(a_Uv, 1.)).xy;\r\n    #elif (USE_ALPHA_MAP == 2)\r\n        vAlphaMapUV = (alphaMapUVTransform * vec3(a_Uv2, 1.)).xy;\r\n    #else\r\n        vAlphaMapUV = (alphaMapUVTransform * vec3(a_Uv, 1.)).xy;\r\n    #endif\r\n#endif ",viewModelPos_pars_frag:"#if (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0) || defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP) || defined(FLAT_SHADED) || defined(USE_PHONG) || defined(USE_PBR) || (NUM_CLIPPING_PLANES > 0) \r\n    varying vec3 v_modelPos;\r\n#endif",viewModelPos_pars_vert:"#if (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0) || defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP) || defined(FLAT_SHADED) || defined(USE_PHONG) || defined(USE_PBR)|| (NUM_CLIPPING_PLANES > 0)\r\n    varying vec3 v_modelPos;\r\n#endif",viewModelPos_vert:"#if (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0) || defined(USE_NORMAL_MAP) || defined(USE_BUMPMAP) || defined(FLAT_SHADED) || defined(USE_PHONG) || defined(USE_PBR) || (NUM_CLIPPING_PLANES > 0)\r\n    v_modelPos = (u_Model * vec4(transformed, 1.0)).xyz;\r\n#endif"},lr="#define USE_PBR\r\n\r\n#include <common_vert>\r\n#include <normal_pars_vert>\r\n#include <uv_pars_vert>\r\n#include <color_pars_vert>\r\n#include <viewModelPos_pars_vert>\r\n#include <envMap_pars_vert>\r\n#include <shadowMap_pars_vert>\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <morphnormal_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n    #include <normal_vert>\r\n    #include <uv_vert>\r\n    #include <color_vert>\r\n    #include <viewModelPos_vert>\r\n    #include <envMap_vert>\r\n    #include <shadowMap_vert>\r\n}",dr={basic_frag:"#include <common_frag>\r\n#include <uv_pars_frag>\r\n#include <color_pars_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <alphamap_pars_frag>\r\n#include <envMap_pars_frag>\r\n#include <aoMap_pars_frag>\r\n#include <fog_pars_frag>\r\nvoid main() {\r\n    #include <begin_frag>\r\n    #include <color_frag>\r\n    #include <diffuseMap_frag>\r\n    #include <alphamap_frag>\r\n    #include <alphaTest_frag>\r\n    #include <envMap_frag>\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n}",basic_vert:"#include <common_vert>\r\n#include <uv_pars_vert>\r\n#include <color_pars_vert>\r\n#include <envMap_pars_vert>\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n    #include <uv_vert>\r\n    #include <color_vert>\r\n    #include <envMap_vert>\r\n}",canvas2d_frag:"#include <common_frag>\r\nvarying vec2 v_Uv;\r\nuniform sampler2D spriteTexture;\r\nvoid main() {\r\n    #include <begin_frag>\r\n    outColor *= texture2D(spriteTexture, v_Uv);\r\n    #include <end_frag>\r\n    #include <premultipliedAlpha_frag>\r\n}",canvas2d_vert:"#include <common_vert>\r\nattribute vec2 a_Uv;\r\nvarying vec2 v_Uv;\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <pvm_vert>\r\n    v_Uv = a_Uv;\r\n}",depth_frag:"#include <common_frag>\r\n#include <diffuseMap_pars_frag>\r\n\r\n#include <uv_pars_frag>\r\n\r\n#include <packing>\r\n\r\nvoid main() {\r\n    #if defined(USE_DIFFUSE_MAP) && defined(ALPHATEST)\r\n        vec4 texelColor = texture2D( diffuseMap, v_Uv );\r\n\r\n        float alpha = texelColor.a * u_Opacity;\r\n        if(alpha < ALPHATEST) discard;\r\n    #endif\r\n    \r\n    #ifdef DEPTH_PACKING_RGBA\r\n        gl_FragColor = packDepthToRGBA(gl_FragCoord.z);\r\n    #else\r\n        gl_FragColor = vec4( vec3( 1.0 - gl_FragCoord.z ), u_Opacity );\r\n    #endif\r\n}",depth_vert:"#include <common_vert>\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\n#include <uv_pars_vert>\r\nvoid main() {\r\n    #include <uv_vert>\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n}",distance_frag:"#include <common_frag>\r\nuniform float nearDistance;\r\nuniform float farDistance;\r\nvarying vec3 v_ModelPos;\r\n#include <packing>\r\nvoid main() {\r\n    float dist = length( v_ModelPos - u_CameraPosition );\r\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\r\n\tdist = saturate( dist ); // clamp to [ 0, 1 ]\r\n\r\n    gl_FragColor = packDepthToRGBA(dist);\r\n}",distance_vert:"#include <common_vert>\r\nvarying vec3 v_ModelPos;\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n    v_ModelPos = (u_Model * vec4(transformed, 1.0)).xyz;\r\n}",lambert_frag:"#define USE_LAMBERT\r\n\r\n#include <common_frag>\r\n#include <dithering_pars_frag>\r\n\r\nuniform vec3 emissive;\r\n\r\n#include <uv_pars_frag>\r\n#include <color_pars_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <normalMap_pars_frag>\r\n#include <alphamap_pars_frag>\r\n#include <bumpMap_pars_frag>\r\n#include <light_pars_frag>\r\n#include <normal_pars_frag>\r\n#include <viewModelPos_pars_frag>\r\n#include <bsdfs>\r\n#include <envMap_pars_frag>\r\n#include <aoMap_pars_frag>\r\n#include <shadowMap_pars_frag>\r\n#include <fog_pars_frag>\r\n#include <emissiveMap_pars_frag>\r\n#include <clippingPlanes_pars_frag>\r\nvoid main() {\r\n    #include <clippingPlanes_frag>\r\n    #include <begin_frag>\r\n    #include <color_frag>\r\n    #include <diffuseMap_frag>\r\n    #include <alphamap_frag>\r\n    #include <alphaTest_frag>\r\n    #include <normal_frag>\r\n    #include <light_frag>\r\n    #include <envMap_frag>\r\n    #include <shadowMap_frag>\r\n\r\n    vec3 totalEmissiveRadiance = emissive;\r\n    #include <emissiveMap_frag>\r\n    outColor += vec4(totalEmissiveRadiance.rgb, 0.0);\r\n\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n    #include <dithering_frag>\r\n}",lambert_vert:"#define USE_LAMBERT\r\n\r\n#include <common_vert>\r\n#include <normal_pars_vert>\r\n#include <uv_pars_vert>\r\n#include <color_pars_vert>\r\n#include <viewModelPos_pars_vert>\r\n#include <envMap_pars_vert>\r\n#include <shadowMap_pars_vert>\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <morphnormal_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n    #include <normal_vert>\r\n    #include <uv_vert>\r\n    #include <color_vert>\r\n    #include <viewModelPos_vert>\r\n    #include <envMap_vert>\r\n    #include <shadowMap_vert>\r\n}",normaldepth_frag:"#include <common_frag>\r\n#include <diffuseMap_pars_frag>\r\n\r\n#include <uv_pars_frag>\r\n\r\n#define USE_NORMAL\r\n\r\n#include <packing>\r\n#include <normal_pars_frag>\r\n\r\nvoid main() {\r\n    #if defined(USE_DIFFUSE_MAP) && defined(ALPHATEST)\r\n        vec4 texelColor = texture2D( diffuseMap, v_Uv );\r\n\r\n        float alpha = texelColor.a * u_Opacity;\r\n        if(alpha < ALPHATEST) discard;\r\n    #endif\r\n    vec4 packedNormalDepth;\r\n    packedNormalDepth.xyz = normalize(v_Normal) * 0.5 + 0.5;\r\n    packedNormalDepth.w = gl_FragCoord.z;\r\n    gl_FragColor = packedNormalDepth;\r\n}",normaldepth_vert:"#include <common_vert>\r\n\r\n#define USE_NORMAL\r\n\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\n#include <normal_pars_vert>\r\n#include <uv_pars_vert>\r\nvoid main() {\r\n    #include <uv_vert>\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <morphnormal_vert>\r\n    #include <skinning_vert>\r\n    #include <normal_vert>\r\n    #include <pvm_vert>\r\n}",pbr_frag:"#define USE_PBR\r\n\r\n#include <common_frag>\r\n#include <dithering_pars_frag>\r\n\r\n// if no light> this will not active\r\nuniform float u_Metalness;\r\n#ifdef USE_METALNESSMAP\r\n\tuniform sampler2D metalnessMap;\r\n#endif\r\n\r\nuniform float u_Roughness;\r\n#ifdef USE_ROUGHNESSMAP\r\n\tuniform sampler2D roughnessMap;\r\n#endif\r\n\r\nuniform vec3 emissive;\r\n\r\n#include <uv_pars_frag>\r\n#include <color_pars_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <alphamap_pars_frag>\r\n#include <normalMap_pars_frag>\r\n#include <bumpMap_pars_frag>\r\n#include <envMap_pars_frag>\r\n#include <aoMap_pars_frag>\r\n#include <light_pars_frag>\r\n#include <normal_pars_frag>\r\n#include <viewModelPos_pars_frag>\r\n#include <bsdfs>\r\n#include <shadowMap_pars_frag>\r\n#include <fog_pars_frag>\r\n#include <emissiveMap_pars_frag>\r\n#include <clippingPlanes_pars_frag>\r\nvoid main() {\r\n    #include <clippingPlanes_frag>\r\n    #include <begin_frag>\r\n    #include <color_frag>\r\n    #include <diffuseMap_frag>\r\n    #include <alphamap_frag>\r\n    #include <alphaTest_frag>\r\n    #include <normal_frag>\r\n\r\n    float roughnessFactor = u_Roughness;\r\n    #ifdef USE_ROUGHNESSMAP\r\n    \tvec4 texelRoughness = texture2D( roughnessMap, v_Uv );\r\n    \t// reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\r\n    \troughnessFactor *= texelRoughness.g;\r\n    #endif\r\n\r\n    float metalnessFactor = u_Metalness;\r\n    #ifdef USE_METALNESSMAP\r\n    \tvec4 texelMetalness = texture2D( metalnessMap, v_Uv );\r\n    \t// reads channel B, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\r\n    \tmetalnessFactor *= texelMetalness.b;\r\n    #endif\r\n\r\n    #include <light_frag>\r\n    #include <shadowMap_frag>\r\n\r\n    vec3 totalEmissiveRadiance = emissive;\r\n    #include <emissiveMap_frag>\r\n    outColor += vec4(totalEmissiveRadiance.rgb, 0.0);\r\n\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n    #include <dithering_frag>\r\n}",pbr_vert:lr,pbr2_frag:"#define USE_PBR\r\n#define USE_PBR2\r\n\r\n#include <common_frag>\r\n#include <dithering_pars_frag>\r\n\r\n// if no light> this will not active\r\nuniform vec3 u_SpecularColor;\r\n#ifdef USE_SPECULARMAP\r\n\tuniform sampler2D specularMap;\r\n#endif\r\n\r\nuniform float glossiness;\r\n#ifdef USE_GLOSSINESSMAP\r\n\tuniform sampler2D glossinessMap;\r\n#endif\r\n\r\nuniform vec3 emissive;\r\n\r\n#include <uv_pars_frag>\r\n#include <color_pars_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <alphamap_pars_frag>\r\n#include <normalMap_pars_frag>\r\n#include <bumpMap_pars_frag>\r\n#include <envMap_pars_frag>\r\n#include <aoMap_pars_frag>\r\n#include <light_pars_frag>\r\n#include <normal_pars_frag>\r\n#include <viewModelPos_pars_frag>\r\n#include <bsdfs>\r\n#include <shadowMap_pars_frag>\r\n#include <fog_pars_frag>\r\n#include <emissiveMap_pars_frag>\r\n#include <clippingPlanes_pars_frag>\r\nvoid main() {\r\n    #include <clippingPlanes_frag>\r\n    #include <begin_frag>\r\n    #include <color_frag>\r\n    #include <diffuseMap_frag>\r\n    #include <alphamap_frag>\r\n    #include <alphaTest_frag>\r\n    #include <normal_frag>\r\n\r\n    vec3 specularFactor = u_SpecularColor;\r\n    #ifdef USE_SPECULARMAP\r\n        vec4 texelSpecular = texture2D(specularMap, v_Uv);\r\n        texelSpecular = sRGBToLinear(texelSpecular);\r\n        // reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture\r\n        specularFactor *= texelSpecular.rgb;\r\n    #endif\r\n\r\n    float glossinessFactor = glossiness;\r\n    #ifdef USE_GLOSSINESSMAP\r\n        vec4 texelGlossiness = texture2D(glossinessMap, v_Uv);\r\n        // reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture\r\n        glossinessFactor *= texelGlossiness.a;\r\n    #endif\r\n\r\n    #include <light_frag>\r\n    #include <shadowMap_frag>\r\n\r\n    vec3 totalEmissiveRadiance = emissive;\r\n    #include <emissiveMap_frag>\r\n    outColor += vec4(totalEmissiveRadiance.rgb, 0.0);\r\n\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n    #include <dithering_frag>\r\n}",pbr2_vert:lr,matcap_frag:"#define MATCAP\r\n\r\nuniform sampler2D matcap;\r\nvarying vec3 vViewPosition;\r\n\r\n#include <common_frag>\r\n#include <dithering_pars_frag>\r\n#include <uv_pars_frag>\r\n#include <color_pars_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <alphamap_pars_frag>\r\n#include <normalMap_pars_frag>\r\n#include <viewModelPos_pars_frag>\r\n#include <bumpMap_pars_frag>\r\n#include <normal_pars_frag>\r\n#include <fog_pars_frag>\r\n#include <clippingPlanes_pars_frag>\r\nvoid main() {\r\n    #include <clippingPlanes_frag>\r\n    #include <begin_frag>\r\n    #include <color_frag>\r\n    #include <diffuseMap_frag>\r\n    #include <alphamap_frag>\r\n    #include <alphaTest_frag>\r\n    #include <normal_frag>\r\n\r\n    vec3 viewDir = normalize(vViewPosition);\r\n\tvec3 x = normalize(vec3(viewDir.z, 0.0, -viewDir.x));\r\n\tvec3 y = cross(viewDir, x);\r\n    vec3 viewN = (u_View * vec4(N, 0.0)).xyz;\r\n\tvec2 uv = vec2(dot(x, viewN), dot(y, viewN)) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks\r\n\r\n    #ifdef USE_MATCAP\r\n\t\tvec4 matcapColor = texture2D(matcap, uv);\r\n\t\tmatcapColor = matcapTexelToLinear(matcapColor);\r\n\t#else\r\n\t\tvec4 matcapColor = vec4(1.0);\r\n\t#endif\r\n\r\n\toutColor.rgb *= matcapColor.rgb;\r\n\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n    #include <dithering_frag>\r\n}",matcap_vert:"#define MATCAP\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#include <common_vert>\r\n#include <normal_pars_vert>\r\n#include <uv_pars_vert>\r\n#include <color_pars_vert>\r\n#include <viewModelPos_pars_vert>\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <morphnormal_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n    #include <normal_vert>\r\n    #include <uv_vert>\r\n    #include <color_vert>\r\n    #include <viewModelPos_vert>\r\n\r\n    vec4 mvPosition = u_View * u_Model * vec4(transformed, 1.0);\r\n    vViewPosition = - mvPosition.xyz;\r\n}",phong_frag:"#define USE_PHONG\r\n\r\n#include <common_frag>\r\n#include <dithering_pars_frag>\r\n\r\n// if no light> this will not active\r\nuniform float u_Specular;\r\nuniform vec3 u_SpecularColor;\r\n#include <specularMap_pars_frag>\r\n\r\nuniform vec3 emissive;\r\n\r\n#include <uv_pars_frag>\r\n#include <color_pars_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <alphamap_pars_frag>\r\n#include <normalMap_pars_frag>\r\n#include <bumpMap_pars_frag>\r\n#include <light_pars_frag>\r\n#include <normal_pars_frag>\r\n#include <viewModelPos_pars_frag>\r\n#include <bsdfs>\r\n#include <envMap_pars_frag>\r\n#include <aoMap_pars_frag>\r\n#include <shadowMap_pars_frag>\r\n#include <fog_pars_frag>\r\n#include <emissiveMap_pars_frag>\r\n#include <clippingPlanes_pars_frag>\r\nvoid main() {\r\n    #include <clippingPlanes_frag>\r\n    #include <begin_frag>\r\n    #include <color_frag>\r\n    #include <diffuseMap_frag>\r\n    #include <alphamap_frag>\r\n    #include <alphaTest_frag>\r\n    #include <normal_frag>\r\n    #include <specularMap_frag>\r\n    #include <light_frag>\r\n    #include <envMap_frag>\r\n    #include <shadowMap_frag>\r\n\r\n    vec3 totalEmissiveRadiance = emissive;\r\n    #include <emissiveMap_frag>\r\n    outColor += vec4(totalEmissiveRadiance.rgb, 0.0);\r\n\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n    #include <dithering_frag>\r\n}",phong_vert:"#define USE_PHONG\r\n\r\n#include <common_vert>\r\n#include <normal_pars_vert>\r\n#include <uv_pars_vert>\r\n#include <color_pars_vert>\r\n#include <viewModelPos_pars_vert>\r\n#include <envMap_pars_vert>\r\n#include <shadowMap_pars_vert>\r\n#include <morphtarget_pars_vert>\r\n#include <skinning_pars_vert>\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <morphtarget_vert>\r\n    #include <morphnormal_vert>\r\n    #include <skinning_vert>\r\n    #include <pvm_vert>\r\n    #include <normal_vert>\r\n    #include <uv_vert>\r\n    #include <color_vert>\r\n    #include <viewModelPos_vert>\r\n    #include <envMap_vert>\r\n    #include <shadowMap_vert>\r\n}",point_frag:"#include <common_frag>\r\n#include <diffuseMap_pars_frag>\r\n#include <fog_pars_frag>\r\nvoid main() {\r\n    #include <begin_frag>\r\n    #ifdef USE_DIFFUSE_MAP\r\n        outColor *= texture2D(diffuseMap, vec2(gl_PointCoord.x, 1.0 - gl_PointCoord.y));\r\n    #endif\r\n    #include <end_frag>\r\n    #include <encodings_frag>\r\n    #include <premultipliedAlpha_frag>\r\n    #include <fog_frag>\r\n}",point_vert:"#include <common_vert>\r\nuniform float u_PointSize;\r\nuniform float u_PointScale;\r\nvoid main() {\r\n    #include <begin_vert>\r\n    #include <pvm_vert>\r\n    vec4 mvPosition = u_View * u_Model * vec4(transformed, 1.0);\r\n    #ifdef USE_SIZEATTENUATION\r\n        gl_PointSize = u_PointSize * ( u_PointScale / - mvPosition.z );\r\n    #else\r\n        gl_PointSize = u_PointSize;\r\n    #endif\r\n}"};function pr(e){var t;return e?e.encoding&&(t=e.encoding):t=A.LINEAR,t}function fr(e){switch(e){case A.LINEAR:return["Linear","( value )"];case A.SRGB:return["sRGB","( value )"];case A.RGBE:return["RGBE","( value )"];case A.RGBM7:return["RGBM","( value, 7.0 )"];case A.RGBM16:return["RGBM","( value, 16.0 )"];case A.RGBD:return["RGBD","( value, 256.0 )"];case A.GAMMA:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:console.error("unsupported encoding: "+e)}}function _r(e,t){var r=fr(t);return"vec4 "+e+"( vec4 value ) { return "+r[0]+"ToLinear"+r[1]+"; }"}function mr(e,t,r){var n,i,a,s=["precision "+t.precision+" float;","precision "+t.precision+" int;","precision "+t.precision+" sampler2D;","#define SHADER_NAME "+t.materialType,r,2<=t.version?"#define WEBGL2":"",t.useRoughnessMap?"#define USE_ROUGHNESSMAP":"",t.useMetalnessMap?"#define USE_METALNESSMAP":"",t.useGlossinessMap?"#define USE_GLOSSINESSMAP":"",0<t.ambientLightNum?"#define USE_AMBIENT_LIGHT "+t.ambientLightNum:"",0<t.pointLightNum||0<t.directLightNum||0<t.ambientLightNum||0<t.spotLightNum?"#define USE_LIGHT":"",0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP?"#define USE_NORMAL":"",(0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP)&&t.useNormalMap?"#define USE_NORMAL_MAP":"",(0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP)&&t.useBumpMap?"#define USE_BUMPMAP":"",(0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP)&&t.useSpecularMap?"#define USE_SPECULARMAP":"",t.useEmissiveMap?"#define USE_EMISSIVEMAP "+t.useEmissiveMap:"",t.useShadow?"#define USE_SHADOW":"",t.flatShading?"#define FLAT_SHADED":"",t.flipSided?"#define FLIP_SIDED":"",t.useDiffuseMap?"#define USE_DIFFUSE_MAP "+t.useDiffuseMap:"",t.useAlphaMap?"#define USE_ALPHA_MAP "+t.useAlphaMap:"",t.useAlphaMapUVTransform?"#define USE_ALPHA_MAP_UV_TRANSFORM":"",t.useEnvMap?"#define USE_ENV_MAP":"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.useAOMap?"#define USE_AOMAP "+t.useAOMap:"",t.useVertexColors==C.RGB?"#define USE_VCOLOR_RGB":"",t.useVertexColors==C.RGBA?"#define USE_VCOLOR_RGBA":"",t.useVertexTangents?"#define USE_TANGENT":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&!1===t.flatShading?"#define USE_MORPHNORMALS":"",t.useSkinning?"#define USE_SKINNING":"",0<t.bonesNum?"#define MAX_BONES "+t.bonesNum:"",t.useVertexTexture?"#define BONE_TEXTURE":""].filter(gr).join("\n"),o=[t.useStandardDerivatives&&t.version<2?"#extension GL_OES_standard_derivatives : enable":"",t.useShaderTextureLOD&&t.version<2?"#extension GL_EXT_shader_texture_lod : enable":"","precision "+t.precision+" float;","precision "+t.precision+" int;","precision "+t.precision+" sampler2D;",2<=t.version?"precision "+t.precision+" sampler2DShadow;":"",2<=t.version?"precision "+t.precision+" samplerCubeShadow;":"","#define SHADER_NAME "+t.materialType,"#define PI 3.14159265359","#define EPSILON 1e-6","float pow2( const in float x ) { return x*x; }","#define LOG2 1.442695","#define RECIPROCAL_PI 0.31830988618","#define saturate(a) clamp( a, 0.0, 1.0 )","#define whiteCompliment(a) ( 1.0 - saturate( a ) )","highp float rand( const in vec2 uv ) {","const highp float a = 12.9898, b = 78.233, c = 43758.5453;","highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );","return fract(sin(sn) * c);","}",r,2<=t.version?"#define WEBGL2":"",t.version<2?"#define sampler2DShadow sampler2D":"",t.useRoughnessMap?"#define USE_ROUGHNESSMAP":"",t.useMetalnessMap?"#define USE_METALNESSMAP":"",t.useGlossinessMap?"#define USE_GLOSSINESSMAP":"",0<t.ambientLightNum?"#define USE_AMBIENT_LIGHT "+t.ambientLightNum:"",0<t.pointLightNum||0<t.directLightNum||0<t.ambientLightNum||0<t.spotLightNum?"#define USE_LIGHT":"",0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP?"#define USE_NORMAL":"",(0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP)&&t.useNormalMap?"#define USE_NORMAL_MAP":"",(0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP)&&t.useBumpMap?"#define USE_BUMPMAP":"",(0<t.pointLightNum||0<t.directLightNum||0<t.spotLightNum||t.materialType===g.MATCAP)&&t.useSpecularMap?"#define USE_SPECULARMAP":"",t.useEmissiveMap?"#define USE_EMISSIVEMAP "+t.useEmissiveMap:"",t.useShadow?"#define USE_SHADOW":"",t.shadowType===b.HARD?"#define USE_HARD_SHADOW":"",t.shadowType===b.POISSON_SOFT?"#define USE_POISSON_SOFT_SHADOW":"",t.shadowType===b.PCF3_SOFT?"#define USE_PCF3_SOFT_SHADOW":"",t.shadowType===b.PCF5_SOFT?"#define USE_PCF5_SOFT_SHADOW":"",t.shadowType===b.PCSS16_SOFT?"#define USE_PCSS16_SOFT_SHADOW":"",t.shadowType===b.PCSS32_SOFT?"#define USE_PCSS32_SOFT_SHADOW":"",t.shadowType===b.PCSS64_SOFT?"#define USE_PCSS64_SOFT_SHADOW":"",t.shadowType===b.PCSS16_SOFT||t.shadowType===b.PCSS32_SOFT||t.shadowType===b.PCSS64_SOFT?"#define USE_PCSS_SOFT_SHADOW":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.useShaderTextureLOD?"#define TEXTURE_LOD_EXT":"",t.useDiffuseMap?"#define USE_DIFFUSE_MAP "+t.useDiffuseMap:"",t.useAlphaMap?"#define USE_ALPHA_MAP "+t.useAlphaMap:"",t.useAlphaMapUVTransform?"#define USE_ALPHA_MAP_UV_TRANSFORM":"",t.useEnvMap?"#define USE_ENV_MAP":"",t.useAOMap?"#define USE_AOMAP "+t.useAOMap:"",t.useVertexColors==C.RGB?"#define USE_VCOLOR_RGB":"",t.useVertexColors==C.RGBA?"#define USE_VCOLOR_RGBA":"",t.useVertexTangents?"#define USE_TANGENT":"",t.premultipliedAlpha?"#define USE_PREMULTIPLIED_ALPHA":"",t.fog?"#define USE_FOG":"",t.fogExp2?"#define USE_EXP2_FOG":"",t.alphaTest?"#define ALPHATEST "+t.alphaTest:"",t.useEnvMap?"#define "+t.envMapCombine:"","#define GAMMA_FACTOR "+t.gammaFactor,t.useMatcap?"#define USE_MATCAP":"",t.dithering?"#define DITHERING":"",ur.encodings_pars_frag,_r("mapTexelToLinear",t.diffuseMapEncoding),t.useEnvMap?_r("envMapTexelToLinear",t.envMapEncoding):"",t.useEmissiveMap?_r("emissiveMapTexelToLinear",t.emissiveMapEncoding):"",t.useMatcap?_r("matcapTexelToLinear",t.matcapEncoding):"",(n="linearToOutputTexel",i=t.outputEncoding,a=fr(i),"vec4 "+n+"( vec4 value ) { return LinearTo"+a[0]+a[1]+"; }"),t.packDepthToRGBA?"#define DEPTH_PACKING_RGBA":""].filter(gr).join("\n"),h=dr[t.materialType+"_vert"]||t.vertexShader||dr.basic_vert,c=dr[t.materialType+"_frag"]||t.fragmentShader||dr.basic_frag,u=[s,h].join("\n"),l=[o,c].join("\n"),u=vr(u),l=vr(l);if(u=Mr(u,t),l=Mr(l,t),u=Er(u,t),l=Er(l,t),u=Sr(u),l=Sr(l),1<t.version){l=l.replace("#extension GL_EXT_draw_buffers : require","");for(var d=0,p=[];-1<l.indexOf("gl_FragData["+d+"]");)l=l.replace("gl_FragData["+d+"]","pc_fragData"+d),p.push("layout(location = "+d+") out vec4 pc_fragData"+d+";"),d++;l=l.replace("#define whiteCompliment(a) ( 1.0 - saturate( a ) )","#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n"+p.join("\n")+"\n"),u=["#version 300 es\n","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+u,l=["#version 300 es\n","#define varying in",-1<l.indexOf("layout")?"":"out highp vec4 pc_fragColor;","#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+l}return new cr(e,u,l)}var vr=function(e){return e.replace(/#include +<([\w\d.]+)>/g,function(e,t){var r=ur[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return vr(r)})};function gr(e){return""!==e}function Mr(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.directLightNum).replace(/NUM_SPOT_LIGHTS/g,t.spotLightNum).replace(/NUM_POINT_LIGHTS/g,t.pointLightNum).replace(/NUM_DIR_SHADOWS/g,t.directShadowNum).replace(/NUM_SPOT_SHADOWS/g,t.spotShadowNum).replace(/NUM_POINT_SHADOWS/g,t.pointShadowNum)}function Er(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes)}function Sr(e){return e.replace(/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,function(e,t,r,n){for(var i="",a=parseInt(t);a<parseInt(r);a++)i+=n.replace(/\[ i \]/g,"[ "+a+" ]");return i})}function xr(f,_,m){var v=[];this.getProgram=function(e,t,r,n){for(var i,a,t=t||r.material,s=n&&t.acceptLight?n.lights:null,o=n?n.fog:null,h=n?n.clippingPlanes:null,c=function(e,t,r,n,i,a,s,o){var h={};h.materialType=n.type,h.version=t.version,h.precision=n.precision||t.maxPrecision,h.useStandardDerivatives=2<=t.version||!!t.getExtension("OES_standard_derivatives")||!!t.getExtension("GL_OES_standard_derivatives"),h.useShaderTextureLOD=2<=t.version||!!t.getExtension("EXT_shader_texture_lod"),h.useDiffuseMap=n.diffuseMap?n.diffuseMapCoord+1:0,h.useAlphaMap=n.alphaMap?n.alphaMapCoord+1:0,h.useAlphaMapUVTransform=!!n.alphaMap&&n.alphaMap.useUVTransform,h.useNormalMap=!!n.normalMap,h.useBumpMap=!!n.bumpMap,h.useSpecularMap=!!n.specularMap,h.useEnvMap=!!n.envMap,h.envMapCombine=n.envMapCombine,h.useEmissiveMap=n.emissiveMap?n.emissiveMapCoord+1:0,h.useRoughnessMap=!!n.roughnessMap,h.useMetalnessMap=!!n.metalnessMap,h.useGlossinessMap=!!n.glossinessMap,h.useAOMap=n.aoMap?n.aoMapCoord+1:0,h.useMatcap=!!n.matcap,h.ambientLightNum=a?a.ambientsNum:0,h.directLightNum=a?a.directsNum:0,h.pointLightNum=a?a.pointsNum:0,h.spotLightNum=a?a.spotsNum:0,h.directShadowNum=i.receiveShadow&&a?a.directShadowNum:0,h.pointShadowNum=i.receiveShadow&&a?a.pointShadowNum:0,h.spotShadowNum=i.receiveShadow&&a?a.spotShadowNum:0,h.useShadow=i.receiveShadow&&!!a&&0<a.shadowsNum,-1<i.shadowType.indexOf("pcss")&&t.version<2?(console.warn("WebGL 1.0 not support PCSS soft shadow, fallback to POISSON_SOFT"),h.shadowType=b.POISSON_SOFT):h.shadowType=i.shadowType,h.dithering=n.dithering;var c=e.currentRenderTarget;h.gammaFactor=r.gammaFactor,h.outputEncoding=c.texture?pr(c.texture):r.outputEncoding,h.diffuseMapEncoding=pr(n.diffuseMap||n.cubeMap),h.envMapEncoding=pr(n.envMap),h.emissiveMapEncoding=pr(n.emissiveMap),h.matcapEncoding=pr(n.matcap),h.alphaTest=n.alphaTest,h.premultipliedAlpha=n.premultipliedAlpha,h.useVertexColors=n.vertexColors,h.useVertexTangents=!!n.normalMap&&n.vertexTangents,h.numClippingPlanes=o?o.length:0,h.flatShading=n.shading===S.FLAT_SHADING,h.fog=!!s,h.fogExp2=!!s&&s.fogType===M.EXP2,h.sizeAttenuation=n.sizeAttenuation,h.doubleSided=n.side===E.DOUBLE,h.flipSided=n.side===E.BACK,h.packDepthToRGBA=n.packToRGBA,h.morphTargets=!!i.morphTargetInfluences,h.morphNormals=!!i.morphTargetInfluences&&i.geometry.morphAttributes.normal;var u=i.type===G.SKINNED_MESH&&i.skeleton,l=t.maxVertexUniformVectors,d=0<t.maxVertexTextures&&(!!t.getExtension("OES_texture_float")||2<=t.version),p=0;return d?p=1024:l<16*(p=i.skeleton?i.skeleton.bones.length:0)&&(console.warn("Program: too many bones ("+p+"), current cpu only support "+Math.floor(l/16)+" bones!!"),p=Math.floor(l/16)),h.useSkinning=u,h.bonesNum=p,h.useVertexTexture=d,n.type===g.SHADER&&(h.vertexShader=n.vertexShader,h.fragmentShader=n.fragmentShader),h}(_,m,e,t,r,s,o,h),u=function(e,t){var r="";for(var n in e)r+=e[n]+"_";if(void 0!==t.defines)for(var i in t.defines)r+=i+"_"+t.defines[i]+"_";return r}(c,t),l=0,d=v.length;l<d;l++){var p=v[l];if(p.code===u){++(i=p).usedTimes;break}}return void 0===i&&(a="",void 0!==t.defines&&(a=function(e){var t=[];for(var r in e){var n=e[r];!1!==n&&t.push("#define "+r+" "+n)}return t.join("\n")}(t.defines)),(i=mr(f,c,a)).code=u,v.push(i)),i},this.releaseProgram=function(e){var t;0==--e.usedTimes&&(t=v.indexOf(e),v[t]=v[v.length-1],v.pop(),e.dispose(f))},this.programs=v}function yr(e,t,r){this.gl=e,this.properties=t,this.capabilities=r}function wr(e,t,r,n,i,a){this.gl=e,this.state=t,this.texture=r,this.renderBuffer=n,this.properties=i,this.capabilities=a}Object.assign(yr.prototype,{setRenderBuffer:function(e){var t=this.gl,r=this.capabilities,n=this.properties.get(e);return void 0===n.__webglRenderbuffer?(e.addEventListener("dispose",this.onRenderBufferDispose,this),n.__webglRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,n.__webglRenderbuffer),0<e.multipleSampling?(r.version<2&&console.error("render buffer multipleSampling is not support in webgl 1.0."),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(e.multipleSampling,r.maxSamples),e.format,e.width,e.height)):t.renderbufferStorage(t.RENDERBUFFER,e.format,e.width,e.height)):t.bindRenderbuffer(t.RENDERBUFFER,n.__webglRenderbuffer),n},onRenderBufferDispose:function(e){var t=this.gl,r=e.target,n=this.properties.get(r);n.__webglRenderbuffer&&t.deleteRenderbuffer(n.__webglRenderbuffer),this.properties.delete(r)}}),Object.assign(wr.prototype,{setRenderTarget2D:function(e){var t=this.gl,r=this.state,n=this.texture,i=this.renderBuffer,a=this.capabilities,s=this.properties.get(e);if(void 0!==s.__webglFramebuffer)t.bindFramebuffer(t.FRAMEBUFFER,s.__webglFramebuffer);else{e.addEventListener("dispose",this.onRenderTargetDispose,this),s.__webglFramebuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,s.__webglFramebuffer);var o,h,c=[];for(var u in e._attachments){(u=Number(u))!==L.DEPTH_ATTACHMENT&&u!==L.DEPTH_STENCIL_ATTACHMENT||a.version<2&&!a.getExtension("WEBGL_depth_texture")&&console.warn("extension WEBGL_depth_texture is not support in webgl 1.0."),(u<=36073&&36064<=u||u<=577045&&577040<=u)&&c.push(u),e._attachments[u].isTexture?(o=n.setTexture2D(e._attachments[u]),t.framebufferTexture2D(t.FRAMEBUFFER,u,t.TEXTURE_2D,o.__webglTexture,0),r.bindTexture(t.TEXTURE_2D,null)):(h=i.setRenderBuffer(e._attachments[u]),t.framebufferRenderbuffer(t.FRAMEBUFFER,u,t.RENDERBUFFER,h.__webglRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null))}1<c.length&&(2<=a.version?t.drawBuffers(c):a.getExtension("WEBGL_draw_buffers")&&a.getExtension("WEBGL_draw_buffers").drawBuffersWEBGL(c));var l=t.checkFramebufferStatus(t.FRAMEBUFFER);l!==t.FRAMEBUFFER_COMPLETE&&(l===t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_ATTACHMENT"):l===t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"):l===t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_DIMENSIONS"):l===t.FRAMEBUFFER_UNSUPPORTED?console.warn("framebuffer not complete: FRAMEBUFFER_UNSUPPORTED"):l===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_MULTISAMPLE"):console.warn("framebuffer not complete."))}},setRenderTargetCube:function(e){var t=this.gl,r=this.state,n=this.texture,i=this.renderBuffer,a=this.capabilities,s=this.properties.get(e);if(void 0!==s.__webglFramebuffer){for(var o in t.bindFramebuffer(t.FRAMEBUFFER,s.__webglFramebuffer),e._attachments){e._attachments[o].isTexture&&(h=this.properties.get(e._attachments[o]),t.framebufferTexture2D(t.FRAMEBUFFER,o,t.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,h.__webglTexture,0))}s.__currentActiveCubeFace=e.activeCubeFace}else{e.addEventListener("dispose",this.onRenderTargetDispose,this),s.__webglFramebuffer=t.createFramebuffer(),s.__currentActiveCubeFace=e.activeCubeFace,t.bindFramebuffer(t.FRAMEBUFFER,s.__webglFramebuffer);var h,c,u=[];for(var o in e._attachments){(o=Number(o))!==L.DEPTH_ATTACHMENT&&o!==L.DEPTH_STENCIL_ATTACHMENT||a.version<2&&!a.getExtension("WEBGL_depth_texture")&&console.warn("extension WEBGL_depth_texture is not support in webgl 1.0."),(o<=36073&&36064<=o||o<=577045&&577040<=o)&&u.push(o),e._attachments[o].isTexture?(h=n.setTextureCube(e._attachments[o]),t.framebufferTexture2D(t.FRAMEBUFFER,o,t.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,h.__webglTexture,0),r.bindTexture(t.TEXTURE_CUBE_MAP,null)):(c=i.setRenderBuffer(e._attachments[o]),t.framebufferRenderbuffer(t.FRAMEBUFFER,o,t.RENDERBUFFER,c.__webglRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null))}1<u.length&&(2<=a.version?t.drawBuffers(u):a.getExtension("WEBGL_draw_buffers")&&a.getExtension("WEBGL_draw_buffers").drawBuffersWEBGL(u));var l=t.checkFramebufferStatus(t.FRAMEBUFFER);l!==t.FRAMEBUFFER_COMPLETE&&(l===t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_ATTACHMENT"):l===t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"):l===t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_DIMENSIONS"):l===t.FRAMEBUFFER_UNSUPPORTED?console.warn("framebuffer not complete: FRAMEBUFFER_UNSUPPORTED"):l===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE?console.warn("framebuffer not complete: FRAMEBUFFER_INCOMPLETE_MULTISAMPLE"):console.warn("framebuffer not complete."))}},blitRenderTarget:function(e,t,r,n,i){var a,s,o,h=this.gl,c=this.properties,u=this.capabilities;u.version<2?console.warn("blitFramebuffer not support by WebGL"+u.version):(a=c.get(e).__webglFramebuffer,s=c.get(t).__webglFramebuffer,h.bindFramebuffer(h.READ_FRAMEBUFFER,a),h.bindFramebuffer(h.DRAW_FRAMEBUFFER,s),void(o=0)!==r&&!r||(o|=h.COLOR_BUFFER_BIT),void 0!==n&&!n||(o|=h.DEPTH_BUFFER_BIT),void 0!==i&&!i||(o|=h.STENCIL_BUFFER_BIT),h.blitFramebuffer(0,0,e.width,e.height,0,0,t.width,t.height,o,h.NEAREST))},updateRenderTargetMipmap:function(e){var t,r,n,i=this.gl,a=this.state,s=e.texture;s.generateMipmaps&&(o((n=e).width)&&o(n.height))&&s.minFilter!==i.NEAREST&&s.minFilter!==i.LINEAR&&(t=s.textureType,r=this.properties.get(s).__webglTexture,a.bindTexture(t,r),i.generateMipmap(t),a.bindTexture(t,null))},onRenderTargetDispose:function(e){var t=this.gl,r=this.state,n=e.target,i=this.properties.get(n);for(var a in n.removeEventListener("dispose",this.onRenderTargetDispose,this),i.__webglFramebuffer&&t.deleteFramebuffer(i.__webglFramebuffer),n._attachments)n._attachments[a].dispose();this.properties.delete(n),r.currentRenderTarget===n&&(r.currentRenderTarget=null)},setRenderTarget:function(e){var t=this.gl,r=this.state;if(e.view)r.currentRenderTarget===e||(t.bindFramebuffer(t.FRAMEBUFFER,null),r.currentRenderTarget=e);else{var n=void 0!==e.activeCubeFace;if(r.currentRenderTarget!==e)n?this.setRenderTargetCube(e):this.setRenderTarget2D(e),r.currentRenderTarget=e;else if(n){var i=this.properties.get(e);if(i.__currentActiveCubeFace!==e.activeCubeFace){for(var a in e._attachments){var s=this.properties.get(e._attachments[a]);t.framebufferTexture2D(t.FRAMEBUFFER,a,t.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,s.__webglTexture,0)}i.__currentActiveCubeFace=e.activeCubeFace}}}}});var Tr=function(e,t,r){this._gl=e,this._properties=t,this._capabilities=r,this._isWebGL2=2<=r.version,this._vaoExt=r.getExtension("OES_vertex_array_object"),this._currentGeometryProgram=""};Tr.prototype.setup=function(e,t,r){var n,i,a=this._properties.get(t);e.morphTargetInfluences?(this._setupVertexAttributes(r,t),this._currentGeometryProgram=""):this._isWebGL2||this._vaoExt?(n=a._vaos[r.id]?a._vaos[r.id]:a._vaos[r.id]={version:-1,object:this._createVAO()},this._bindVAO(n.object),n.version!==t.version&&(this._setupVertexAttributes(r,t),n.version=t.version)):(i=r.id+"_"+t.id+"_"+t.version)!==this._currentGeometryProgram&&(this._setupVertexAttributes(r,t),this._currentGeometryProgram=i)},Tr.prototype._createVAO=function(){return this._isWebGL2?this._gl.createVertexArray():this._vaoExt?this._vaoExt.createVertexArrayOES():null},Tr.prototype._bindVAO=function(e){return this._isWebGL2?this._gl.bindVertexArray(e):this._vaoExt?this._vaoExt.bindVertexArrayOES(e):void 0},Tr.prototype.resetBinding=function(){this._isWebGL2?this._gl.bindVertexArray(null):this._vaoExt&&this._vaoExt.bindVertexArrayOES(null)},Tr.prototype.disposeVAO=function(e){this._isWebGL2?this._gl.deleteVertexArray(e):this._vaoExt&&this._vaoExt.deleteVertexArrayOES(e)},Tr.prototype._setupVertexAttributes=function(e,t){var r,n=this._gl,i=this._isWebGL2,a=e.attributes,s=this._properties,o=this._capabilities;for(var h in a){var c,u,l,d,p,f,_,m,v,g=a[h],M=t.getAttribute(h);M&&(c=M.normalized,u=M.size,g.count!==u&&console.warn("WebGLVertexArrayBindings: attribute "+h+" size not match! "+g.count+" : "+u),d=(l=M.isInterleavedBufferAttribute?s.get(M.data):s.get(M)).buffer,p=l.type,g.format,f=l.bytesPerElement,M.isInterleavedBufferAttribute?(m=(_=M.data).stride,v=M.offset,n.enableVertexAttribArray(g.location),_&&_.isInstancedInterleavedBuffer&&(i?n.vertexAttribDivisor(g.location,_.meshPerAttribute):o.getExtension("ANGLE_instanced_arrays")?o.getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(g.location,_.meshPerAttribute):console.warn("vertexAttribDivisor not supported"),void 0===t.maxInstancedCount&&(t.maxInstancedCount=_.meshPerAttribute*_.count)),n.bindBuffer(n.ARRAY_BUFFER,d),n.vertexAttribPointer(g.location,g.count,p,c,f*m,f*v)):(n.enableVertexAttribArray(g.location),M.isInstancedBufferAttribute&&(i?n.vertexAttribDivisor(g.location,M.meshPerAttribute):o.getExtension("ANGLE_instanced_arrays")?o.getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(g.location,M.meshPerAttribute):console.warn("vertexAttribDivisor not supported"),void 0===t.maxInstancedCount&&(t.maxInstancedCount=M.meshPerAttribute*M.count)),n.bindBuffer(n.ARRAY_BUFFER,d),n.vertexAttribPointer(g.location,g.count,p,c,0,0)))}t.index&&(r=s.get(t.index),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r.buffer))};var br,Ar=new D,Pr=new ee,Nr=new WeakMap,Cr=new Float32Array(8);function Lr(e){return e.material}function Rr(e){return!0}function Or(){}var Fr=new le;function Ur(e){this.gl=e;var t=new Ft;this.properties=t;var r=new Pt(e);this.capabilities=r;var n=new Ot(e,r);this.state=n;var i=new Tr(e,t,r);this.vertexArrayBindings=i;var a=new Gt(e,n,t,r);this.texture=a;var s=new yr(e,t,r);this.renderTarget=new wr(e,n,a,s,t,r),this.geometry=new Vt(e,n,i,t,r),this.programs=new xr(e,n,r),this._usedTextureUnits=0}Object.assign(Ur.prototype,{clear:function(e,t,r){var n=this.gl,i=0;void 0!==e&&!e||(i|=n.COLOR_BUFFER_BIT),void 0!==t&&!t||(i|=n.DEPTH_BUFFER_BIT),void 0!==r&&!r||(i|=n.STENCIL_BUFFER_BIT),n.clear(i)},render:function(t,e,r){var n=(r=void 0===r||r)?t.updateRenderList(e):t.getRenderList(e);this.renderPass(n.opaque,e,{scene:t,getMaterial:function(e){return t.overrideMaterial||e.material}}),this.renderPass(n.transparent,e,{scene:t,getMaterial:function(e){return t.overrideMaterial||e.material}})},renderPass:function(e,t,r){r=r||{};for(var n=this.gl,i=this.state,a=r.getMaterial||Lr,s=r.beforeRender||Or,o=r.afterRender||Or,h=r.ifRender||Rr,c=r.scene||{},u=i.currentRenderTarget,l=0,d=e.length;l<d;l++){var p=e[l];if(h(p)){var f=p.object,_=a.call(this,p),m=p.geometry,v=p.group;f.onBeforeRender(p,_),s.call(this,p,_);var g,M,E=this.properties.get(_);!1===_.needsUpdate&&(void 0===E.program||E.fog!==c.fog||c.clippingPlanes&&c.clippingPlanes.length!==E.numClippingPlanes||t.outputEncoding!==E.outputEncoding||t.gammaFactor!==E.gammaFactor||(g=_.acceptLight&&!!c.lights&&0<c.lights.totalNum)!==E.acceptLight?_.needsUpdate=!0:g&&(c.lights.hash.compare(E.lightsHash)&&f.receiveShadow===E.receiveShadow&&f.shadowType===E.shadowType||(_.needsUpdate=!0))),_.needsUpdate&&(void 0===E.program&&_.addEventListener("dispose",this.onMaterialDispose,this),M=E.program,E.program=this.programs.getProgram(t,_,f,c),M&&this.programs.releaseProgram(M),E.fog=c.fog,c.lights?(E.acceptLight=_.acceptLight,E.lightsHash=c.lights.hash.copyTo(E.lightsHash),E.receiveShadow=f.receiveShadow,E.shadowType=f.shadowType):E.acceptLight=!1,E.numClippingPlanes=c.clippingPlanes?c.clippingPlanes.length:0,E.outputEncoding=t.outputEncoding,E.gammaFactor=t.gammaFactor,_.needsUpdate=!1);var S=E.program;i.setProgram(S),this.geometry.setGeometry(m),f.morphTargetInfluences&&this.updateMorphtargets(f,m,S),this.vertexArrayBindings.setup(f,m,S);for(var x=S.uniforms,y=0,w=x.seq.length;y<w;y++){var T,b,A=x.seq[y],P=A.id;if(_.uniforms&&void 0!==_.uniforms[P])A.set(_.uniforms[P],this);else switch(P){case"u_Projection":T=f.type===G.CANVAS2D&&f.isScreenCanvas?f.orthoCamera.projectionMatrix.elements:t.projectionMatrix.elements,A.set(T);break;case"u_View":b=f.type===G.CANVAS2D&&f.isScreenCanvas?f.orthoCamera.viewMatrix.elements:t.viewMatrix.elements,A.set(b);break;case"u_Model":var N=f.worldMatrix.elements;A.set(N);break;case"u_Color":var C=_.diffuse;A.setValue(C.r,C.g,C.b);break;case"u_Opacity":A.set(_.opacity);break;case"diffuseMap":A.set(_.diffuseMap,this);break;case"alphaMap":A.set(_.alphaMap,this);break;case"normalMap":A.set(_.normalMap,this);break;case"bumpMap":A.set(_.bumpMap,this);break;case"bumpScale":A.set(_.bumpScale);break;case"envMap":A.set(_.envMap,this);break;case"cubeMap":A.set(_.cubeMap,this);break;case"u_EnvMap_Intensity":A.set(_.envMapIntensity);break;case"maxMipLevel":A.set(this.properties.get(_.envMap).__maxMipLevel||0);break;case"u_Specular":A.set(_.shininess);break;case"u_SpecularColor":C=_.specular;A.setValue(C.r,C.g,C.b);break;case"specularMap":A.set(_.specularMap,this);break;case"aoMap":A.set(_.aoMap,this);break;case"aoMapIntensity":A.set(_.aoMapIntensity);break;case"u_Roughness":A.set(_.roughness);break;case"roughnessMap":A.set(_.roughnessMap,this);break;case"u_Metalness":A.set(_.metalness);break;case"metalnessMap":A.set(_.metalnessMap,this);break;case"glossiness":A.set(_.glossiness);break;case"glossinessMap":A.set(_.glossinessMap,this);break;case"emissive":var C=_.emissive,L=_.emissiveIntensity;A.setValue(C.r*L,C.g*L,C.b*L);break;case"emissiveMap":A.set(_.emissiveMap,this);break;case"u_CameraPosition":Ar.setFromMatrixPosition(t.worldMatrix),A.setValue(Ar.x,Ar.y,Ar.z);break;case"u_FogColor":C=c.fog.color;A.setValue(C.r,C.g,C.b);break;case"u_FogDensity":A.set(c.fog.density);break;case"u_FogNear":A.set(c.fog.near);break;case"u_FogFar":A.set(c.fog.far);break;case"u_PointSize":A.set(_.size);break;case"u_PointScale":var R=.5*u.height;A.set(R);break;case"dashSize":A.set(_.dashSize);break;case"totalSize":A.set(_.dashSize+_.gapSize);break;case"scale":A.set(_.scale);break;case"matcap":A.set(_.matcap,this);break;case"clippingPlanes":var O=function(e){(!br||br.length<4*e.length)&&(br=new Float32Array(4*e.length));for(var t=0;t<e.length;t++)Fr.copy(e[t]),br[4*t+0]=Fr.normal.x,br[4*t+1]=Fr.normal.y,br[4*t+2]=Fr.normal.z,br[4*t+3]=Fr.constant;return br}(c.clippingPlanes||[]);A.set(O);break;case"uvTransform":var F=_.diffuseMap||_.specularMap||_.normalMap||_.bumpMap||_.roughnessMap||_.metalnessMap||_.emissiveMap;F&&(F.matrixAutoUpdate&&F.updateMatrix(),A.set(F.matrix.elements));break;case"alphaMapUVTransform":_.alphaMap.updateMatrix(),A.set(_.alphaMap.matrix.elements)}}f.type===G.SKINNED_MESH&&this.uploadSkeleton(x,f,S.program),_.acceptLight&&c.lights&&this.uploadLights(x,c.lights,f.receiveShadow,t);var U=f.worldMatrix.determinant()<0;this.setStates(_,U);var D=Pr.set(u.width,u.height,u.width,u.height).multiply(t.rect);if(D.z-=D.x,D.w-=D.y,D.x=Math.floor(D.x),D.y=Math.floor(D.y),D.z=Math.floor(D.z),D.w=Math.floor(D.w),f.type===G.CANVAS2D){f.isScreenCanvas&&(f.setRenderViewport(D.x,D.y,D.z,D.w),i.viewport(f.viewport.x,f.viewport.y,f.viewport.z,f.viewport.w));for(var I=0,B=0;B<f.drawArray.length;B++){var z=f.drawArray[B];x.set("spriteTexture",z.texture,this),n.drawElements(n.TRIANGLES,6*z.count,n.UNSIGNED_SHORT,2*I),I+=6*z.count,this._usedTextureUnits=0}}else i.viewport(D.x,D.y,D.z,D.w),this.draw(m,_,v);this.vertexArrayBindings.resetBinding(),this._usedTextureUnits=0,i.depthBuffer.setTest(!0),i.depthBuffer.setMask(!0),i.colorBuffer.setMask(!0),o(this,p),f.onAfterRender(p)}}},setStates:function(e,t){var r=this.state;r.setCullFace(e.side===E.DOUBLE?l.NONE:l.BACK);var n=e.side===E.BACK;t&&(n=!n),r.setFlipSided(n),e.transparent?r.setBlend(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha):r.setBlend(c.NONE),r.depthBuffer.setFunc(e.depthFunc),r.depthBuffer.setTest(e.depthTest),r.depthBuffer.setMask(e.depthWrite),r.colorBuffer.setMask(e.colorWrite);var i=e.stencilTest;r.stencilBuffer.setTest(i),i&&(r.stencilBuffer.setMask(e.stencilWriteMask),r.stencilBuffer.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask,e.stencilFuncBack,e.stencilRefBack,e.stencilFuncMaskBack),r.stencilBuffer.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass,e.stencilFailBack,e.stencilZFailBack,e.stencilZPassBack)),r.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),void 0!==e.lineWidth&&r.setLineWidth(e.lineWidth)},draw:function(e,t,r){var n,i,a,s=this.gl,o=this.properties,h=this.capabilities,c=null!==e.index,u=c?e.index.count:e.getAttribute("a_Position").count,l=r?r.start:0,d=r?r.count:1/0,p=Math.max(0,l),u=Math.min(u,d);c?(i=(n=o.get(e.index)).bytesPerElement,(a=n.type)===s.UNSIGNED_INT&&h.version<2&&!h.getExtension("OES_element_index_uint")&&console.warn("draw elements type not support UNSIGNED_INT!"),e.isInstancedGeometry?0<e.maxInstancedCount&&(2<=h.version?s.drawElementsInstanced(t.drawMode,u,a,p*i,e.maxInstancedCount):h.getExtension("ANGLE_instanced_arrays")?h.getExtension("ANGLE_instanced_arrays").drawElementsInstancedANGLE(t.drawMode,u,a,p*i,e.maxInstancedCount):console.warn("no support instanced draw.")):s.drawElements(t.drawMode,u,a,p*i)):e.isInstancedGeometry?0<e.maxInstancedCount&&(2<=h.version?s.drawArraysInstanced(t.drawMode,p,u,e.maxInstancedCount):h.getExtension("ANGLE_instanced_arrays")?h.getExtension("ANGLE_instanced_arrays").drawArraysInstancedANGLE(t.drawMode,p,u,e.maxInstancedCount):console.warn("no support instanced draw.")):s.drawArrays(t.drawMode,p,u)},uploadSkeleton:function(e,t,r){var n,i,a,s,o;t.skeleton&&0<t.skeleton.bones.length&&(n=t.skeleton,i=this.capabilities,n.updateBones(),0<i.maxVertexTextures&&(i.getExtension("OES_texture_float")||2<=i.version)?(void 0===n.boneTexture&&(a=Math.sqrt(4*n.bones.length),a=h(Math.ceil(a)),a=Math.max(4,a),(s=new Float32Array(a*a*4)).set(n.boneMatrices),(o=new Fe).image={data:s,width:a,height:a},2<=i.version&&(o.internalformat=x.RGBA32F,o.format=x.RGBA),o.type=y.FLOAT,o.magFilter=_.NEAREST,o.minFilter=_.NEAREST,o.generateMipmaps=!1,o.flipY=!1,n.boneMatrices=s,n.boneTexture=o),e.set("boneTexture",n.boneTexture,this),e.set("boneTextureSize",n.boneTexture.image.width)):e.set("boneMatrices",n.boneMatrices),e.set("bindMatrix",t.bindMatrix.elements),e.set("bindMatrixInverse",t.bindMatrixInverse.elements))},uploadLights:function(e,t,r,n){0<t.ambientsNum&&e.set("u_AmbientLightColor",t.ambient),0<t.directsNum&&(e.set("u_Directional",t.directional),e.has("directionalShadowMap")&&(2<=this.capabilities.version?e.set("directionalShadowMap",t.directionalShadowDepthMap,this):e.set("directionalShadowMap",t.directionalShadowMap,this),e.set("directionalShadowMatrix",t.directionalShadowMatrix)),e.has("directionalDepthMap")&&e.set("directionalDepthMap",t.directionalShadowMap,this)),0<t.pointsNum&&(e.set("u_Point",t.point),e.has("pointShadowMap")&&e.set("pointShadowMap",t.pointShadowMap,this)),0<t.spotsNum&&(e.set("u_Spot",t.spot),e.has("spotShadowMap")&&(2<=this.capabilities.version?e.set("spotShadowMap",t.spotShadowDepthMap,this):e.set("spotShadowMap",t.spotShadowMap,this),e.set("spotShadowMatrix",t.spotShadowMatrix)),e.has("spotDepthMap")&&e.set("spotDepthMap",t.spotShadowMap,this))},allocTexUnit:function(){var e=this._usedTextureUnits;return e>=this.capabilities.maxTextures&&console.warn("trying to use "+e+" texture units while this GPU supports only "+this.capabilities.maxTextures),this._usedTextureUnits+=1,e},updateMorphtargets:function(e,t,r){var n=e.morphTargetInfluences;Nr.has(t)||Nr.set(t,n.slice(0));for(var i=t.morphAttributes.position,a=t.morphAttributes.normal,s=Nr.get(t),o=0;o<s.length;o++){0!==(h=s[o])&&(i&&t.removeAttribute("morphTarget"+o),a&&t.removeAttribute("morphNormal"+o))}for(o=0;o<n.length;o++)s[o]=n[o];s.length=n.length;for(var h,c=0,o=0;o<s.length;o++){0<(h=s[o])&&(i&&t.addAttribute("morphTarget"+c,i[o]),a&&t.addAttribute("morphNormal"+c,a[o]),Cr[c]=h,c++)}for(;c<8;c++)Cr[c]=0;r.uniforms.set("morphTargetInfluences",Cr)},onMaterialDispose:function(e){var t=e.target,r=this.properties.get(t);t.removeEventListener("dispose",this.onMaterialDispose,this);var n=r.program;void 0!==n&&this.programs.releaseProgram(n),this.properties.delete(t)}});var Dr=new K;function Ir(){ze.call(this),this.type=G.CAMERA,this.viewMatrix=new K,this.projectionMatrix=new K,this.projectionMatrixInverse=new K,this.frustum=new pe,this.gammaFactor=2,this.outputEncoding=A.LINEAR,this.rect=new ee(0,0,1,1),this.frustumCulled=!0}function Br(e,t){R.call(this),this.width=e,this.height=t}function zr(e,t,r,n){R.call(this),this.width=e,this.height=t,this.format=void 0!==r?r:x.RGBA8,this.multipleSampling=void 0!==n?n:0}function Gr(e,t){Br.call(this,e,t),this._attachments={},this.attach(new Ue,L.COLOR_ATTACHMENT0),this.attach(new zr(e,t,x.DEPTH_STENCIL),L.DEPTH_STENCIL_ATTACHMENT),this.activeCubeFace=0}function kr(e){this.camera=new Ir,this.targets=[new D(1,0,0),new D(-1,0,0),new D(0,1,0),new D(0,-1,0),new D(0,0,1),new D(0,0,-1)],this.ups=[new D(0,-1,0),new D(0,-1,0),new D(0,0,1),new D(0,0,-1),new D(0,-1,0),new D(0,-1,0)],this.camera.setPerspective(.5*Math.PI,1,1,1e3),this.position=new D,this.lookTarget=new D,this.renderTarget=e||new Gr(512,512),this.renderTexture=this.renderTarget.texture,this.renderTexture.minFilter=_.LINEAR_MIPMAP_LINEAR}function Hr(){this.depthMaterial=new bt,this.depthMaterial.packToRGBA=!0,this.distanceMaterial=new At,this.oldClearColor=new ee}Ir.prototype=Object.assign(Object.create(ze.prototype),{constructor:Ir,lookAt:function(e,t){Dr.lookAtRH(this.position,e,t),this.quaternion.setFromRotationMatrix(Dr)},setOrtho:function(e,t,r,n,i,a){this.projectionMatrix.set(2/(t-e),0,0,-(t+e)/(t-e),0,2/(n-r),0,-(n+r)/(n-r),0,0,-2/(a-i),-(a+i)/(a-i),0,0,0,1),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},setPerspective:function(e,t,r,n){this.projectionMatrix.set(1/(t*Math.tan(e/2)),0,0,0,0,1/Math.tan(e/2),0,0,0,0,-(n+r)/(n-r),-2*n*r/(n-r),0,0,-1,0),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},getWorldDirection:function(e){e=e||new D;var t=this.worldMatrix.elements;return e.set(-t[8],-t[9],-t[10]).normalize()},updateMatrix:function(e){ze.prototype.updateMatrix.call(this,e),this.viewMatrix.getInverse(this.worldMatrix),Dr.multiplyMatrices(this.projectionMatrix,this.viewMatrix),this.frustum.setFromMatrix(Dr)},copy:function(e,t){return ze.prototype.copy.call(this,e,t),this.viewMatrix.copy(e.viewMatrix),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.frustum.copy(e.frustum),this.gammaFactor=e.gammaFactor,this.outputEncoding=e.outputEncoding,this.rect.copy(e.rect),this.frustumCulled=e.frustumCulled,this}}),Object.defineProperties(Ir.prototype,{gammaInput:{get:function(){return console.warn("zen3d.Camera: .gammaInput has been removed. Use texture.encoding instead."),!1},set:function(e){console.warn("zen3d.Camera: .gammaInput has been removed. Use texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("zen3d.Camera: .gammaOutput has been removed. Use .outputEncoding or renderTarget.texture.encoding instead."),this.outputEncoding==A.GAMMA},set:function(e){console.warn("zen3d.Camera: .gammaOutput has been removed. Use .outputEncoding or renderTarget.texture.encoding instead."),this.outputEncoding=e?A.GAMMA:A.LINEAR}}}),Br.prototype=Object.assign(Object.create(R.prototype),{constructor:Br,isRenderTarget:!0,resize:function(e,t){return(this.width!==e||this.height!==t)&&(this.dispose(),this.width=e,this.height=t,!0)},dispose:function(){this.dispatchEvent({type:"dispose"})}}),zr.prototype=Object.assign(Object.create(R.prototype),{constructor:zr,isRenderBuffer:!0,resize:function(e,t){return(this.width!==e||this.height!==t)&&(this.dispose(),this.width=e,this.height=t,!0)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.format=e.format,this.multipleSampling=e.multipleSampling,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),((Gr.prototype=Object.create(Br.prototype)).constructor=Gr).prototype=Object.assign(Object.create(Br.prototype),{constructor:Gr,attach:function(e,t){if(e.isTexture){for(var r=!1,n=0;n<6;n++)e.images[n]&&e.images[n].rtt?e.images[n].width===this.width&&e.images[n].height===this.height||(e.images[n].width=this.width,e.images[n].height=this.height,r=!0):(e.images[n]={rtt:!0,data:null,width:this.width,height:this.height},r=!0);r&&e.version++}else e.resize(this.width,this.height);this._attachments[t||L.COLOR_ATTACHMENT0]=e},detach:function(e){delete this._attachments[e||L.COLOR_ATTACHMENT0]},resize:function(e,t){if(Br.prototype.resize.call(this,e,t))for(var r in this._attachments){var n=this._attachments[r];if(n.isTexture){for(var i=0;i<6;i++)n.images[i]={rtt:!0,data:null,width:this.width,height:this.height};n.version++}else n.resize(e,t)}}}),Object.defineProperties(Gr.prototype,{texture:{set:function(e){e?e.isTexture&&this.attach(e,L.COLOR_ATTACHMENT0):this.detach(L.COLOR_ATTACHMENT0)},get:function(){var e=this._attachments[L.COLOR_ATTACHMENT0];return e.isTexture?e:null}}}),kr.prototype.render=function(e,t){this.camera.position.copy(this.position);for(var r=0;r<6;r++)this.lookTarget.set(this.targets[r].x+this.camera.position.x,this.targets[r].y+this.camera.position.y,this.targets[r].z+this.camera.position.z),this.camera.lookAt(this.lookTarget,this.ups[r]),this.camera.updateMatrix(),this.renderTarget.activeCubeFace=r,e.renderTarget.setRenderTarget(this.renderTarget),e.clear(!0,!0,!0),e.render(t,this.camera),e.renderTarget.updateRenderTargetMipmap(this.renderTarget)},Hr.prototype.render=function(e,t){var r=e.gl,n=e.state,i=n.states[r.STENCIL_TEST];i&&n.stencilBuffer.setTest(!1),this.oldClearColor.copy(n.colorBuffer.getClear()),n.colorBuffer.setClear(1,1,1,1);for(var a=t.lights.shadows,s=0;s<a.length;s++){var o=a[s],h=o.shadow,c=h.camera,u=h.renderTarget,l=o.lightType==m.POINT,d=l?6:1;2<=e.capabilities.version&&(l||h.depthMap||h._initDepthMap());for(var p=0;p<d;p++){l?(h.update(o,p),u.activeCubeFace=p):h.update(o);var f=t.updateRenderList(c);e.renderTarget.setRenderTarget(u),e.clear(!0,!0);var _=l?this.distanceMaterial:this.depthMaterial;_.uniforms=_.uniforms||{},_.uniforms.nearDistance=h.cameraNear,_.uniforms.farDistance=h.cameraFar,e.renderPass(f.opaque,c,{getMaterial:function(e){return _.side=e.material.side,_},ifRender:function(e){return e.object.castShadow}})}}i&&n.stencilBuffer.setTest(!0),n.colorBuffer.setClear(this.oldClearColor.x,this.oldClearColor.y,this.oldClearColor.z,this.oldClearColor.w)};var Vr=new D,jr=new WeakMap;function Wr(e){if(jr.has(e))return jr.get(e);var t;switch(e.lightType){case m.DIRECT:t={direction:new Float32Array(3),color:new Float32Array([0,0,0,1]),shadow:0,shadowBias:0,shadowRadius:1,shadowMapSize:new Float32Array(2)};break;case m.POINT:t={position:new Float32Array(3),color:new Float32Array([0,0,0,1]),distance:0,decay:0,shadow:0,shadowBias:0,shadowRadius:1,shadowMapSize:new Float32Array(2),shadowCameraNear:1,shadowCameraFar:1e3};break;case m.SPOT:t={position:new Float32Array(3),direction:new Float32Array(3),color:new Float32Array([0,0,0,1]),distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:0,shadowBias:0,shadowRadius:1,shadowMapSize:new Float32Array(2)}}return jr.set(e,t),t}function Xr(){this._factor=new Uint16Array(4)}function Yr(){this.ambient=new Float32Array([0,0,0]),this.directional=[],this.directionalShadowMap=[],this.directionalShadowDepthMap=[],this.directionalShadowMatrix=[],this.point=[],this.pointShadowMap=[],this.pointShadowMatrix=[],this.spot=[],this.spotShadowMap=[],this.spotShadowDepthMap=[],this.spotShadowMatrix=[],this.shadows=[],this.ambientsNum=0,this.directsNum=0,this.pointsNum=0,this.spotsNum=0,this.directShadowNum=0,this.pointShadowNum=0,this.spotShadowNum=0,this.shadowsNum=0,this.totalNum=0,this.hash=new Xr}Object.assign(Xr.prototype,{update:function(e){this._factor[0]=e.ambientsNum,this._factor[1]=e.directsNum,this._factor[2]=e.pointsNum,this._factor[3]=e.spotsNum},compare:function(e){return!!e&&!(this._factor[0]!==e[0]||this._factor[1]!==e[1]||this._factor[2]!==e[2]||this._factor[3]!==e[3])},copyTo:function(e){return(e=e||new Uint16Array(4)).set(this._factor),e}}),Object.assign(Yr.prototype,{startCount:function(){for(var e=0;e<3;e++)this.ambient[e]=0;this.shadows.length=0,this.ambientsNum=0,this.directsNum=0,this.pointsNum=0,this.spotsNum=0,this.directShadowNum=0,this.pointShadowNum=0,this.spotShadowNum=0,this.shadowsNum=0,this.totalNum=0},add:function(e){e.lightType==m.AMBIENT?this._doAddAmbientLight(e):e.lightType==m.DIRECT?this._doAddDirectLight(e):e.lightType==m.POINT?this._doAddPointLight(e):e.lightType==m.SPOT&&this._doAddSpotLight(e),e.castShadow&&e.lightType!==m.AMBIENT&&(this.shadows.push(e),this.shadowsNum++),this.totalNum++},endCount:function(){this.hash.update(this)},_doAddAmbientLight:function(e){var t=e.intensity,r=e.color;this.ambient[0]+=r.r*t,this.ambient[1]+=r.g*t,this.ambient[2]+=r.b*t,this.ambientsNum++},_doAddDirectLight:function(e){var t=e.intensity,r=e.color,n=Wr(e);n.color[0]=r.r*t,n.color[1]=r.g*t,n.color[2]=r.b*t;var i,a,s=Vr;e.getWorldDirection(s),n.direction[0]=s.x,n.direction[1]=s.y,n.direction[2]=s.z,e.castShadow?(n.shadow=1,n.shadowBias=e.shadow.bias,n.shadowRadius=e.shadow.radius,n.shadowMapSize[0]=e.shadow.mapSize.x,n.shadowMapSize[1]=e.shadow.mapSize.y,this.directShadowNum++):n.shadow=0,e.castShadow&&(i=16*(this.directsNum+1),this.directionalShadowMatrix.length<i&&(a=this.directionalShadowMatrix,this.directionalShadowMatrix=new Float32Array(i),this.directionalShadowMatrix.set(a)),this.directionalShadowMatrix.set(e.shadow.matrix.elements,16*this.directsNum),this.directionalShadowMap[this.directsNum]=e.shadow.map,this.directionalShadowDepthMap[this.directsNum]=e.shadow.depthMap),this.directional[this.directsNum]=n,this.directsNum++},_doAddPointLight:function(e){var t=e.intensity,r=e.color,n=e.distance,i=e.decay,a=Wr(e);a.color[0]=r.r*t,a.color[1]=r.g*t,a.color[2]=r.b*t,a.distance=n,a.decay=i;var s,o,h=Vr.setFromMatrixPosition(e.worldMatrix);a.position[0]=h.x,a.position[1]=h.y,a.position[2]=h.z,e.castShadow?(a.shadow=1,a.shadowBias=e.shadow.bias,a.shadowRadius=e.shadow.radius,a.shadowMapSize[0]=e.shadow.mapSize.x,a.shadowMapSize[1]=e.shadow.mapSize.y,a.shadowCameraNear=e.shadow.cameraNear,a.shadowCameraFar=e.shadow.cameraFar,this.pointShadowNum++):a.shadow=0,e.castShadow&&(s=16*(this.pointsNum+1),this.pointShadowMatrix.length<s&&(o=this.pointShadowMatrix,this.pointShadowMatrix=new Float32Array(s),this.pointShadowMatrix.set(o)),this.pointShadowMatrix.set(e.shadow.matrix.elements,16*this.pointsNum),this.pointShadowMap[this.pointsNum]=e.shadow.map),this.point[this.pointsNum]=a,this.pointsNum++},_doAddSpotLight:function(e){var t=e.intensity,r=e.color,n=e.distance,i=e.decay,a=Wr(e);a.color[0]=r.r*t,a.color[1]=r.g*t,a.color[2]=r.b*t,a.distance=n,a.decay=i;var s=Vr.setFromMatrixPosition(e.worldMatrix);a.position[0]=s.x,a.position[1]=s.y,a.position[2]=s.z;var o=Vr;e.getWorldDirection(Vr),a.direction[0]=o.x,a.direction[1]=o.y,a.direction[2]=o.z;var h,c,u=Math.cos(e.angle),l=Math.cos(e.angle*(1-e.penumbra));a.coneCos=u,a.penumbraCos=l,e.castShadow?(a.shadow=1,a.shadowBias=e.shadow.bias,a.shadowRadius=e.shadow.radius,a.shadowMapSize[0]=e.shadow.mapSize.x,a.shadowMapSize[1]=e.shadow.mapSize.y,this.spotShadowNum++):a.shadow=0,e.castShadow&&(h=16*(this.spotsNum+1),this.spotShadowMatrix.length<h&&(c=this.spotShadowMatrix,this.spotShadowMatrix=new Float32Array(h),this.spotShadowMatrix.set(c)),this.spotShadowMatrix.set(e.shadow.matrix.elements,16*this.spotsNum),this.spotShadowMap[this.spotsNum]=e.shadow.map,this.spotShadowDepthMap[this.spotsNum]=e.shadow.depthMap),this.spot[this.spotsNum]=a,this.spotsNum++}});function qr(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Zr(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.material.id!==t.material.id?e.material.id-t.material.id:e.id-t.id}var Kr=new D,Qr=new he;function $r(){var s=[],o=0,h=[],c=0,u=[],l=0;function d(e,t,r,n,i){var a=s[o];void 0===a?(a={object:e,geometry:t,material:r,z:n,renderOrder:e.renderOrder,group:i},s[o]=a):(a.object=e,a.geometry=t,a.material=r,a.z=n,a.renderOrder=e.renderOrder,a.group=i),r.transparent?(u[l]=a,l++):(h[c]=a,c++),o++}return{opaque:h,transparent:u,startCount:function(){l=c=o=0},add:function(e,t){if(e.frustumCulled&&t.frustumCulled&&(Qr.copy(e.geometry.boundingSphere).applyMatrix4(e.worldMatrix),!t.frustum.intersectsSphere(Qr)))return;if(Kr.setFromMatrixPosition(e.worldMatrix),Kr.project(t),Array.isArray(e.material))for(var r=e.geometry.groups,n=0;n<r.length;n++){var i=r[n],a=e.material[i.materialIndex];a&&d(e,e.geometry,a,Kr.z,i)}else d(e,e.geometry,e.material,Kr.z)},endCount:function(){h.length=c,u.length=l},sort:function(){h.sort(qr),u.sort(Zr)}}}function Jr(){ze.call(this),this.type=G.SCENE,this.overrideMaterial=null,this.fog=null,this.clippingPlanes=[],this.lights=new Yr,this._renderListMap=new WeakMap}Jr.prototype=Object.assign(Object.create(ze.prototype),{constructor:Jr,updateRenderList:function(e){this._renderListMap.has(e)||this._renderListMap.set(e,new $r);var t=this._renderListMap.get(e);return t.startCount(),this._doUpdateRenderList(this,e,t),t.endCount(),t.sort(),t},getRenderList:function(e){return this._renderListMap.get(e)},updateLights:function(){var e=this.lights;return e.startCount(),this._doUpdateLights(this),e.endCount(),e},_doUpdateRenderList:function(e,t,r){if(e.visible&&(e.geometry&&e.material&&r.add(e,t),G.CANVAS2D!==e.type))for(var n=e.children,i=0,a=n.length;i<a;i++)this._doUpdateRenderList(n[i],t,r)},_doUpdateLights:function(e){if(e.visible&&(G.LIGHT===e.type&&this.lights.add(e),G.CANVAS2D!==e.type))for(var t=e.children,r=0,n=t.length;r<n;r++)this._doUpdateLights(t[r])}});var en=new he,tn=new ae,rn=new K,nn=new k,an=new D,sn=new D,on=new D,hn=new D,cn=new J,un=new J,ln=new J,dn=new D,pn=new D;function fn(e,t){ze.call(this),this.geometry=e,this.material=t,this.morphTargetInfluences=null,this.type=G.MESH}function _n(e){var t=new Jr,r=this.camera=new Ir;r.frustumCulled=!1,r.position.set(0,1,0),r.lookAt(new D(0,0,0),new D(0,0,-1)),r.setOrtho(-1,1,-1,1,.1,2),t.add(r);var n=new dt(2,2,1,1),i=this.material=new Tt(e);this.uniforms=i.uniforms;var a=new fn(n,i);a.frustumCulled=!1,t.add(a),t.updateMatrix(),this.renderList=t.updateRenderList(r),this.renderConfig={}}function mn(e){Br.call(this,e.width,e.height),this.view=e}function vn(e,t){var r={antialias:!0,alpha:!1,stencil:!0},n=e.getContext("webgl2",t||r)||e.getContext("webgl",t||r);this.glCore=new Ur(n),console.info("ForwardRenderer use WebGL Version: "+this.glCore.capabilities.version),this.backRenderTarget=new mn(e),this.shadowMapPass=new Hr,this.shadowAutoUpdate=!0,this.shadowNeedsUpdate=!1,this.matrixAutoUpdate=!0,this.lightsAutoupdate=!0,this.autoClear=!0}function gn(e,t){Br.call(this,e,t),this._attachments={},this.attach(new Fe,L.COLOR_ATTACHMENT0),this.attach(new zr(e,t,x.DEPTH_STENCIL),L.DEPTH_STENCIL_ATTACHMENT)}function Mn(){ze.call(this),this.type=G.GROUP}function En(e,t){ze.call(this),this.type=G.LIGHT,this.lightType="",this.color=new fe(void 0!==e?e:16777215),this.intensity=void 0!==t?t:1}function Sn(e,t){En.call(this,e,t),this.lightType=m.AMBIENT}function xn(){this.camera=new Ir,this.matrix=new K,this.bias=3e-4,this.radius=2,this.cameraNear=1,this.cameraFar=500,this.mapSize=new J(512,512),this.renderTarget=null,this.map=null}function yn(){xn.call(this),this.camera.frustumCulled=!1,this.renderTarget=new gn(this.mapSize.x,this.mapSize.y);var e=this.renderTarget.texture;e.generateMipmaps=!1,e.minFilter=_.LINEAR,this.map=e,this.depthMap=null,this.windowSize=500,this._lookTarget=new D,this._up=new D(0,1,0)}function wn(e,t){En.call(this,e,t),this.lightType=m.DIRECT,this.shadow=new yn}function Tn(){xn.call(this),this.renderTarget=new Gr(this.mapSize.x,this.mapSize.y);var e=this.renderTarget.texture;e.generateMipmaps=!1,e.minFilter=_.LINEAR,this.map=e,this._targets=[new D(1,0,0),new D(-1,0,0),new D(0,1,0),new D(0,-1,0),new D(0,0,1),new D(0,0,-1)],this._ups=[new D(0,-1,0),new D(0,-1,0),new D(0,0,1),new D(0,0,-1),new D(0,-1,0),new D(0,-1,0)],this._lookTarget=new D}function bn(e,t,r,n){En.call(this,e,t),this.lightType=m.POINT,this.decay=void 0!==n?n:1,this.distance=void 0!==r?r:200,this.shadow=new Tn}function An(){xn.call(this),this.renderTarget=new gn(this.mapSize.x,this.mapSize.y);var e=this.renderTarget.texture;e.generateMipmaps=!1,e.minFilter=_.LINEAR,this.map=e,this.depthMap=null,this._lookTarget=new D,this._up=new D(0,1,0)}function Pn(e,t,r,n,i,a){En.call(this,e,t),this.lightType=m.SPOT,this.decay=void 0!==a?a:1,this.distance=void 0!==r?r:200,this.penumbra=void 0!==i?i:0,this.angle=void 0!==n?n:Math.PI/6,this.shadow=new An}function Nn(e,t){fn.call(this,e,t),this.type=G.SKINNED_MESH,this.skeleton=void 0,this.bindMode="attached",this.bindMatrix=new K,this.bindMatrixInverse=new K}fn.prototype=Object.assign(Object.create(ze.prototype),{constructor:fn,raycast:function(e,t){var r=this.geometry,n=this.worldMatrix;if(en.copy(r.boundingSphere),en.applyMatrix4(n),e.ray.intersectsSphere(en)&&(tn.copy(r.boundingBox),tn.applyMatrix4(n),e.ray.intersectsBox(tn))){rn.getInverse(n),nn.copy(e.ray).applyMatrix4(rn);for(var i,a,s,o,h,c,u=r.index.array,l=r.getAttribute("a_Position"),d=r.getAttribute("a_Uv"),p=0;p<u.length;p+=3){i=u[p],a=u[p+1],s=u[p+2],sn.fromArray(l.array,3*i),on.fromArray(l.array,3*a),hn.fromArray(l.array,3*s);var f=function(e,t,r,n,i,a,s){var o,h=e.material;o=h.side===E.BACK?r.intersectTriangle(a,i,n,!0,s):r.intersectTriangle(n,i,a,h.side!==E.DOUBLE,s);if(null===o)return null;pn.copy(s),pn.applyMatrix4(e.worldMatrix);var c=t.ray.origin.distanceTo(pn);if(c<t.near||c>t.far)return null;return{distance:c,point:pn.clone(),object:e}}(this,e,nn,sn,on,hn,dn);f&&(cn.fromArray(d.array,2*i),un.fromArray(d.array,2*a),ln.fromArray(d.array,2*s),f.uv=(o=cn,h=un,c=ln,Ee.barycoordFromPoint(dn,sn,on,hn,an),o.multiplyScalar(an.x),h.multiplyScalar(an.y),c.multiplyScalar(an.z),o.add(h).add(c),o.clone()),f.face=[i,a,s],f.faceIndex=i,t.push(f))}}},copy:function(e){return ze.prototype.copy.call(this,e),e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),this},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),_n.prototype.render=function(e){e.renderPass(this.renderList.opaque,this.camera,this.renderConfig)},mn.prototype=Object.assign(Object.create(Br.prototype),{constructor:mn,resize:function(e,t){this.view.width=e,this.view.height=t,this.width=e,this.height=t},dispose:function(){}}),vn.prototype.render=function(e,t,r,n){this.matrixAutoUpdate&&e.updateMatrix(),this.lightsAutoupdate&&e.updateLights(),(this.shadowAutoUpdate||this.shadowNeedsUpdate)&&(this.shadowMapPass.render(this.glCore,e),this.shadowNeedsUpdate=!1),void 0===r&&(r=this.backRenderTarget),this.glCore.renderTarget.setRenderTarget(r),(this.autoClear||n)&&this.glCore.clear(!0,!0,!0),this.glCore.render(e,t),r.texture&&this.glCore.renderTarget.updateRenderTargetMipmap(r)},gn.prototype=Object.assign(Object.create(Br.prototype),{constructor:gn,attach:function(e,t){e.isTexture?e.image&&e.image.rtt?e.image.width===this.width&&e.image.height===this.height||(e.version++,e.image.width=this.width,e.image.height=this.height):(e.version++,e.image={rtt:!0,data:null,width:this.width,height:this.height}):e.resize(this.width,this.height),this._attachments[t||L.COLOR_ATTACHMENT0]=e},detach:function(e){delete this._attachments[e||L.COLOR_ATTACHMENT0]},resize:function(e,t){var r=Br.prototype.resize.call(this,e,t);if(r)for(var n in this._attachments){var i=this._attachments[n];i.isTexture?(i.image={rtt:!0,data:null,width:this.width,height:this.height},i.version++):i.resize(e,t)}return r}}),Object.defineProperties(gn.prototype,{texture:{set:function(e){e?e.isTexture&&this.attach(e,L.COLOR_ATTACHMENT0):this.detach(L.COLOR_ATTACHMENT0)},get:function(){var e=this._attachments[L.COLOR_ATTACHMENT0];return e.isTexture?e:null}}}),(Mn.prototype=Object.create(ze.prototype)).constructor=Mn,En.prototype=Object.assign(Object.create(ze.prototype),{constructor:En,copy:function(e){return ze.prototype.copy.call(this,e),this.type=e.type,this.lightType=e.lightType,this.color.copy(e.color),this.intensity=e.intensity,this}}),(Sn.prototype=Object.create(En.prototype)).constructor=Sn,Object.assign(xn.prototype,{update:function(e,t){},copy:function(e){return this.camera.copy(e.camera),this.matrix.copy(e.matrix),this.bias=e.bias,this.radius=e.radius,this.cameraNear=e.cameraNear,this.cameraFar=e.cameraFar,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)}}),yn.prototype=Object.assign(Object.create(xn.prototype),{constructor:yn,update:function(e){this._updateCamera(e),this._updateMatrix(),this.mapSize.x===this.renderTarget.width&&this.mapSize.y===this.renderTarget.height||this.renderTarget.resize(this.mapSize.x,this.mapSize.y)},_updateCamera:function(e){var t=this.camera,r=this._lookTarget;e.getWorldDirection(this._lookTarget),t.position.setFromMatrixPosition(e.worldMatrix),r.set(r.x+t.position.x,r.y+t.position.y,r.z+t.position.z),t.lookAt(r,this._up),t.updateMatrix();var n=this.windowSize/2;t.setOrtho(-n,n,-n,n,this.cameraNear,this.cameraFar)},_updateMatrix:function(){var e=this.matrix,t=this.camera;e.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),e.multiply(t.projectionMatrix),e.multiply(t.viewMatrix)},copy:function(e){return xn.prototype.copy.call(this,e),this.windowSize=e.windowSize,this},_initDepthMap:function(){var e=new Fe;e.type=y.FLOAT_32_UNSIGNED_INT_24_8_REV,e.format=x.DEPTH_STENCIL,e.internalformat=x.DEPTH32F_STENCIL8,e.magFilter=_.LINEAR,e.minFilter=_.LINEAR,e.compare=p.LESS,e.generateMipmaps=!1,this.renderTarget.attach(e,L.DEPTH_STENCIL_ATTACHMENT),this.depthMap=e}}),wn.prototype=Object.assign(Object.create(En.prototype),{constructor:wn,copy:function(e){return En.prototype.copy.call(this,e),this.shadow.copy(e.shadow),this}}),Tn.prototype=Object.assign(Object.create(xn.prototype),{constructor:Tn,update:function(e,t){this._updateCamera(e,t),this._updateMatrix(),this.mapSize.x===this.renderTarget.width&&this.mapSize.y===this.renderTarget.height||this.renderTarget.resize(this.mapSize.x,this.mapSize.y)},_updateCamera:function(e,t){var r=this.camera,n=this._lookTarget,i=this._targets,a=this._ups;r.position.setFromMatrixPosition(e.worldMatrix),n.set(i[t].x+r.position.x,i[t].y+r.position.y,i[t].z+r.position.z),r.lookAt(n,a[t]),r.updateMatrix(),r.setPerspective(.5*Math.PI,1,this.cameraNear,this.cameraFar)},_updateMatrix:function(){var e=this.matrix,t=this.camera;e.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),e.multiply(t.projectionMatrix),e.multiply(t.viewMatrix)}}),bn.prototype=Object.assign(Object.create(En.prototype),{constructor:bn,copy:function(e){return En.prototype.copy.call(this,e),this.shadow.copy(e.shadow),this}}),An.prototype=Object.assign(Object.create(xn.prototype),{constructor:An,update:function(e){this._updateCamera(e),this._updateMatrix(),this.mapSize.x===this.renderTarget.width&&this.mapSize.y===this.renderTarget.height||this.renderTarget.resize(this.mapSize.x,this.mapSize.y)},_updateCamera:function(e){var t=this.camera,r=this._lookTarget;e.getWorldDirection(this._lookTarget),t.position.setFromMatrixPosition(e.worldMatrix),r.set(r.x+t.position.x,r.y+t.position.y,r.z+t.position.z),t.lookAt(r,this._up),t.updateMatrix(),t.setPerspective(2*e.angle,1,this.cameraNear,this.cameraFar)},_updateMatrix:function(){var e=this.matrix,t=this.camera;e.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),e.multiply(t.projectionMatrix),e.multiply(t.viewMatrix)},_initDepthMap:function(){var e=new Fe;e.type=y.FLOAT_32_UNSIGNED_INT_24_8_REV,e.format=x.DEPTH_STENCIL,e.internalformat=x.DEPTH32F_STENCIL8,e.magFilter=_.LINEAR,e.minFilter=_.LINEAR,e.compare=p.LESS,e.generateMipmaps=!1,this.renderTarget.attach(e,L.DEPTH_STENCIL_ATTACHMENT),this.depthMap=e}}),Pn.prototype=Object.assign(Object.create(En.prototype),{constructor:Pn,copy:function(e){return En.prototype.copy.call(this,e),this.shadow.copy(e.shadow),this}}),Nn.prototype=Object.assign(Object.create(fn.prototype),{constructor:Nn,bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrix(),t=this.worldMatrix),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},updateMatrix:function(e){fn.prototype.updateMatrix.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.worldMatrix):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("zen3d.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),e.ATTACHMENT=L,e.AmbientLight=Sn,e.AnimationMixer=Ye,e.BLEND_EQUATION=s,e.BLEND_FACTOR=u,e.BLEND_TYPE=c,e.BasicMaterial=vt,e.Bone=Ge,e.BooleanKeyframeTrack=Ze,e.Box2=ne,e.Box3=ae,e.BufferAttribute=rt,e.CULL_FACE_TYPE=l,e.Camera=Ir,e.Color3=fe,e.ColorKeyframeTrack=Ke,e.CubeGeometry=at,e.Curve=Te,e.CylinderGeometry=st,e.DRAW_BUFFER={DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868},e.DRAW_MODE=N,e.DRAW_SIDE=E,e.DefaultLoadingManager=Ne,e.DepthMaterial=bt,e.DirectionalLight=wn,e.DirectionalLightShadow=yn,e.DistanceMaterial=At,e.ENVMAP_COMBINE_TYPE=P,e.EnvironmentMapPass=kr,e.Euler=$,e.EventDispatcher=R,e.FOG_TYPE=M,e.FileLoader=Le,e.Fog=function(e,t,r){this.fogType=M.NORMAL,this.color=new fe(void 0!==e?e:0),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3},e.FogExp2=function(e,t){this.fogType=M.EXP2,this.color=new fe(void 0!==e?e:0),this.density=void 0!==t?t:25e-5},e.Frustum=pe,e.Geometry=it,e.Group=Mn,e.ImageLoader=Ce,e.InstancedBufferAttribute=ot,e.InstancedGeometry=ht,e.InstancedInterleavedBuffer=ut,e.InterleavedBuffer=ct,e.InterleavedBufferAttribute=lt,e.KeyframeClip=Qe,e.KeyframeTrack=qe,e.LIGHT_TYPE=m,e.LambertMaterial=gt,e.Light=En,e.LightCache=Yr,e.LightShadow=xn,e.LineMaterial=wt,e.LoadingManager=Pe,e.MATERIAL_TYPE=g,e.MatcapMaterial=xt,e.Material=mt,e.Matrix3=te,e.Matrix4=K,e.Mesh=fn,e.NumberKeyframeTrack=$e,e.OBJECT_TYPE=G,e.Object3D=ze,e.PBR2Material=St,e.PBRMaterial=Et,e.PhongMaterial=Mt,e.Plane=le,e.PlaneGeometry=dt,e.PointLight=bn,e.PointLightShadow=Tn,e.PointsMaterial=yt,e.PropertyBindingMixer=Xe,e.Quaternion=re,e.QuaternionKeyframeTrack=Je,e.RGBELoader=Oe,e.Ray=k,e.Raycaster=H,e.RenderBuffer=zr,e.RenderList=$r,e.RenderTarget2D=gn,e.RenderTargetBack=mn,e.RenderTargetBase=Br,e.RenderTargetCube=Gr,e.Renderer=vn,e.SHADING_TYPE=S,e.SHADOW_TYPE=b,e.Scene=Jr,e.ShaderChunk=ur,e.ShaderLib=dr,e.ShaderMaterial=Tt,e.ShaderPostPass=_n,e.ShadowMapPass=Hr,e.Skeleton=He,e.SkinnedMesh=Nn,e.Sphere=he,e.SphereGeometry=pt,e.Spherical=be,e.SpotLight=Pn,e.SpotLightShadow=An,e.StringKeyframeTrack=et,e.TEXEL_ENCODING_TYPE=A,e.TGALoader=Re,e.Texture2D=Fe,e.Texture3D=De,e.TextureBase=Ae,e.TextureCube=Ue,e.TorusKnotGeometry=ft,e.Triangle=Ee,e.VERTEX_COLOR=C,e.Vector2=J,e.Vector3=D,e.Vector4=ee,e.VectorKeyframeTrack=tt,e.WEBGL_ATTRIBUTE_TYPE=T,e.WEBGL_COMPARE_FUNC=p,e.WEBGL_OP=f,e.WEBGL_PIXEL_FORMAT=x,e.WEBGL_PIXEL_TYPE=y,e.WEBGL_TEXTURE_FILTER=_,e.WEBGL_TEXTURE_TYPE=d,e.WEBGL_TEXTURE_WRAP=v,e.WEBGL_UNIFORM_TYPE=w,e.WebGLAttribute=sr,e.WebGLCapabilities=Pt,e.WebGLCore=Ur,e.WebGLGeometry=Vt,e.WebGLProgram=cr,e.WebGLPrograms=xr,e.WebGLProperties=Ft,e.WebGLState=Ot,e.WebGLTexture=Gt,e.WebGLUniforms=ar,e.cloneUniforms=a,e.generateUUID=r,e.isPowerOfTwo=o,e.nearestPowerOfTwo=n,e.nextPowerOfTwo=h,Object.defineProperty(e,"__esModule",{value:!0})});